import{a as ve,_ as ye,c as we}from"./wk0iYt3t.js";import{_ as be}from"./BUR_EBmg.js";import{bw as xe,a as ke,l as Ce,b as Ee,j as Le,bx as Re,by as Se,cu as Te,_ as $e,f as M,E as Ue}from"./C3C96yZa.js";import{E as Ne,a as Me}from"./BT_wnIjX.js";import{_ as De}from"./Dyhoc4_b.js";import{E as Ae}from"./DSVgYJfo.js";import{u as Fe}from"./De1F1SLW.js";import{l as qe,j as ee,b as k,ak as H,r as ze,F as Be,k as Ie,M as u,N as v,Z as c,a0 as p,O as h,u as e,y as te,a7 as E,_ as J,aq as Z,a3 as I,a4 as Ve,a9 as Oe,a5 as Pe,X as je,n as oe}from"./D5LW44Rr.js";import{u as G}from"./BZbHcrLm.js";import{u as He}from"./CfIJWwds.js";import{b as Je,e as ne,c as Ze}from"./DQUFgXGm.js";import Ge from"./DAPG6cGj.js";import{E as We}from"./B8A6LEAg.js";import{_ as Xe}from"./DlAUqK2U.js";import"./BvqcBhuh.js";/* empty css        */import"./jkXhFcH6.js";import"./CgvUZmt4.js";import"./v3hwjf8i.js";import"./BYIy1x1Y.js";import"./B3O-Pehw.js";import"./DRmraN-Q.js";/* empty css        */import"./Ibp_VyKw.js";import"./-zT6HmgG.js";import"./Cpg3PDWZ.js";import"./DZCnEkJy.js";import"./B-LKCL5c.js";import"./DCTLXrZ8.js";/* empty css        */import"./Q5uV96gW.js";import"./CtujDOxJ.js";/* empty css        */import"./DwFObZc_.js";import"./WTCUdrt7.js";import"./DA296rl_.js";import"./DbnJrD-r.js";import"./DY83oLYV.js";import"./l_nRXyiX.js";import"./Bl82a0u_.js";import"./BanEqy-I.js";import"./qIf4bXs6.js";import"./D0z3eKdY.js";import"./DU1sy8XN.js";import"./DqyG3WEP.js";import"./A_tEgBSR.js";import"./DtUW6dPj.js";/* empty css        *//* empty css        */import"./CquxfLG0.js";import"./BGdOelZc.js";import"./CF0VoheG.js";function Ye(D){return $request.get({url:"/chat.skill/lists",params:D})}function Ke(D){return $request.get({url:"/chat.skill/detail",params:D})}const Qe={class:"h-full flex"},et={class:"p-[16px]"},tt={class:"flex-1 min-w-0 pr-4 py-4"},ot={class:"h-full flex flex-col bg-body rounded-[12px]"},nt={class:"flex-1 min-h-0"},at={key:0,class:"px-[40px] pt-[40px]"},rt={class:"my-[5px]"},st={key:0,class:"flex flex-col",style:{"margin-left":"52px"}},lt=["onClick"],it={class:"mr-2 text-tx-primary"},ct={class:"mb-[10px] px-[30px]"},ut={class:"mr-[10px]"},pt=qe({__name:"role",async setup(D){let d,C;const ae=xe(),{copy:re}=Fe(),se=ke(),W=Ce(),x=Ee(),y=Le(),A=ee(),V=ee(),X=k(),F=k(""),L=k(""),w=k(Number(se.query.id)),{data:q,refresh:Y}=([d,C]=H(()=>G(()=>Ye({keyword:L.value}),{default(){return[]},lazy:!0,immediate:!1},"$sJo73HUy0r")),d=await d,C(),d),{data:R,refresh:K}=([d,C]=H(()=>G(()=>Ke({id:w.value}),{lazy:!0,immediate:!1},"$FeZRwM0ASG")),d=await d,C(),d),{data:s,refresh:O}=([d,C]=H(()=>G(()=>Je({type:3,other_id:w.value,page_type:0}),{transform(o){return o.lists||[]},default(){return[]},lazy:!0},"$xhlnmU1xdY")),d=await d,C(),d),_=ze({show:!1,data:{url:"",name:"",type:"image"}}),le=o=>{_.show=!!o.support_image,_.show||(_.data.url="")},P=({id:o,image:t})=>{W.push({path:"/dialogue/role",query:{id:o}}),w.value=Number(o),oe(async()=>{await O(),R.value={image:t},await K(),B()})},ie=async()=>{if(!y.isLogin)return y.toggleShowLogin();await M.confirm("确定清空记录？"),await ne({other_id:w.value,type:3}),O()},z=k(-1),{lockFn:ce}=He(async()=>{const o=s.value[s.value.length-1],t=s.value.find(({id:l})=>l===o.id);t&&(z.value=o.id,s.value.splice(s.value.length-2,2),S(t.content))}),ue=()=>{var o;if(!y.isLogin)return(o=A.value)==null||o.blur(),y.toggleShowLogin();B()};let n=null;const b=k(!1),j=k([]),S=async(o,t="input")=>{var T;if(!y.isLogin)return y.toggleShowLogin();if(!o)return M.msgError("请输入问题");if(b.value)return;const l=Date.now();b.value=!0,s.value.push({type:1,content:o,files_plugin:[{..._.data}]}),s.value.push({type:2,typing:!0,content:[""],reasoning:"",key:l}),(T=A.value)==null||T.setInputValue();const a=s.value.find(i=>i.key===l);n=Ze({type:3,other_id:w.value,question:o,model:F.value,file:_.data.url}),n.addEventListener("reasoning",({data:i})=>{const{data:m,index:f}=i;a.reasoning||(a.reasoning=""),a.reasoning+=m}),n.addEventListener("chat",({data:i})=>{const{data:m,index:f}=i;a.content[f]||(a.content[f]=""),a.content[f]+=m}),n.addEventListener("question",({data:i})=>{j.value=JSON.parse(i.data)}),n.addEventListener("finish",({data:i})=>{const{data:m,index:f}=i;m&&(a.content[f]+=m),_.data.url=""}),n.addEventListener("close",async()=>{z.value!==-1&&a.content[0].length&&(await ne({type:1,id:z.value}),z.value=-1),await y.getUser(),b.value=!1,a.typing=!1,setTimeout(async()=>{await O(),await oe(),B()},1e3)}),n.addEventListener("error",async i=>{var m,f;if(t==="input"&&((m=A.value)==null||m.setInputValue(o)),((f=i.data)==null?void 0:f.code)===1100){x.getIsShowRecharge?(await M.confirm(`${x.getTokenUnit}数量已用完，请前往充值`),W.push("/user/recharge")):M.msgError(`${x.getTokenUnit}数量已用完。请联系客服增加`);return}i.errorType==="connectError"&&M.msgError("请求失败，请重试"),["connectError","responseError"].includes(i.errorType)&&s.value.splice(s.value.length-2,2),a.typing=!1,setTimeout(()=>{b.value=!1},200)})},B=async()=>{var t,l,a;const o=(l=(t=V.value)==null?void 0:t.wrapRef)==null?void 0:l.scrollHeight;(a=V.value)==null||a.setScrollTop(o)},{height:pe}=Re(X);Se(pe,()=>{b.value&&B()},{immediate:!0});const de=()=>{n==null||n.removeEventListener("chat"),n==null||n.removeEventListener("close"),n==null||n.removeEventListener("error"),n==null||n.removeEventListener("finish"),n==null||n.abort(),b.value=!1},me=()=>{if(!w.value)P(q.value[0].skill[0]);else for(let o=0;o<q.value.length;o++){const t=q.value[o];for(let l=0;l<t.skill.length;l++){const a=t.skill[l];if(a.id===w.value){P(a);return}}}};return Te(L,o=>{Y()},{debounce:500}),Be(async()=>{await Y(),me(),await K()}),Ie(()=>{de()}),(o,t)=>{const l=ve,a=ye,T=be,i=Ue,m=Ne,f=Me,fe=De,ge=we,he=Ae,_e=$e;return u(),v("div",null,[c(_e,{name:"default"},{default:p(()=>[h("div",Qe,[h("div",et,[c(Ge,{keyword:e(L),"onUpdate:keyword":t[0]||(t[0]=g=>te(L)?L.value=g:null),sidebarList:e(q),currentId:e(w),onOntoggle:P},null,8,["keyword","sidebarList","currentId"])]),h("div",tt,[c(he,{class:"h-full",content:e(x).getChatConfig.watermark,font:{color:e(ae)?"rgba(256,256,256,0.08)":"rgba(0,0,0,0.06)",fontSize:12}},{default:p(()=>[h("div",ot,[h("div",nt,[c(e(We),{ref_key:"scrollbarRef",ref:V},{default:p(()=>{var g;return[h("div",null,[!e(s).length&&((g=e(R))!=null&&g.tips)?(u(),v("div",at,[c(a,{type:"left",avatar:e(R).image,bg:"var(--el-bg-color-page)"},{default:p(()=>{var r;return[c(l,{content:(r=e(R))==null?void 0:r.tips,type:"html",typing:!1,"line-numbers":!e(x).isMobile,"show-collect-btn":!1,"show-copy-btn":!1,"show-poster":!1,"show-voice":!1,class:"mb-[15px] last-of-type:mb-0",onClickCustomLink:t[1]||(t[1]=$=>S($,"link"))},null,8,["content","line-numbers"])]}),_:1},8,["avatar"])])):E("",!0),e(s).length?(u(),v("div",{key:1,ref_key:"innerRef",ref:X,class:"px-8"},[(u(!0),v(J,null,Z(e(s),(r,$)=>{var Q;return u(),v("div",{key:r.id+""+$,class:"mt-4 sm:pb-[20px]"},[r.type==1?(u(),I(a,{key:0,type:"right",avatar:e(y).userInfo.avatar,color:"white"},{actions:p(()=>[h("div",rt,[c(i,{link:"",type:"info",onClick:U=>e(re)(r.content)},{icon:p(()=>[c(T,{name:"el-icon-CopyDocument"})]),default:p(()=>[t[6]||(t[6]=Ve(" 复制 "))]),_:2},1032,["onClick"])])]),default:p(()=>[c(l,{content:r.content,"files-plugin":r.files_plugin},null,8,["content","files-plugin"])]),_:2},1032,["avatar"])):E("",!0),r.type==2?(u(),I(a,{key:1,type:"left",avatar:(Q=e(R))==null?void 0:Q.image,time:r.create_time,bg:"var(--el-bg-color-page)",modelName:r.model},{outer_actions:p(()=>[$===e(s).length-1&&!e(b)?(u(),v("div",st,[(u(!0),v(J,null,Z(e(j).length?e(j):r.correlation,(U,N)=>(u(),v("div",{key:N,class:"inline-flex items-center rounded-[12px] bg-page cursor-pointer mt-[10px] hover:bg-primary-light-9",style:{padding:"8px 12px",width:"fit-content"},onClick:Oe(dt=>S(U,"input"),["stop"])},[h("span",it,Pe(U),1),c(T,{name:"el-icon-Right",color:"#999",size:"20"})],8,lt))),128))])):E("",!0)]),default:p(()=>[r.reasoning?(u(),I(f,{key:0,"model-value":"the-chat-msg-collapse",class:"mb-2 the-chat-msg-collapse"},{default:p(()=>[c(m,{title:"深度思考",name:"the-chat-msg-collapse"},{default:p(()=>[c(l,{content:r.reasoning,class:"text-tx-secondary px-3 border-l-[3px] border-br-light"},null,8,["content"])]),_:2},1024)]),_:2},1024)):E("",!0),(u(!0),v(J,null,Z(r.content,(U,N)=>(u(),I(l,{key:N,content:U,type:"html",typing:r.typing,"line-numbers":!e(x).isMobile,"show-rewrite":$===e(s).length-1,"show-copy":"","show-voice":e(x).getIsVoiceOpen,class:je(["mb-[15px] last-of-type:mb-0",{"pt-[15px] border-t border-solid border-br-light":N>0}]),index:N,"record-id":r.id,"show-poster":"","record-list":e(s),onRewrite:e(ce)},null,8,["content","typing","line-numbers","show-rewrite","show-voice","class","index","record-id","record-list","onRewrite"]))),128))]),_:2},1032,["avatar","time","modelName"])):E("",!0)])}),128))],512)):E("",!0)])]}),_:1},512)]),h("div",ct,[c(ge,{ref_key:"chatActionRef",ref:A,loading:e(b),"show-continue":e(s).length,"show-file-upload":e(_).show,"file-plugin":e(_).data,"onUpdate:filePlugin":t[3]||(t[3]=g=>e(_).data=g),onEnter:S,onClear:ie,onPause:t[4]||(t[4]=g=>{var r;return(r=e(n))==null?void 0:r.abort()}),onFocus:ue,onContinue:t[5]||(t[5]=g=>S("继续","btn"))},{btn:p(()=>[h("div",ut,[c(fe,{class:"min-w-[280px] select-class",sub_id:e(F),"onUpdate:sub_id":t[2]||(t[2]=g=>te(F)?F.value=g:null),"onUpdate:modelConfig":le},null,8,["sub_id","onUpdate:modelConfig"])])]),_:1},8,["loading","show-continue","show-file-upload","file-plugin"])])])]),_:1},8,["content","font"])])])]),_:1})])}}}),po=Xe(pt,[["__scopeId","data-v-ead26b66"]]);export{po as default};
