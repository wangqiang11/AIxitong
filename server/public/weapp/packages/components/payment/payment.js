"use strict";const e=require("../../../common/vendor.js"),u=require("../../../utils/pay/index.js"),r=require("../../../api/pay.js"),o=require("../../../hooks/useLockFn.js"),t=require("../../../enums/appEnums.js"),s=require("../../../stores/user.js"),a=require("../../../utils/client.js");if(require("../../../utils/pay/alipay.js"),require("../../../utils/pay/balance.js"),require("../../../utils/pay/pay.js"),require("../../../utils/pay/wechat.js"),require("../../../utils/pay/e_wechat.js"),require("../../../utils/pay/e_alipay.js"),require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),!Array){(e.resolveComponent("u-empty")+e.resolveComponent("u-icon")+e.resolveComponent("u-radio")+e.resolveComponent("u-radio-group")+e.resolveComponent("price")+e.resolveComponent("u-button")+e.resolveComponent("page-status")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-empty/u-empty.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-radio/u-radio.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-radio-group/u-radio-group.js")+(()=>"../../../components/price/price.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../components/page-status/page-status.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+i)();const i=()=>"./check.js",n=e.defineComponent({__name:"payment",props:{show:{type:Boolean,required:!0},showCheck:{type:Boolean},orderId:{type:Number,required:!0},from:{type:String,required:!0},redirect:{type:String},orderAmount:{type:Number},safeArea:{type:Boolean,required:!0}},emits:["update:showCheck","update:show","close","success","fail"],setup(i,{emit:n}){const l=i;e.useRouter();const c=e.ref(),p=e.ref(t.PageStatusEnum.LOADING),m=e.ref({lists:[]}),d=e.computed({get:()=>l.showCheck,set(e){n("update:showCheck",e)}}),y=e.computed({get:()=>l.show,set(e){n("update:show",e)}}),v=()=>{y.value=!1,n("close")},f=s.useUserStore(),{isLock:h,lockFn:j}=o.useLockFn((async()=>{try{const o=await(async()=>{if(0==f.userInfo.is_auth&&[t.ClientEnum.OA_WEIXIN,t.ClientEnum.MP_WEIXIN].includes(a.client)&&c.value==u.PayWayEnum.WECHAT)switch(a.client){case t.ClientEnum.OA_WEIXIN:return wechatOa.getUrl(UrlScene.BASE,"snsapi_base",{id:l.orderId,from:l.from}),Promise.reject();case t.ClientEnum.MP_WEIXIN:return(await e.index.login()).code}})(),s=await(async o=>{try{e.index.showLoading({title:"正在支付中"});const t=await r.prepay({device:a.getClientString(),order_id:l.orderId,from:l.from,pay_way:c.value,redirect:l.redirect,code:o});return await u.pay.payment(t.pay_way,(null==t?void 0:t.config)||(null==t?void 0:t.payurl)||(null==t?void 0:t.qrcode))}catch(t){return Promise.reject(t)}})(o);w(s),e.index.hideLoading()}catch(o){setTimeout((()=>{e.index.hideLoading()}),1e3),console.log(o)}})),w=e=>{switch(e){case t.PayStatusEnum.SUCCESS:n("success");break;case t.PayStatusEnum.FAIL:n("fail")}},q=()=>{w(t.PayStatusEnum.SUCCESS)},g=()=>{y.value=!0,w(t.PayStatusEnum.FAIL)};return e.watch((()=>l.show),(async e=>{if(e){if(!l.orderId)return void(p.value=t.PageStatusEnum.ERROR);await(async()=>{p.value=t.PageStatusEnum.LOADING;try{m.value=await r.getPayWay({order_id:l.orderId,from:l.from}),p.value=t.PageStatusEnum.NORMAL;const e=m.value.lists.find((e=>e.is_default))||m.value.lists[0];c.value=null==e?void 0:e.pay_way}catch(e){p.value=t.PageStatusEnum.ERROR}})()}}),{immediate:!0}),e.onMounted((async()=>{})),(u,r)=>e.e({a:e.p({text:"订单信息错误，无法查询到订单信息",mode:"order"}),b:e.f(m.value.lists,((u,r,o)=>({a:"c6b7507a-4-"+o+",c6b7507a-3",b:e.p({size:48,name:u.icon}),c:e.t(u.name),d:e.t(u.extra),e:"c6b7507a-5-"+o+",c6b7507a-3",f:e.p({name:u.pay_way}),g:r,h:e.o((e=>{return r=u.pay_way,void(c.value=r);var r}),r)}))),c:e.o((e=>c.value=e)),d:e.p({"active-color":u.$theme.primaryColor,modelValue:c.value}),e:i.orderAmount},i.orderAmount?{f:e.p({content:i.orderAmount,mainSize:"34rpx",minorSize:"34rpx",fontWeight:"500",color:"var(--color-btn-text)"})}:{},{g:e.o(e.unref(j)),h:e.p({shape:"circle",type:"primary",loading:e.unref(h)}),i:e.p({status:p.value,fixed:!1}),j:e.o(v),k:e.o((u=>e.isRef(y)?y.value=u:null)),l:e.p({mode:"bottom","safe-area-inset-bottom":i.safeArea,"mask-close-able":!1,"border-radius":"14",closeable:!0,"z-index":899,modelValue:e.unref(y)}),m:e.o(q),n:e.o(g),o:e.o((u=>e.isRef(d)?d.value=u:null)),p:e.p({from:i.from,"order-id":i.orderId,show:e.unref(d)})})}});wx.createComponent(n);
