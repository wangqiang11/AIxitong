"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),r=require("../../../api/chat.js"),a=require("../../../api/create.js"),i=require("../../../utils/date.js"),o=require("../../../hooks/useCopy.js"),s=require("../../../utils/util.js"),u=require("../../../hooks/useLockFn.js"),n=require("../../../utils/validate.js"),l=require("../../../enums/constantEnums.js"),c=require("../../../stores/user.js"),p=require("../../../stores/app.js"),v=require("../../../enums/chatEnums.js"),d=require("../../../hooks/useShareMessage.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../stores/navigationBarTitle.js"),require("../../../mixins/share.js"),require("../../../api/task_reward.js"),!Array){(e.resolveComponent("u-image")+e.resolveComponent("model-picker")+e.resolveComponent("u-icon")+e.resolveComponent("u-button"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-image/u-image.js")+h+m+(()=>"../../../components/model-picker/model-picker.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js"))();const m=()=>"../../components/creation-history-item/creation-history-item.js",h=()=>"../../components/form-designer/form-designer.js",f=e.defineComponent({__name:"create",setup(m){const{useShare:h,resolveOptions:f,removeMixinShare:g}=d.useShareMessage(),q=c.useUserStore(),y=e.ref(""),j=[{name:"WidgetTextarea",title:"多行文本",props:{field:"question",title:"内容描述",placeholder:"",rows:8,maxlength:400,autosize:!1,isRequired:!1}}],w=p.useAppStore(),{copy:x}=o.useCopy(),k=e.reactive({id:0,type:1,token:""}),_=e.shallowRef();e.shallowRef();const T=e.ref([]),$=e.ref({}),b=e.ref({}),C=e.ref([]),S=e.ref(!1),D=()=>{var e;const t=(null==(e=b.value)?void 0:e.form[0])||{};return`${t.props.title}：${$.value[t.props.field]||""}`};let M=Date.now();const E=async()=>{var t;try{await(null==(t=_.value)?void 0:t.validate())}catch(a){return console.log(a),void e.index.$u.toast("必填项不能为空")}if(q.userInfo.is_chat_limit&&n.isNewDay(!0,l.CHAT_LIMIT_KEY)){if((await e.index.showModal({title:"对话上限提示",content:"已超过会员对话上限次数，继续对话将会消耗账户的对话余额",confirmText:"继续",cancelText:"关闭"})).cancel)return}S.value=!0,M=Date.now();try{await r.chatSendText({model:y.value,other_id:k.id,question:$.value,creation_type:v.CreationEnum.Normal,type:2},{onstart(e){T.value.length&&(T.value=[])},onmessage(t){t.trim().split("data:").forEach((async t=>{var r,o,s;if(""!==t)try{const a=JSON.parse(t),{object:u,choices:n,error:l}=a;if(l){const{message:t,code:r}=l;if(1100===r)if(w.getIsShowRecharge){const{cancel:t}=await e.index.showModal({title:"温馨提示",content:`${w.getTokenUnit}数量已用完，请前往充值`});if(t)return;U.navigateTo({path:"/packages/pages/recharge/recharge"})}else e.index.$u.toast(`${w.getTokenUnit}数量已用完。请联系客服增加`);else t&&e.index.$u.toast(t);return}let c=T.value.findIndex((e=>e.id===M));const p=null==(r=n[0])?void 0:r.index,v=null==(s=null==(o=n[0])?void 0:o.delta)?void 0:s.content;if("chat"!==u&&"reasoning"!==u||(-1===c&&(T.value.push({create_time:i.timeFormat(new Date,"yyyy-mm-dd hh:MM:ss"),title:$.value.question?$.value.question:D(),reply:[],extra:e.cloneDeep($.value),id:M}),c=T.value.length-1),v&&(T.value[c].reply[p]||(T.value[c].reply[p]=""),T.value[c].reply[p]+=v)),"finish"===u)return T.value[c].reply[p]+=v,void R()}catch(a){}}))},onclose(){setTimeout((()=>{S.value=!1}),500)}})}catch(a){S.value=!1}},I=()=>{var e,t;null==(t=null==(e=b.value)?void 0:e.form)||t.forEach((e=>{e.props.placeholder&&!e.props.defaultValue&&($.value[e.props.field]=e.props.placeholder)}))},R=()=>{var t;null==(t=b.value)||t.form.forEach((t=>{t.props.defaultValue?$.value[t.props.field]=e.cloneDeep(t.props.defaultValue):$.value[t.props.field]=void 0}))},U=e.useRouter(),{lockFn:L}=u.useLockFn((async t=>{t&&(e.index.pageScrollTo({scrollTop:0,duration:0}),$.value=t,await e.nextTick$1(),E())})),N=()=>U.navigateTo({path:"/packages/pages/create_history/create_history",query:{id:k.id}});let A=null,F=0;const V=()=>{A&&clearInterval(A),A=setInterval((async()=>{var t;const r=await s.getRect(".current-history",!1,null==(t=e.getCurrentInstance())?void 0:t.proxy);r.height>F&&e.index.pageScrollTo({selector:"#bottom-line",duration:0}),F=r.height}),500)},B=()=>{A&&setTimeout((()=>{clearInterval(A)}),2e3)};return e.watch(S,(()=>{S.value?V():B()})),e.onUnmounted((()=>{B()})),e.onLoad((async t=>{k.id=Number(null==t?void 0:t.id),k.type=Number(null==t?void 0:t.type),await(async()=>{const t=await a.getCreationDetail({id:k.id});b.value=t,b.value.form||(b.value.form=j),h({title:t.name,desc:t.tips,imageUrl:t.image}),C.value=e.cloneDeep(b.value.form),R()})(),e.index.$on("createRewrite",(e=>{console.log(e),L(e)}))})),e.onUnload((()=>{e.index.$off("createRewrite")})),g(),e.onShareAppMessage((async()=>await f({title:b.value.name,imageUrl:b.value.image}))),(r,a)=>e.e({a:r.$theme.navColor,b:r.$theme.navBgColor,c:r.$theme.pageStyle,d:b.value.name},b.value.name?e.e({e:e.p({src:b.value.image,width:"84",height:"84"}),f:e.t(b.value.name),g:b.value.tips},b.value.tips?{h:e.t(b.value.tips)}:{},{i:e.sr(_,"3775a096-1",{k:"formDesignerRef"}),j:e.o((e=>$.value=e)),k:e.p({formLists:C.value,modelValue:$.value}),l:e.o(I),m:e.o(N),n:e.f(T.value,((t,r,a)=>({a:e.f(t.reply,((r,i,o)=>({a:e.o(e.unref(x),i),b:e.o((r=>e.unref(L)(t.extra)),i),c:"3775a096-2-"+a+"-"+o,d:e.p({title:t.title,time:t.create_time,content:r,showDelete:!1,"show-rewrite":!S.value}),e:i}))),b:t.id}))),o:!T.value.length},T.value.length?{}:{p:t._imports_0$2},{q:e.o((e=>y.value=e)),r:e.p({sub_id:y.value}),s:e.p({name:"trash"}),t:e.o(R),v:e.p({hairLine:!1,"custom-style":{width:"100%",border:"none",background:"#f5f5f5"}}),w:e.o(E),x:e.p({type:"primary",loading:S.value,"custom-style":{width:"100%"}})}):{})}});f.__runtimeHooks=2,wx.createPage(f);
