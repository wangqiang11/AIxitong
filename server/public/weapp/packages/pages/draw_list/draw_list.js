"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/draw.js"),i=require("../../../utils/client.js"),o=require("../../../hooks/useCopy.js"),t=require("../../../utils/download.js"),s=require("../../../stores/app.js"),n=require("./hooks/useImageSplit.js"),l=require("../../../common/assets.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../stores/user.js"),require("../../../api/user.js"),require("../../../enums/constantEnums.js"),require("../../../utils/auth.js"),require("../../../utils/cache.js"),require("../../../utils/unique-id.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../enums/appEnums.js"),require("../../../api/app.js"),require("../../../api/shop.js"),!Array){(e.resolveComponent("u-loading")+e.resolveComponent("u-tag")+e.resolveComponent("u-image")+e.resolveComponent("u-icon")+e.resolveComponent("z-paging")+e.resolveComponent("u-button")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-loading/u-loading.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-tag/u-tag.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-image/u-image.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+u)();const u=()=>"./_components/draw-share.js",r=e.defineComponent({__name:"draw_list",setup(u){const r={1:"文生图",2:"图生图",3:"选中放大",4:"选中变换"},d=e.useRoute(),p=e.useRouter(),c=e.shallowRef(),m=s.useAppStore(),{copy:g}=o.useCopy(),v=e.ref([]),_={0:{label:"生成中",type:"warning"},1:{label:"生成中",type:"warning"},2:{label:"生成失败",type:"error"},3:{label:"生成成功",type:"success"}},w=[{name:"全部",type:-1},{name:"生成中",type:1},{name:"生成成功",type:3},{name:"生成失败",type:2}],b=e.ref(!1),f=e.shallowRef(null),h=e.ref([]),y=e.ref(""),j=e.ref(-1),q=e.reactive({show:!1,item:{}}),x=async(a,i)=>{const o={image:a.image,prompts:a.prompt,records_id:a.id};if(i&&(o.is_base64=1,o.base64=i),h.value.includes(a.id)||a.is_share){if((await e.index.showModal({title:"温馨提示",content:"该图片已分享过，是否确认重复分享？"})).cancel)return}b.value=!0,await e.nextTick$1(),setTimeout((()=>f.value.open(o)),50)},{images:k,splitImage:C}=n.useImageSplit(),z=(a,i)=>{e.index.previewImage({urls:a,current:i})},I=async(a,i)=>{const o={action:i,draw_model:a.engine,image_mask:a.image_base,negative_prompt:a.negative_prompt,prompt:a.prompt,size:a.scale,origin_task_id:a.task_id,complex_params:JSON.parse(a.complex_params)};a.image_base&&(o.draw_type="img2img");getCurrentPages().length>1?(await p.navigateBack(),e.index.$emit("drawRegenerate",o)):await p.redirectTo({path:"/packages/pages/draw/mj",query:{data:JSON.stringify(o)}})},R=async()=>{await g(q.item.image),q.show=!1},S=e.shallowRef(),T=async(e,i)=>{try{const{lists:o}=await a.drawingRecord({model:y.value,page_no:e,page_size:i,status:j.value});c.value.complete(o)}catch(o){c.value.complete(!1)}finally{setTimeout((()=>{clearTimeout(S.value),[-1,1].includes(j.value)&&v.value.some((e=>1===e.status))&&(S.value=setTimeout((()=>{A()}),6e3))}),100)}},A=()=>{var e;null==(e=c.value)||e.refresh()};return e.watch(j,(()=>{A()})),e.onUnmounted((()=>{clearTimeout(S.value)})),e.onLoad((()=>{const e=d.query.model;e&&(y.value=e)})),(o,s)=>({a:o.$theme.navColor,b:o.$theme.navBgColor,c:o.$theme.pageStyle,d:e.f(w,((a,i,o)=>({a:e.t(a.name),b:a.type===j.value?1:"",c:e.o((e=>j.value=a.type),a.type),d:a.type}))),e:e.f(v.value,((s,n,u)=>{var d,c,v,w,b,f,h,y,j,R,S,T,$,E;return e.e({a:1===s.status},1===s.status?{b:"5b45d43a-1-"+u+",5b45d43a-0",c:e.p({mode:"flower",size:"80"})}:{},{d:2===s.status||3===s.status},2===s.status||3===s.status?e.e({e:"5b45d43a-2-"+u+",5b45d43a-0",f:e.p({text:_[s.status].label,"border-color":"transparent",type:_[s.status].type}),g:3===s.status},3===s.status?e.e({h:e.unref(l._imports_1$2),i:e.o((a=>e.unref(g)(s.prompt)),s.id),j:e.unref(l.IconDownload),k:e.o((e=>(e=>{i.isWeixinClient()?(q.show=!0,q.item=e):t.downloadFile(e.image,"图片","image")})(s)),s.id),l:e.unref(m).getSquareConfig.draw_award.is_open},e.unref(m).getSquareConfig.draw_award.is_open?{m:e.unref(l.IconShare),n:e.o((e=>x(s)),s.id)}:{},{o:"mj"===s.engine&&(null==s?void 0:s.able_cut)},"mj"===s.engine&&(null==s?void 0:s.able_cut)?{p:e.unref(l.IconCutout),q:e.o((a=>(async a=>{if(!Array.isArray(a.image)){e.index.showLoading({title:"图片拆分中..."});try{await C(a.image),console.log(k.value),a.image=k.value}finally{e.index.hideLoading()}}})(s)),s.id)}:{}):{},{r:e.unref(l.IconReload),s:e.o((a=>(async a=>{const i={draw_model:a.engine,image_mask:a.image_base,negative_prompt:a.negative_prompt,prompt:a.prompt,size:a.scale,draw_loras:a.loras};a.image_base&&(i.draw_type="img2img"),getCurrentPages().length>1?(await p.navigateBack(),e.index.$emit("drawRegenerate",i)):await p.redirectTo({path:"/packages/pages/draw/mj",query:{data:JSON.stringify(i)}})})(s)),s.id),t:e.unref(l.IconDelete),v:e.o((i=>(async i=>{const{cancel:o}=await e.index.showModal({title:"温馨提示",content:"确定删除？"});o||(await a.drawingDelete({ids:[i]}),A())})(s.id)),s.id),w:2===s.status},2===s.status?e.e({x:e.unref(l.ImageError),y:s.fail_reason},s.fail_reason?{z:e.t(s.fail_reason)}:{}):3===s.status?e.e({B:!Array.isArray(s.image)},Array.isArray(s.image)?{H:e.f(s.image,((a,i,o)=>({a:e.o((e=>z(s.image,i)),i),b:"5b45d43a-5-"+u+"-"+o+",5b45d43a-0",c:e.p({width:"280",mode:"widthFix",src:a}),d:"5b45d43a-6-"+u+"-"+o+",5b45d43a-0",e:e.o((e=>x(s,a)),i),f:i}))),I:e.p({name:"share",color:"#ffffff",size:"34"})}:{C:"5b45d43a-4-"+u+",5b45d43a-3-"+u,D:e.p({mode:"circle",color:o.$theme.primaryColor,size:"40"}),E:e.o((e=>z([s.image],0)),s.id),F:"5b45d43a-3-"+u+",5b45d43a-0",G:e.p({src:s.thumbnail||s.image,width:"640rpx",height:"640rpx",mode:"aspectFit","border-radius":"0"})},{J:e.o((()=>{}),s.id)}):{},{A:3===s.status,K:e.t(s.prompt),L:3===s.status&&"mj"==s.engine},3===s.status&&"mj"==s.engine?e.e({M:!(null==(d=null==s?void 0:s.able_actions)?void 0:d.includes("low_variation"))&&(null==(c=null==s?void 0:s.able_actions)?void 0:c.length)},!(null==(v=null==s?void 0:s.able_actions)?void 0:v.includes("low_variation"))&&(null==(w=null==s?void 0:s.able_actions)?void 0:w.length)?{N:e.o((e=>I(s,"upscale1")),s.id),O:e.o((e=>I(s,"upscale2")),s.id),P:e.o((e=>I(s,"upscale3")),s.id),Q:e.o((e=>I(s,"upscale4")),s.id),R:e.o((e=>I(s,"variation1")),s.id),S:e.o((e=>I(s,"variation2")),s.id),T:e.o((e=>I(s,"variation3")),s.id),U:e.o((e=>I(s,"variation4")),s.id)}:(null==(b=null==s?void 0:s.able_actions)?void 0:b.length)?e.e({W:e.o((e=>I(s,"high_variation")),s.id),X:e.o((e=>I(s,"low_variation")),s.id),Y:null==(f=null==s?void 0:s.able_actions)?void 0:f.includes("outpaint_1.5x")},(null==(h=null==s?void 0:s.able_actions)?void 0:h.includes("outpaint_1.5x"))?{Z:e.o((e=>I(s,"outpaint_1.5x")),s.id),aa:e.o((e=>I(s,"outpaint_2x")),s.id)}:{},{ab:null==(y=null==s?void 0:s.able_actions)?void 0:y.includes("upscale_2x")},(null==(j=null==s?void 0:s.able_actions)?void 0:j.includes("upscale_2x"))?{ac:e.o((e=>I(s,"upscale_2x")),s.id),ad:e.o((e=>I(s,"upscale_4x")),s.id)}:{},{ae:null==(R=null==s?void 0:s.able_actions)?void 0:R.includes("upscale_subtle")},(null==(S=null==s?void 0:s.able_actions)?void 0:S.includes("upscale_subtle"))?{af:e.o((e=>I(s,"upscale_subtle")),s.id),ag:e.o((e=>I(s,"upscale_creative")),s.id)}:{},{ah:null==(T=null==s?void 0:s.able_actions)?void 0:T.includes("pan_left")},(null==($=null==s?void 0:s.able_actions)?void 0:$.includes("pan_left"))?{ai:e.o((e=>I(s,"pan_left")),s.id),aj:e.o((e=>I(s,"pan_right")),s.id),ak:e.o((e=>I(s,"pan_up")),s.id),al:e.o((e=>I(s,"pan_down")),s.id)}:{}):{},{V:null==(E=null==s?void 0:s.able_actions)?void 0:E.length}):{},{am:e.t(s.create_time),an:"5b45d43a-7-"+u+",5b45d43a-0",ao:e.p({text:r[s.type],size:"mini","border-color":"transparent"}),ap:e.o((e=>(e=>{2!==e.status&&p.navigateTo({path:"/packages/pages/draw_detail/draw_detail",query:{id:e.id}})})(s)),s.id)}):{},{aq:s.id})})),f:e.sr(c,"5b45d43a-0",{k:"pagingRef"}),g:e.o(T),h:e.o((e=>v.value=e)),i:e.p({"auto-clean-list-when-reload":!1,"safe-area-inset-bottom":!0,fixed:!0,modelValue:v.value}),j:e.o(R),k:e.p({type:"primary",shape:"circle"}),l:e.o((e=>q.show=e)),m:e.p({mode:"center","border-radius":"15",closeable:!0,modelValue:q.show}),n:e.sr(f,"5b45d43a-10",{k:"shareRef"}),o:b.value,p:e.o((e=>b.value=!1)),q:e.o((e=>h.value.push(e)))})}}),d=e._export_sfc(r,[["__scopeId","data-v-5b45d43a"]]);wx.createPage(d);
