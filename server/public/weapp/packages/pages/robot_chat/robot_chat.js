"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/robot.js"),o=require("../../../hooks/useLockFn.js"),t=require("../../../stores/user.js"),n=require("../../../stores/app.js"),u=require("../../../enums/requestEnums.js"),l=require("./useSessionList.js"),i=require("../../../hooks/useAudioPlay.js"),s=require("../../../hooks/useRecorder.js"),r=require("../../../hooks/useAudio.js"),c=require("../../../components/chat-input/use-files-manage.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../lib/fft.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("router-navigate")+e.resolveComponent("chat-record-item")+e.resolveComponent("u-tag")+e.resolveComponent("uni-icons")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark")+e.resolveComponent("l-textarea")+e.resolveComponent("u-button")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../node-modules/uniapp-router-next/components/router-navigate/router-navigate.js")+p+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-tag/u-tag.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/chat-input/chat-input.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js")+d+m+f+(()=>"../../../components/l-textarea/l-textarea.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+v)();const v=()=>"../../components/dialog-poster/dialog-poster.js",d=()=>"../../components/session/popup.js",p=()=>"../../components/session/index.js",m=()=>"../../../components/chat-record-item/quote-popup.js",f=()=>"../../../components/chat-record-item/context-popup.js",h=e.defineComponent({__name:"robot_chat",setup(v){const d=n.useAppStore(),p=e.useRouter(),m=e.useRoute(),f=t.useUserStore();e.shallowRef();const h=e.ref(!1),g=e.ref([]),w=e.computed((()=>m.query.id)),{getSessionLists:y,sessionActive:_,sessionAdd:j,sessionEdit:q,sessionLists:b,sessionDelete:k,sessionClear:x,currentSession:C}=l.useSessionList(w.value),R=e.ref(1),T=e.computed((()=>2===R.value)),{pauseAll:$}=i.useAudioPlay(),A=c.useFilesManage(),z=e.ref(0),S=e.reactive({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."}),L=e=>{2===R.value&&(z.value=e)},F=e.ref(!1),P=e.ref(0),D=e.ref(!1),B=e.ref(0),E=e.ref(0),V=e.ref(!0),M=e.reactive({id:"audio-canvas",width:100,height:30,minHeight:5,scale:2}),O=e.shallowRef(),{render:J,stopRender:N,draw:U}=s.useRenderAudioGraph(M),{start:G,stop:I,isRecording:H,authorize:K,close:Q}=s.useRecorder({onstart(){D.value=!1,P.value=Date.now()},async onstop(e){if(N(),setTimeout((()=>{U(new Float64Array(new Array(128).fill(0)),0)}),10),F.value){F.value=!1,L(3);try{const o=await a.voiceTransfer(e.tempFilePath);if(!o.text)return void(V.value&&L(2));xe(o.text,"voice")}catch(o){V.value&&L(1)}}},ondata(e){J(e);const a=Date.now();e.powerLevel>15&&(clearTimeout(B.value),z.value=2,D.value=!0,P.value=a,B.value=setTimeout((()=>{F.value=!0,clearTimeout(E.value),I()}),2e3)),a-P.value>=5e3&&D.value}}),{play:W,pause:X,isPlaying:Y}=r.useAudio({onstart(){z.value=4,oe.value&&(oe.value=!1,I())},onstop(){var e;E.value=setTimeout((()=>{te()}),1e3*(null==(e=ie.value.digital)?void 0:e.idle_time)||0),V.value?L(2):L(1)},onerror(){L(1)}}),Z=async e=>{const{url:o}=await a.voiceGenerate(e);return o},ee=async()=>{[4,3].includes(z.value)||(H.value?(V.value=!1,I(),L(1)):(V.value=!0,L(2)))},ae=e.ref(""),oe=e.ref(!1),te=async()=>{if(2!==R.value)return Promise.reject();if(!ie.value.is_digital||!ie.value.digital_id||ie.value.is_disable)return Promise.reject();if(ae.value||(ae.value=await Z({type:3,record_id:ie.value.id})),!ae.value)return Promise.reject();oe.value=!0;const a=Date.now();g.value.push({type:2,typing:!1,content:ie.value.digital.idle_reply,key:a}),await e.nextTick$1(),we(),W(ae.value)};e.watch(R,(async e=>{if(1===e)X(),Q(),z.value=0,clearTimeout(E.value);else{V.value=!0,await K(),U(null,0);try{await te()}catch(a){L(2)}we()}})),e.watch(z,(e=>{if(2===e)(async()=>{H.value||2!==R.value||G()})()}));const ne=e.reactive({show:!1,data:[]}),ue=e.reactive({show:!1,data:[]}),le=e.ref(!1),ie=e.ref({}),se=e.ref(""),re=e.ref(""),ce=()=>{if(!f.isLogin)return $e();we()},ve=e.shallowRef();let de=0;const pe=async(e,o)=>{var t,n;try{const{lists:n=[],count:u}=await a.getRobotChatRecord({category_id:_.value,robot_id:w.value,page_size:o/2,page_no:e});if(null==(t=ve.value)||t.complete(n.reverse()),0===u?setTimeout((()=>{var e;null==(e=ve.value)||e.scrollToTop(!1)}),200):1===o&&setTimeout((()=>{we()}),100),2===R.value&&3==z.value){const e=n[0];e&&e.id!==de&&(de=e.id,(async e=>{try{const a=await Z({type:2,record_id:e});W(a)}catch(a){L(1)}})(de))}}catch(u){null==(n=ve.value)||n.complete(!1)}},me=e.ref(!1),fe=e=>{console.log(e),e.height>0?me.value=!0:me.value=!1},he=()=>{me.value=!1};e.watch(_,(e=>{console.log(e),setTimeout((()=>{var a,o;e?null==(a=ve.value)||a.reload():(null==(o=ve.value)||o.complete([]),setTimeout((()=>{var e;null==(e=ve.value)||e.scrollToTop(!1)}),100))}),10)}),{immediate:!0});const{lockFn:ge}=o.useLockFn((async()=>{var o;if(!f.isLogin)return $e();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(qe(),await a.clearRobotChatRecord({robot_id:w.value,category_id:_.value}),null==(o=ve.value)||o.reload())})),we=async()=>{var e;null==(e=ve.value)||e.scrollToBottom(!1)},ye=e.ref(!1);let _e=null;const je=e.ref([]),qe=()=>{null==_e||_e.abort(),setTimeout((()=>{se.value=""}))},be=e.ref({}),{pauseAll:ke}=i.useAudioPlay(),{lockFn:xe}=o.useLockFn((async(o,t="text")=>{if(h.value=!1,!f.isLogin)return $e();if(ye.value)return;const n=o||se.value;if(!n)return;0===_.value&&await j(),"新的会话"===C.value&&await q({id:_.value,name:n});const l=A.files.value.map((e=>({name:e.name,type:"30",url:e.url})));ve.value.addChatRecordData({type:1,content:n,files_plugin:l}),be.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},ve.value.addChatRecordData(be.value),re.value=se.value,se.value="";try{ye.value=!0,L(3),await a.robotChat({cate_id:_.value,robot_id:w.value,question:n,stream:!0,annex:[],files:A.files.value.map((e=>({...e,type:"30"})))},{onstart(e){_e=e,ke(),se.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var o,t,n,u;if(""!==a)try{const i=JSON.parse(a),{object:s,choices:r,error:c}=i;if(c){const{message:a,code:o}=c;return a&&e.index.$u.toast(a),void g.value.splice(0,2)}const v=null==(t=null==(o=r[0])?void 0:o.delta)?void 0:t.content;switch(s){case"chat":be.value.content||(be.value.content=""),be.value.content+=v;break;case"reasoning":be.value.content||(be.value.content=""),be.value.reasoning+=v;break;case"question":je.value=JSON.parse(null==(u=null==(n=r[0])?void 0:n.delta)?void 0:u.content);break;case"image":case"video":case"file":{const e=`${s}s`;try{const a=JSON.parse(v);be.value[e]=a}catch(l){console.error(l)}}}}catch(i){}}))},onclose(){ye.value=!1,f.getUser(),setTimeout((()=>{var e;null==(e=ve.value)||e.reload()}),1e3)}})}catch(i){console.log("发送消息失败=>",i),i.errMsg!==u.RequestErrMsgEnum.ABORT&&g.value.splice(0,2),"text"==t&&(se.value=re.value),ye.value=!1}})),Ce=e.ref(!1),Re=e.reactive({_index:-1,robot_id:w.value,record_id:-1,content:""}),Te=async()=>{try{await a.chatFeedBack(Re),Ce.value=!1,Re.content="",g.value[Re._index].is_feedback=1}catch(e){console.log("反馈提交失败--\x3e",e)}},$e=()=>{p.navigateTo({path:"/pages/login/login"})};return e.onShow((async()=>{y(),(async()=>{ie.value=await a.getRobotDetail({id:w.value})})()})),e.onUnmounted((()=>{qe()})),(a,o)=>{var t,n;return e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:e.p({title:ie.value.name,"title-color":"#333","title-bold":!0}),e:ie.value.is_digital},ie.value.is_digital?{f:e.p({name:"arrow-rightward"}),g:e.o(e.unref($)),h:e.p({to:{path:"/packages/pages/digital_chat/digital_chat",query:{id:e.unref(w),cateId:e.unref(_)}}})}:{},{i:e.o((e=>le.value=e)),j:e.p({name:e.unref(C),modelValue:le.value}),k:e.unref(T)},e.unref(T)?{l:!e.unref(Y),m:null==(t=ie.value.digital)?void 0:t.vertical_stay_video,n:e.unref(Y),o:null==(n=ie.value.digital)?void 0:n.vertical_talk_video}:{},{p:e.f(g.value,((a,o,t)=>{var n,u,l,i,s,r;return e.e({a:1==a.type},1==a.type?{b:e.unref(T)?1:"",c:"24d248d6-6-"+t+",24d248d6-5",d:e.p({type:"right",content:a.content,avatar:e.unref(f).userInfo.avatar,"files-plugin":a.files_plugin,showCopyBtn:!0})}:{},{e:2==a.type},2==a.type?e.e({f:!!ie.value.is_show_quote&&(null==(n=a.quotes)?void 0:n.length)},ie.value.is_show_quote&&(null==(u=a.quotes)?void 0:u.length)?{g:e.t(null==(l=a.quotes)?void 0:l.length),h:e.o((e=>{return o=a.quotes,ue.show=!0,void(ue.data=o);var o}),`${a.id} + ${o} + ''`)}:{},{i:!!ie.value.is_show_context&&(null==(i=a.context)?void 0:i.length)},ie.value.is_show_context&&(null==(s=a.context)?void 0:s.length)?{j:e.t(null==(r=a.context)?void 0:r.length),k:e.o((e=>{return o=a.context,ne.show=!0,void(ne.data=o);var o}),`${a.id} + ${o} + ''`)}:{},{l:a.create_time&&!!ie.value.is_show_feedback},a.create_time&&ie.value.is_show_feedback?{m:e.o((e=>((e,a)=>{1!==g.value[a].is_feedback&&(Re.record_id=e.id,Re._index=a,Ce.value=!0)})(a,o)),`${a.id} + ${o} + ''`),n:"24d248d6-8-"+t+",24d248d6-7-"+t,o:e.p({text:a.is_feedback?"已反馈":"反馈",type:a.is_feedback?"info":"primary",size:"mini"})}:{},{p:0===o&&!ye.value},0!==o||ye.value?{}:{q:e.f(je.value.length?je.value:a.correlation,((a,o,n)=>({a:e.t(a),b:"24d248d6-9-"+t+"-"+n+",24d248d6-7-"+t,c:o,d:e.o((o=>e.unref(xe)(a)),o)}))),r:e.p({name:"arrow-rightward",color:"#999",size:"30"})},{s:e.unref(T)?1:"",t:e.o((o=>(async a=>{const o=g.value.filter((e=>e.id==a));2==o.length?O.value.initPosterData({title:o[1].content,content:o[0].content}):e.index.$u.toast("上下文数据不对～")})(a.id)),`${a.id} + ${o} + ''`),v:"24d248d6-7-"+t+",24d248d6-5",w:e.p({"record-id":a.id,type:"left",content:a.content,reasoning:a.reasoning,loading:a.loading,avatar:ie.value.icons?ie.value.icons:ie.value.image,index:o,chatType:2,time:a.create_time,showCopyBtn:!0,images:a.images,files:a.files,videos:a.videos,showVoiceBtn:!0,"model-name":a.model,"show-poster":!0})}):{},{x:`${a.id} + ${o} + ''`})})),q:ie.value.welcome_introducer},ie.value.welcome_introducer?{r:e.unref(T)?1:"",s:e.o(e.unref(xe)),t:e.p({type:"left",content:ie.value.welcome_introducer,avatar:ie.value.icons?ie.value.icons:ie.value.image,showCopyBtn:!1})}:{},{v:e.f(ie.value.menus,((a,o,t)=>({a:e.t(a.keyword),b:o,c:e.o((o=>e.unref(xe)(a.keyword)),o)}))),w:e.f(e.unref(A).files.value,((a,o,t)=>({a:e.t(a.name),b:e.o((o=>e.unref(A).removeFile(a)),a.id),c:"24d248d6-12-"+t+",24d248d6-11",d:a.id}))),x:e.p({type:"closeempty",size:16}),y:e.o(e.unref(xe)),z:e.o(qe),A:e.o(ce),B:e.o(e.unref(ge)),C:e.o((e=>se.value=e)),D:e.p({loading:ye.value||3===z.value,"show-stop":ye.value,modelValue:se.value}),E:e.unref(T)?"":1,F:e.sr(ve,"24d248d6-5,24d248d6-4",{k:"pagingRef"}),G:e.o(pe),H:e.o(fe),I:e.o(he),J:e.o((e=>g.value=e)),K:e.p({"use-chat-record-mode":!0,auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,fixed:!1,modelValue:g.value}),L:e.p({"z-index":"-1",content:e.unref(d).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}}),M:e.unref(T)},e.unref(T)?e.e({N:e.unref(H)},e.unref(H)?{O:e.p({name:"mic",size:50})}:{P:e.p({name:"mic-off",size:50})},{Q:e.unref(H)?"":1,R:e.o(ee)}):{},{S:e.unref(T)},e.unref(T)?{T:`${M.width}px`,U:`${M.height}px`,V:M.id,W:e.t(S[z.value])}:{},{X:e.unref(T)?ie.value.digital_bg:"",Y:e.o(e.unref(j)),Z:e.o(e.unref(x)),aa:e.o(e.unref(k)),ab:e.o(e.unref(q)),ac:e.o((e=>le.value=e)),ad:e.o((a=>e.isRef(_)?_.value=a:null)),ae:e.p({lists:e.unref(b),show:le.value,modelValue:e.unref(_)}),af:e.o((e=>ue.show=e)),ag:e.p({...ue,show:ue.show}),ah:e.o((e=>ne.show=e)),ai:e.p({...ne,show:ne.show}),aj:e.o((e=>Re.content=e)),ak:e.p({placeholder:"描述一下你遇到了什么问题",modelValue:Re.content}),al:e.o(Te),am:e.p({type:"primary"}),an:e.o((e=>Ce.value=e)),ao:e.p({"safe-area-inset-bottom":!0,closeable:!0,"border-radius":"16",mode:"center",modelValue:Ce.value}),ap:e.sr(O,"24d248d6-21",{k:"posterRef"})})}}});wx.createPage(h);
