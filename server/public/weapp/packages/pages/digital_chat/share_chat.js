"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/robot.js"),o=require("../../../hooks/useLockFn.js"),i=require("../../../stores/user.js"),r=require("../../../enums/requestEnums.js"),u=require("../../../hooks/useAudioPlay.js"),n=require("../../../hooks/useRecorder.js"),l=require("../../../hooks/useAudio.js"),s=require("../../../enums/constantEnums.js"),c=require("../../../utils/cache.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../lib/fft.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("u-icon")+e.resolveComponent("z-paging")+e.resolveComponent("u-button")+e.resolveComponent("u-input")+e.resolveComponent("dragon-button"))()}Math||(d+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../components/dragon-button/dragon-button.js")+v)();const v=()=>"./components/login.js",d=()=>"../../../uni_modules/vk-uview-ui/components/u-empty/u-empty.js",p=e.defineComponent({__name:"share_chat",setup(v){const d=e.useRoute(),p=i.useUserStore();e.shallowRef();const m=e.ref(!1),f=e.ref([]),h=e.ref(!1),g=e.ref(""),{key:y=""}=d.query,w=e.ref({robot:{},digital:{}}),j=e.ref(""),{isLock:b,lockFn:_}=o.useLockFn((async()=>{w.value=await t.getReleaseDetail({apikey:y})})),k=e.computed((()=>{var e;return(null==(e=w.value.menus)?void 0:e.map((e=>({keyword:e}))))||[]})),q=async()=>{const e=c.cache.get(s.AUTHORIZATION_KEY)||{};if(g.value=e[y]||"",w.value.pwd&&!g.value)return h.value=!0,Promise.reject()},x=async e=>{let a=c.cache.get(s.AUTHORIZATION_KEY)||{};g.value=e.password,a=Object.assign(a,{[y]:e.password}),c.cache.set(s.AUTHORIZATION_KEY,a),je()},R=e.ref(0),T=e.reactive({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中...",5:"用户拒绝了录音权限，请检查设备权限后重新进入程序"}),C=e.shallowRef();let A=0;const z=async(e,a)=>{var o,i;try{const{lists:i=[],count:r}=await t.getRobotChatRecord({share_apikey:y,identity:p.visitorId,page_size:a/2,page_no:e},{password:g.value,authorization:y,identity:p.visitorId});if(null==(o=C.value)||o.complete(i.reverse()),0===r?setTimeout((()=>{var e;null==(e=C.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{O()}),100),3==R.value){const e=i[0];e&&e.id!==A&&(A=e.id,le(A))}}catch(r){"访问密码错误!"===r&&((()=>{let e=c.cache.get(s.AUTHORIZATION_KEY)||{};e=Object.assign(e,{[y]:""}),c.cache.set(s.AUTHORIZATION_KEY,e)})(),q()),null==(i=C.value)||i.complete(!1)}},{lockFn:I}=o.useLockFn((async()=>{var a;await q();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(D(),await t.clearRobotChatRecord({},{password:g.value,authorization:y,identity:p.visitorId}),null==(a=C.value)||a.reload())})),O=async()=>{var e;null==(e=C.value)||e.scrollToBottom(!1)},E=e.ref(!1);let F=null;const $=e.ref([]),D=()=>{null==F||F.abort(),setTimeout((()=>{j.value=""}))};e.shallowRef();const P=e=>{R.value=e},N=e.ref({}),L=e.ref(""),{pauseAll:U}=u.useAudioPlay(),{lockFn:H}=o.useLockFn((async(a,o="text")=>{if(m.value=!1,await p.getFingerprint(),await q(),E.value)return;const i=a||j.value;if(i){C.value.addChatRecordData({type:1,content:i}),N.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},C.value.addChatRecordData(N.value),L.value=j.value,j.value="";try{E.value=!0,P(3),await t.robotChat({question:i,stream:!0},{onstart(e){F=e,U(),j.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o,i,r,u,n;if(""!==a)try{const s=JSON.parse(a),{object:c,choices:v,error:d}=s;if(d){P(1);const{message:a,code:t}=d;return a&&e.index.$u.toast(a),void f.value.splice(0,2)}const p=null==(o=null==(t=v[0])?void 0:t.delta)?void 0:o.content;switch(c){case"chat":N.value.content||(N.value.content=""),N.value.content+=p;break;case"reasoning":{const e=null==(r=null==(i=v[0])?void 0:i.delta)?void 0:r.content;N.value.reasoning+=e;break}case"question":$.value=JSON.parse(null==(n=null==(u=v[0])?void 0:u.delta)?void 0:n.content);break;case"image":case"video":case"file":{const e=`${c}s`;try{const a=JSON.parse(p);N.value[e]=a}catch(l){console.error(l)}}}}catch(s){}}))},onclose(){E.value=!1,setTimeout((()=>{var e;null==(e=C.value)||e.reload()}),1e3)}},{password:g.value,authorization:y,identity:p.visitorId})}catch(u){console.log("发送消息失败=>",u),u.errMsg!==r.RequestErrMsgEnum.ABORT&&f.value.splice(0,2),"text"==o&&(j.value=L.value),E.value=!1}}})),B=async()=>{await q(),O()},K=e.ref(),M=e.ref(!0),S=e.ref(!1),Y=e.ref(0),Z=e.ref(!1),V=e.ref(0),J=e.reactive({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:G,stopRender:Q,draw:W}=n.useRenderAudioGraph(J),{start:X,stop:ee,isRecording:ae,authorize:te,close:oe,isOpen:ie}=n.useRecorder({onstart(){P(2),clearTimeout(K.value),ue(),Z.value=!1,Y.value=Date.now()},async onstop(e){if(Q(),Z.value=!1,S.value){S.value=!1,P(3);try{const a=await t.voiceTransfer(e.tempFilePath);if(!a.text)return void(M.value?se():P(1));H(a.text,"voice")}catch(a){P(1)}}else P(1)},ondata(e){var a;const t=Date.now();Z.value&&G(e),e.powerLevel>=10&&(clearTimeout(V.value),R.value=2,Z.value=!0,Y.value=t,V.value=setTimeout((()=>{S.value=!0,clearTimeout(K.value),ue(),ee()}),2e3)),t-Y.value>=1e3*(null==(a=w.value.digital)?void 0:a.idle_time)&&(Z.value||(me(),ee()))}}),{play:re,pause:ue,isPlaying:ne}=l.useAudio({onstart(){R.value=4,pe.value&&(pe.value=!1)},onstop(){P(2),M.value?se():P(1)},onerror(){P(1)}}),le=async e=>{const a=await ve({type:2,record_id:e});re(a)},se=async()=>{ae.value||(await te(),X())},ce=async()=>{4!=R.value?3!=R.value&&(ae.value?(M.value=!1,ee(),P(1)):(M.value=!0,se())):ue()},ve=async e=>{try{const{url:a}=await t.voiceGenerate(e,{password:g.value,authorization:y,identity:p.visitorId});return a}catch(a){return P(1),Promise.reject()}},de=e.ref(""),pe=e.ref(!1),me=async()=>{if(!w.value.is_digital||!w.value.digital_id)return Promise.reject();if(de.value||(de.value=await ve({type:3,record_id:w.value.id})),!de.value)return Promise.reject();pe.value=!0;const a=Date.now();C.value.addChatRecordData({type:2,typing:!1,content:w.value.digital.idle_reply,key:a}),await e.nextTick$1(),O(),re(de.value)};let fe=null,he=null,ge=!1,ye=!1;const we=async()=>{ye=!0,ge&&(await te(),se())},je=async()=>{var a;await q(),null==(a=C.value)||a.reload(),M.value=!0,fe=e.index.createVideoContext("stay-video"),he=e.index.createVideoContext("talk-video");const{confirm:t}=await e.index.showModal({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"});if(t&&(null==fe||fe.play(),null==he||he.play(),ge=!0),ye)try{await te(),se()}catch(o){"无法录音:用户拒绝了录音权限"==o&&(R.value=5),await te()}finally{await te(),se()}};return e.onLoad((async()=>{await _(),await p.getFingerprint(),je()})),e.onUnmounted((()=>{D(),ue(),ee()})),(t,o)=>{var i,r;return e.e({a:t.$theme.navColor,b:t.$theme.navBgColor,c:t.$theme.pageStyle,d:0==R.value},0==R.value?{e:a._imports_0}:{},{f:5==R.value},5==R.value?{g:e.p({mode:"permission",text:" "}),h:e.t(T[R.value])}:{},{i:w.value.digital.id||e.unref(b)},w.value.digital.id||e.unref(b)?e.e({j:4!==R.value,k:null==(i=w.value.digital)?void 0:i.vertical_stay_video,l:e.o(we),m:4===R.value,n:null==(r=w.value.digital)?void 0:r.vertical_talk_video,o:e.t(w.value.name),p:e.f(f.value,((o,i,r)=>e.e({a:1==o.type},1==o.type?{b:"f9577689-2-"+r+",f9577689-1",c:e.p({type:"left",content:o.content,avatar:e.unref(a.DefaultAvatar),showCopyBtn:!1,bg:t.$theme.primaryColor,color:"#fff"})}:{},{d:2==o.type},2==o.type?e.e({e:0===i&&!E.value},0!==i||E.value?{}:{f:e.f($.value.length?$.value:o.correlation,((a,t,o)=>({a:e.t(a),b:"f9577689-4-"+r+"-"+o+",f9577689-3-"+r,c:t,d:e.o((t=>e.unref(H)(a)),t)}))),g:e.p({name:"arrow-rightward",color:"#999",size:"30"})},{h:"f9577689-3-"+r+",f9577689-1",i:e.p({"record-id":o.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:o.content,reasoning:o.reasoning,loading:o.loading,avatar:w.value.robot.icons?w.value.robot.icons:w.value.robot.image,index:i,chatType:2,showCopyBtn:!1,images:o.images,files:o.files,videos:o.videos})}):{},{j:`${o.id} + ${i} + ''`}))),q:e.sr(C,"f9577689-1",{k:"pagingRef"}),r:e.o(z),s:e.o((e=>f.value=e)),t:e.p({"use-chat-record-mode":!0,auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,fixed:!1,modelValue:f.value}),v:E.value},E.value?{w:e.p({name:"pause-circle",size:30}),x:e.o(D),y:e.p({color:"#fff",shape:"circle",size:"medium"})}:{},{z:e.t(T[R.value]),A:e.f(e.unref(k),((a,t,o)=>({a:e.t(a.keyword),b:t,c:e.o((t=>e.unref(H)(a.keyword)),t)}))),B:e.o(B),C:e.o((e=>j.value=e)),D:e.p({placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",modelValue:j.value}),E:a._imports_1$1,F:e.o((a=>e.unref(H)(j.value))),G:e.p({type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(R.value)}),H:a._imports_2,I:e.o(((...a)=>e.unref(I)&&e.unref(I)(...a))),J:Z.value},Z.value?{K:`${J.width}px`,L:`${J.height}px`,M:J.width*J.scale,N:J.height*J.scale,O:J.id}:{},{P:e.unref(ae)&&!Z.value},e.unref(ae)&&!Z.value?{Q:e.p({name:"mic",size:48})}:e.unref(ne)?{S:e.p({name:"pause-circle",size:60})}:e.unref(ae)?{}:{U:e.p({name:"mic-off",size:48})},{R:e.unref(ne),T:!e.unref(ae),V:e.unref(ae)||e.unref(ne)?"":1,W:e.o(ce),X:e.p({size:120,xEdge:"10",yEdge:"100"}),Y:w.value.robot.digital_bg}):{Z:e.p({text:"该智能体暂未配置形象",mode:"page"})},{aa:e.o(x),ab:e.o((e=>h.value=e)),ac:e.p({show:h.value})})}}}),m=e._export_sfc(p,[["__scopeId","data-v-f9577689"]]);wx.createPage(m);
