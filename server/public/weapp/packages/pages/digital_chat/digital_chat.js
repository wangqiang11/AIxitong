"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/robot.js"),o=require("../../../hooks/useLockFn.js"),u=require("../../../stores/user.js"),i=require("../../../stores/app.js"),r=require("../../../enums/requestEnums.js"),l=require("../../../hooks/useAudioPlay.js"),n=require("../../../hooks/useRecorder.js"),s=require("../../../hooks/useAudio.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../lib/fft.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("z-paging")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-input")+e.resolveComponent("dragon-button"))()}Math||(c+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../components/dragon-button/dragon-button.js"))();const c=()=>"../../../uni_modules/vk-uview-ui/components/u-empty/u-empty.js",v=e.defineComponent({__name:"digital_chat",setup(c){i.useAppStore();const v=e.useRouter(),d=e.useRoute(),p=u.useUserStore();e.shallowRef();const m=e.ref(!1),f=e.ref([]),g=e.computed((()=>d.query.id)),h=e.computed((()=>d.query.squareId)),y=e.computed((()=>d.query.cateId)),w=e.ref({}),j=e.ref(""),{isLock:q,lockFn:_}=o.useLockFn((async()=>{w.value=await t.getRobotDetail({id:g.value})})),b=()=>{v.navigateBack()},x=e.ref(0),k=e.reactive({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中...",5:"用户拒绝了录音权限，请检查设备权限后重新进入程序"}),C=e.shallowRef();let R=0;const T=async(e,a)=>{var o,u;try{const{lists:u=[],count:i}=await t.getRobotChatRecord({category_id:y.value,square_id:h.value,robot_id:g.value,page_size:a/2,page_no:e});if(null==(o=C.value)||o.complete(u.reverse()),0===i?setTimeout((()=>{var e;null==(e=C.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{E()}),100),3==x.value){const e=u[0];e&&e.id!==R&&(R=e.id,re(R))}}catch(i){null==(u=C.value)||u.complete(!1)}},{lockFn:z}=o.useLockFn((async()=>{var a;if(!p.isLogin)return A();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(D(),await t.clearRobotChatRecord({category_id:y.value,square_id:h.value,robot_id:g.value}),null==(a=C.value)||a.reload())})),A=()=>{v.navigateTo({path:"/pages/login/login"})},E=async()=>{var e;null==(e=C.value)||e.scrollToBottom(!1)},$=e.ref(!1);let L=null;const D=()=>{null==L||L.abort(),setTimeout((()=>{j.value=""}))};e.shallowRef();const F=e=>{x.value=e},P=e.ref({}),B=e.ref(""),{pauseAll:S}=l.useAudioPlay(),{lockFn:M}=o.useLockFn((async(a,o="text")=>{if(m.value=!1,!p.isLogin)return A();if($.value)return;const u=a||j.value;if(u){C.value.addChatRecordData({type:1,content:u}),P.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},C.value.addChatRecordData(P.value),B.value=j.value,j.value="";try{$.value=!0,F(3),await t.robotChat({square_id:h.value,cate_id:y.value,robot_id:g.value,question:u,stream:!0},{onstart(e){L=e,S(),j.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o;if(""!==a)try{const i=JSON.parse(a),{object:r,choices:l,error:n}=i;if(n){F(1);const{message:a,code:t}=n;return a&&e.index.$u.toast(a),void f.value.splice(0,2)}const s=null==(o=null==(t=l[0])?void 0:t.delta)?void 0:o.content;switch(r){case"chat":P.value.content||(P.value.content=""),P.value.content+=s;break;case"reasoning":P.value.content||(P.value.content=""),P.value.reasoning+=s;break;case"image":case"video":case"file":{const e=`${r}s`;try{const a=JSON.parse(s);P.value[e]=a}catch(u){console.error(u)}}}}catch(i){}}))},onclose(){$.value=!1,p.getUser(),setTimeout((()=>{var e;null==(e=C.value)||e.reload()}),1e3)}})}catch(i){console.log("发送消息失败=>",i),i.errMsg!==r.RequestErrMsgEnum.ABORT&&f.value.splice(0,2),"text"==o&&(j.value=B.value),$.value=!1}}})),I=()=>{if(!p.isLogin)return A();E()},O=e.ref(),V=e.ref(!0),U=e.ref(!1),G=e.ref(0),J=e.ref(!1),N=e.ref(0),H=e.reactive({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:K,stopRender:Q,draw:W}=n.useRenderAudioGraph(H),{start:X,stop:Y,isRecording:Z,authorize:ee,close:ae,isOpen:te}=n.useRecorder({onstart(){F(2),ue(),clearTimeout(O.value),J.value=!1,G.value=Date.now()},async onstop(e){if(Q(),J.value=!1,console.log(U.value,"isAutoStop"),U.value){U.value=!1,F(3);try{const a=await t.voiceTransfer(e.tempFilePath);if(!a.text)return void(V.value?le():F(1));M(a.text,"voice")}catch(a){F(1)}}else F(1)},ondata(e){var a;const t=Date.now();J.value&&K(e),e.powerLevel>=10&&(clearTimeout(N.value),x.value=2,J.value=!0,G.value=t,N.value=setTimeout((()=>{U.value=!0,clearTimeout(O.value),ue(),Y()}),1500)),t-G.value>=1e3*(null==(a=w.value.digital)?void 0:a.idle_time)&&(J.value||(de(),Y()))}}),{play:oe,pause:ue,isPlaying:ie}=s.useAudio({onstart(){x.value=4,ve.value&&(ve.value=!1)},onstop(){F(2),V.value?le():F(1)},onerror(){F(1)}}),re=async e=>{const a=await se({type:2,record_id:e});oe(a)},le=async()=>{Z.value||(await ee(),X())},ne=async()=>{4!=x.value?3!=x.value&&(Z.value?(V.value=!1,Y(),F(1)):(V.value=!0,le())):ue()},se=async e=>{try{const{url:a}=await t.voiceGenerate(e);return a}catch(a){return F(1),Promise.reject()}},ce=e.ref(""),ve=e.ref(!1),de=async()=>{if(!w.value.is_digital||!w.value.digital_id)return Promise.reject();if(ce.value||(ce.value=await se({type:3,record_id:w.value.id})),!ce.value)return Promise.reject();ve.value=!0;const a=Date.now();C.value.addChatRecordData({type:2,typing:!1,content:w.value.digital.idle_reply,key:a}),await e.nextTick$1(),E(),oe(ce.value)};let pe=null,me=null;const fe=async()=>{null==pe||pe.play(),null==me||me.play();try{await ee(),le()}catch(e){"无法录音:用户拒绝了录音权限"==e&&(x.value=5),await ee()}finally{await ee(),le()}};return e.onLoad((async()=>{var a;await _(),null==(a=C.value)||a.reload(),V.value=!0,pe=e.index.createVideoContext("stay-video"),me=e.index.createVideoContext("talk-video"),await e.index.showModal({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"}),await fe()})),e.onUnmounted((()=>{D(),ue(),Y()})),(t,o)=>{var u,i;return e.e({a:t.$theme.navColor,b:t.$theme.navBgColor,c:t.$theme.pageStyle,d:0==x.value},0==x.value?{e:a._imports_0}:{},{f:5==x.value},5==x.value?{g:e.p({mode:"permission",text:" "}),h:e.t(k[x.value])}:{},{i:w.value.digital_id||e.unref(q)},w.value.digital_id||e.unref(q)?e.e({j:4!==x.value,k:null==(u=w.value.digital)?void 0:u.vertical_stay_video,l:e.o(fe),m:4===x.value,n:null==(i=w.value.digital)?void 0:i.vertical_talk_video,o:e.t(w.value.name),p:a._imports_1,q:e.o(b),r:e.f(f.value,((a,o,u)=>e.e({a:1==a.type},1==a.type?{b:"4f098d56-2-"+u+",4f098d56-1",c:e.p({type:"left",content:a.content,avatar:e.unref(p).userInfo.avatar,showCopyBtn:!1,bg:t.$theme.primaryColor,color:"#fff"})}:{},{d:2==a.type},2==a.type?{e:"4f098d56-3-"+u+",4f098d56-1",f:e.p({"record-id":a.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:a.content,loading:a.loading,avatar:w.value.icons?w.value.icons:w.value.image,index:o,chatType:2,showCopyBtn:!1,images:a.images,files:a.files,videos:a.videos})}:{},{g:`${a.id} + ${o} + ''`}))),s:e.sr(C,"4f098d56-1",{k:"pagingRef"}),t:e.o(T),v:e.o((e=>f.value=e)),w:e.p({"use-chat-record-mode":!0,auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"auto-adjust-position-when-chat":!1,"default-page-size":20,fixed:!1,modelValue:f.value}),x:$.value},$.value?{y:e.p({name:"pause-circle",size:30}),z:e.o(D),A:e.p({color:"#fff",shape:"circle",size:"medium"})}:{},{B:e.t(k[x.value]),C:e.f(w.value.menus,((a,t,o)=>({a:e.t(a.keyword),b:t,c:e.o((t=>e.unref(M)(a.keyword)),t)}))),D:e.o(I),E:e.o((e=>j.value=e)),F:e.p({placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",modelValue:j.value}),G:a._imports_1$1,H:e.o((a=>e.unref(M)(j.value))),I:e.p({type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(x.value)}),J:a._imports_2,K:e.o(((...a)=>e.unref(z)&&e.unref(z)(...a))),L:J.value},J.value?{M:`${H.width}px`,N:`${H.height}px`,O:H.width*H.scale,P:H.height*H.scale,Q:H.id}:{},{R:e.unref(Z)&&!J.value},e.unref(Z)&&!J.value?{S:e.p({name:"mic",size:48})}:e.unref(ie)?{U:e.p({name:"pause-circle",size:60})}:e.unref(Z)?{}:{W:e.p({name:"mic-off",size:48})},{T:e.unref(ie),V:!e.unref(Z),X:e.unref(Z)||e.unref(ie)?"":1,Y:e.o(ne),Z:e.p({size:120,xEdge:"10",yEdge:"100"}),aa:w.value.digital_bg}):{ab:e.p({text:"该智能体暂未配置形象",mode:"page"})})}}});wx.createPage(v);
