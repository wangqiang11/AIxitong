"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/user.js"),o=require("../../../api/app.js"),u=require("../../../enums/appEnums.js"),t=require("../../../hooks/useCopy.js"),i=require("../../../router/index.js"),n=require("../../../utils/client.js"),l=require("../../../stores/user.js"),r=require("../../../stores/app.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../config/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/shop.js"),!Array){(e.resolveComponent("avatar-upload")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-form-item")+e.resolveComponent("u-popup")+e.resolveComponent("u-input")+e.resolveComponent("u-verification-code")+e.resolveComponent("u-action-sheet"))()}Math||((()=>"../../../components/avatar-upload/avatar-upload.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-form-item/u-form-item.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-verification-code/u-verification-code.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-action-sheet/u-action-sheet.js"))();const s=e.defineComponent({__name:"user_set",setup(s){const d=r.useAppStore(),{copy:c}=t.useCopy(),v=l.useUserStore(),p=e.ref({}),m=e.ref(u.FieldType.NONE),h=e.ref(!1),g=e.ref(!1),f=e.ref(!1),w=e.ref(!1),y=e.ref([{text:"修改密码"},{text:"忘记密码"}]),b=e.ref(""),x=e.ref(""),_=e.ref(""),j=e.ref(""),q=e.ref(""),C=e.shallowRef(),k=async()=>{p.value=await a.getUserInfo()},E=e=>{q.value=e},S=async()=>{var a,t;if(!_.value)return e.index.$u.toast("请输入新的手机号码");(null==(a=C.value)?void 0:a.canGetCode)&&(await o.smsSend({scene:p.value.mobile?u.SMSEnum.CHANGE_MOBILE:u.SMSEnum.BIND_MOBILE,mobile:_.value}),e.index.$u.toast("发送成功"),null==(t=C.value)||t.start())},$=async a=>{e.index.showLoading({title:"正在上传中..."});try{const u=await o.uploadImage(a);B(u.uri),e.index.hideLoading()}catch(u){e.index.hideLoading(),e.index.$u.toast(u)}},B=e=>{m.value=u.FieldType.AVATAR,M(e)},I=async()=>{await a.userBindMobile({type:p.value.mobile?"change":"bind",mobile:_.value,code:j.value}),e.index.$u.toast("操作成功"),f.value=!1,k()},M=async o=>{await a.userEdit({field:m.value,value:o}),e.index.$u.toast("操作成功"),k()},N=()=>""==x.value?e.index.$u.toast("账号不能为空"):x.value.length>10?e.index.$u.toast("账号长度不得超过十位数"):(m.value=u.FieldType.USERNAME,M(x.value),void(g.value=!1)),A=async a=>(b.value=a.detail.value.nickname,""==b.value?e.index.$u.toast("昵称不能为空"):b.value.length>10?e.index.$u.toast("昵称长度不得超过十位数"):(m.value=u.FieldType.NICKNAME,await M(b.value),void(h.value=!1))),L=async o=>{const{encryptedData:u,iv:t,code:i}=o.detail,n={code:i,encrypted_data:u,iv:t};u&&(await a.userMnpMobile({...n}),e.index.$u.toast("操作成功"),k())},T=()=>{i.router.navigateTo("/packages/pages/cancelaccount/cancelaccount")},V=()=>{if(!p.value.has_password)return i.router.navigateTo("/packages/pages/change_password/change_password?type=set");w.value=!0},z=e=>{switch(e){case 0:i.router.navigateTo("/packages/pages/change_password/change_password");break;case 1:i.router.navigateTo("/packages/pages/forget_pwd/forget_pwd?type="+(p.value.mobile?2:3))}},O=()=>{v.logout(),i.router.reLaunch("/pages/index/index")},U=e.ref(!0),F=async()=>{if(!(null==p?void 0:p.value.has_auth)){e.index.showLoading({title:"请稍后..."});try{if(n.getClient()==u.ClientEnum.MP_WEIXIN){const{code:o}=await e.index.login({provider:"weixin"});await a.apiBindwx({code:o})}else n.getClient()==u.ClientEnum.OA_WEIXIN&&wechatOa.getUrl(UrlScene.BIND_WX)}catch(o){e.index.$u.toast(o)}finally{e.index.hideLoading()}}};return e.onShow((async()=>{k()})),e.onLoad((async e=>{})),(a,o)=>{var u,t,i,n,l,r,s,v,m;return e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:e.o($),e:e.o((e=>p.value.avatar=e)),f:e.p({"file-key":"url",round:!0,modelValue:p.value.avatar}),g:e.t(null==(u=p.value)?void 0:u.nickname),h:e.p({name:"arrow-right",size:"22",color:"#666"}),i:e.o((e=>{var a;h.value=!0,b.value=null==(a=p.value)?void 0:a.nickname})),j:e.t(null==(t=p.value)?void 0:t.sn),k:e.p({name:"arrow-right",size:"22",color:"#666"}),l:e.o((a=>{var o;return e.unref(c)(null==(o=p.value)?void 0:o.sn)})),m:e.t(""==(null==(i=p.value)?void 0:i.mobile)?"未绑定手机号":null==(n=p.value)?void 0:n.mobile),n:e.t(""==(null==(l=p.value)?void 0:l.mobile)?"绑定手机号":"更换手机号"),o:e.o(L),p:e.p({"open-type":"getPhoneNumber",type:"primary",shape:"circle",size:"medium",plain:!0}),q:e.t(null==(r=p.value)?void 0:r.create_time),r:U.value},U.value?e.e({s:e.t(0==(null==(s=p.value)?void 0:s.has_auth)?"未绑定":"已绑定"),t:0==(null==(v=p.value)?void 0:v.has_auth)},0==(null==(m=p.value)?void 0:m.has_auth)?{v:e.p({name:"arrow-right",size:"22",color:"#666"})}:{},{w:e.o(F)}):{},{x:e.p({name:"arrow-right",color:"#666"}),y:e.o(V),z:1==e.unref(d).getSwitchConfig.account_cancelled},1==e.unref(d).getSwitchConfig.account_cancelled?{A:e.p({name:"arrow-right",size:"22",color:"#666"}),B:e.o(T)}:{},{C:e.o(O),D:p.value.nickname,E:e.p({borderBottom:!0}),F:e.o(A),G:e.o((e=>h.value=e)),H:e.p({closeable:!0,mode:"center",maskCloseAble:!1,"border-radius":"20",modelValue:h.value}),I:e.o((e=>x.value=e)),J:e.p({placeholder:"请输入账号",border:!1,modelValue:x.value}),K:e.p({borderBottom:!0}),L:e.o(N),M:e.p({type:"primary",shape:"circle"}),N:e.o((e=>g.value=e)),O:e.p({closeable:!0,mode:"center","border-radius":"20",modelValue:g.value}),P:e.o((e=>_.value=e)),Q:e.p({placeholder:"请输入新的手机号码",border:!1,modelValue:_.value}),R:e.p({borderBottom:!0}),S:e.o((e=>j.value=e)),T:e.p({placeholder:"请输入验证码",border:!1,modelValue:j.value}),U:e.sr(C,"4540c835-18,4540c835-16",{k:"uCodeRef"}),V:e.o(E),W:e.p({seconds:60,"change-text":"x秒"}),X:e.t(q.value),Y:e.o(S),Z:e.p({borderBottom:!0}),aa:e.o(I),ab:e.p({type:"primary",shape:"circle"}),ac:e.o((e=>f.value=e)),ad:e.p({closeable:!0,mode:"center","border-radius":"20",modelValue:f.value}),ae:e.o(z),af:e.o((e=>w.value=e)),ag:e.p({list:y.value,"safe-area-inset-bottom":!0,modelValue:w.value})})}}});wx.createPage(s);
