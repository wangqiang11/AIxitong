"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/robot.js"),t=require("../../../hooks/useLockFn.js"),o=require("../../../stores/user.js"),u=require("../../../stores/app.js"),n=require("../../../enums/requestEnums.js"),r=require("../../../hooks/useAudioPlay.js"),l=require("../../../components/chat-input/use-files-manage.js"),i=require("../../../hooks/useRecorder.js"),s=require("../../../hooks/useAudio.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../lib/fft.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("router-navigate")+e.resolveComponent("chat-record-item")+e.resolveComponent("u-tag")+e.resolveComponent("uni-icons")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark")+e.resolveComponent("l-textarea")+e.resolveComponent("u-button")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../node-modules/uniapp-router-next/components/router-navigate/router-navigate.js")+v+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-tag/u-tag.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/chat-input/chat-input.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js")+d+p+(()=>"../../../components/l-textarea/l-textarea.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+c)();const c=()=>"../../components/dialog-poster/dialog-poster.js",v=()=>"./components/square-robot.js",d=()=>"../../../components/chat-record-item/quote-popup.js",p=()=>"../../../components/chat-record-item/context-popup.js",m=e.defineComponent({__name:"square_chat",setup(c){const{pauseAll:v}=r.useAudioPlay(),d=u.useAppStore(),p=e.useRouter(),m=e.useRoute(),f=o.useUserStore();e.shallowRef();const h=l.useFilesManage(),g=e.ref(!1),w=e.ref([]),y=e.ref(1),_=e.computed((()=>2===y.value)),q=e.ref(0);e.reactive({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."});const j=e.shallowRef(),b=e=>{2===y.value&&(q.value=e)},k=e.ref(!1),x=e.ref(0),R=e.ref(!1),C=e.ref(0),T=e.ref(0),$=e.ref(!0),A=e.reactive({id:"audio-canvas",width:100,height:30,minHeight:5,scale:2}),{render:z,stopRender:F,draw:P}=i.useRenderAudioGraph(A),{start:B,stop:D,isRecording:S,authorize:L,close:E}=i.useRecorder({onstart(){R.value=!1,x.value=Date.now()},async onstop(e){if(F(),setTimeout((()=>{P(new Float64Array(new Array(128).fill(0)),0)}),10),k.value){k.value=!1,b(3);try{const t=await a.voiceTransfer(e.tempFilePath);if(!t.text)return void($.value&&b(2));he(t.text,"voice")}catch(t){$.value&&b(1)}}},ondata(e){z(e);const a=Date.now();e.powerLevel>15&&(clearTimeout(C.value),q.value=2,R.value=!0,x.value=a,C.value=setTimeout((()=>{k.value=!0,clearTimeout(T.value),D()}),2e3)),a-x.value>=5e3&&R.value}}),{play:V,pause:M,isPlaying:N}=s.useAudio({onstart(){q.value=4,U.value&&(U.value=!1,D())},onstop(){var e;T.value=setTimeout((()=>{G()}),1e3*(null==(e=K.value.digital)?void 0:e.idle_time)||0),$.value?b(2):b(1)},onerror(){b(1)}}),O=async e=>{const{url:t}=await a.voiceGenerate(e);return t},J=e.ref(""),U=e.ref(!1),G=async()=>{if(2!==y.value)return Promise.reject();if(!K.value.is_digital||!K.value.digital_id||K.value.is_disable)return Promise.reject();if(J.value||(J.value=await O({type:3,record_id:K.value.id})),!J.value)return Promise.reject();U.value=!0;const a=Date.now();w.value.push({type:2,typing:!1,content:K.value.digital.idle_reply,key:a}),await e.nextTick$1(),se(),V(J.value)};e.watch(y,(async e=>{if(1===e)M(),E(),q.value=0,clearTimeout(T.value);else{$.value=!0,await L(),P(null,0);try{await G()}catch(a){b(2)}se()}})),e.watch(q,(e=>{if(2===e)(async()=>{S.value||2!==y.value||B()})()}));const I=e.reactive({show:!1,data:[]}),H=e.reactive({show:!1,data:[]});e.ref(!1);const K=e.ref({}),Q=e.ref(""),W=e.ref(""),X=()=>{if(!f.isLogin)return _e();se()},Y=e.ref(m.query.id),Z=e.ref([]),ee=e.computed((()=>Z.value.find((e=>e.id===Number(Y.value)))||{})),ae=e.computed((()=>ee.value.robot_id)),te=e.shallowRef();let oe=0;const ue=async(e,t)=>{var o,u;try{const{lists:u=[],count:n}=await a.getRobotChatRecord({square_id:ee.value.id,robot_id:ae.value,page_size:t/2,page_no:e});if(null==(o=te.value)||o.complete(u.reverse()),0===n?setTimeout((()=>{var e;null==(e=te.value)||e.scrollToTop(!1)}),200):1===t&&setTimeout((()=>{se()}),100),2===y.value&&3==q.value){const e=u[0];e&&e.id!==oe&&(oe=e.id,(async e=>{try{const a=await O({type:2,record_id:e});V(a)}catch(a){b(1)}})(oe))}}catch(n){null==(u=te.value)||u.complete(!1)}},ne=e.ref(!1),re=e=>{e.height>0?ne.value=!0:ne.value=!1},le=()=>{ne.value=!1},{lockFn:ie}=t.useLockFn((async()=>{var t;if(!f.isLogin)return _e();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(pe(),await a.clearRobotChatRecord({robot_id:ae.value,square_id:ee.value.id}),null==(t=te.value)||t.reload())})),se=async()=>{var e;null==(e=te.value)||e.scrollToBottom(!1)},ce=e.ref(!1);let ve=null;const de=e.ref([]),pe=()=>{null==ve||ve.abort(),setTimeout((()=>{Q.value=""}))},me=e.ref({}),{pauseAll:fe}=r.useAudioPlay(),{lockFn:he}=t.useLockFn((async(t,o="text")=>{if(g.value=!1,!f.isLogin)return _e();if(ce.value)return;const u=t||Q.value;if(!u)return;const r=h.files.value.map((e=>({name:e.name,type:"30",url:e.url})));te.value.addChatRecordData({type:1,content:u,files_plugin:r}),me.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},te.value.addChatRecordData(me.value),W.value=Q.value,Q.value="";try{ce.value=!0,b(3),await a.robotChat({cate_id:0,square_id:ee.value.id,robot_id:ae.value,question:u,stream:!0,annex:[],files:h.files.value.map((e=>({...e,type:"30"})))},{onstart(e){ve=e,fe(),Q.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o,u,n;if(""!==a)try{const l=JSON.parse(a),{object:i,choices:s,error:c}=l;if(c){const{message:a,code:t}=c;return a&&e.index.$u.toast(a),void w.value.splice(0,2)}const v=null==(o=null==(t=s[0])?void 0:t.delta)?void 0:o.content;switch(i){case"chat":me.value.content||(me.value.content=""),me.value.content+=v;break;case"reasoning":me.value.content||(me.value.content=""),me.value.reasoning+=v;break;case"question":de.value=JSON.parse(null==(n=null==(u=s[0])?void 0:u.delta)?void 0:n.content);break;case"image":case"video":case"file":{const e=`${i}s`;try{const a=JSON.parse(v);me.value[e]=a}catch(r){console.error(r)}}}}catch(l){}}))},onclose(){ce.value=!1,f.getUser(),setTimeout((()=>{var e;null==(e=te.value)||e.reload()}),1e3)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==n.RequestErrMsgEnum.ABORT&&w.value.splice(0,2),"text"==o&&(Q.value=W.value),ce.value=!1}})),ge=e.ref(!1),we=e.reactive({_index:-1,robot_id:-1,record_id:-1,content:""}),ye=async()=>{try{await a.chatFeedBack(we),ge.value=!1,we.content="",w.value[we._index].is_feedback=1}catch(e){console.log("反馈提交失败--\x3e",e)}},_e=()=>{p.navigateTo({path:"/pages/login/login"})},qe=async()=>{ae.value&&(K.value=await a.getRobotDetail({id:ae.value}))};return e.watch(Y,(e=>{y.value=1,qe(),setTimeout((()=>{var a,t;e?null==(a=te.value)||a.reload():(null==(t=te.value)||t.complete([]),setTimeout((()=>{var e;null==(e=te.value)||e.scrollToTop(!1)}),100))}),10)})),e.onShow((async()=>{var e;if(m.query.square_id){const{id:e}=await a.putRobotRecord({id:m.query.square_id});Y.value=e}await(async()=>{Z.value=await a.getRobotRecord()})(),qe(),null==(e=te.value)||e.reload()})),e.onUnmounted((()=>{pe()})),(a,t)=>{var o,u;return e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:K.value.is_digital},K.value.is_digital?{e:e.p({name:"arrow-rightward"}),f:e.o(e.unref(v)),g:e.p({to:{path:"/packages/pages/digital_chat/digital_chat",query:{id:e.unref(ae),squareId:e.unref(ee).id}}})}:{},{h:e.o((e=>Y.value=e)),i:e.p({data:Z.value,modelValue:Y.value}),j:e.unref(_)},e.unref(_)?{k:!e.unref(N),l:null==(o=K.value.digital)?void 0:o.vertical_stay_video,m:e.unref(N),n:null==(u=K.value.digital)?void 0:u.vertical_talk_video}:{},{o:e.f(w.value,((a,t,o)=>{var u,n,r,l,i,s;return e.e({a:1==a.type},1==a.type?{b:e.unref(_)?1:"",c:"5aaa34aa-5-"+o+",5aaa34aa-4",d:e.p({type:"right",content:a.content,avatar:e.unref(f).userInfo.avatar,showCopyBtn:!0,"files-plugin":a.files_plugin})}:{},{e:2==a.type},2==a.type?e.e({f:!!K.value.is_show_quote&&(null==(u=a.quotes)?void 0:u.length)},K.value.is_show_quote&&(null==(n=a.quotes)?void 0:n.length)?{g:e.t(null==(r=a.quotes)?void 0:r.length),h:e.o((e=>{return t=a.quotes,H.show=!0,void(H.data=t);var t}),`${a.id} + ${t} + ''`)}:{},{i:!!K.value.is_show_context&&(null==(l=a.context)?void 0:l.length)},K.value.is_show_context&&(null==(i=a.context)?void 0:i.length)?{j:e.t(null==(s=a.context)?void 0:s.length),k:e.o((e=>{return t=a.context,I.show=!0,void(I.data=t);var t}),`${a.id} + ${t} + ''`)}:{},{l:a.create_time&&!!K.value.is_show_feedback},a.create_time&&K.value.is_show_feedback?{m:e.o((e=>((e,a)=>{1!==w.value[a].is_feedback&&(we.robot_id=ae.value,we.record_id=e.id,we._index=a,ge.value=!0)})(a,t)),`${a.id} + ${t} + ''`),n:"5aaa34aa-7-"+o+",5aaa34aa-6-"+o,o:e.p({text:a.is_feedback?"已反馈":"反馈",type:a.is_feedback?"info":"primary",size:"mini"})}:{},{p:0===t&&!ce.value},0!==t||ce.value?{}:{q:e.f(de.value.length?de.value:a.correlation,((a,t,u)=>({a:e.t(a),b:"5aaa34aa-8-"+o+"-"+u+",5aaa34aa-6-"+o,c:t,d:e.o((t=>e.unref(he)(a)),t)}))),r:e.p({name:"arrow-rightward",color:"#999",size:"30"})},{s:e.unref(_)?1:"",t:e.o((t=>(async a=>{const t=w.value.filter((e=>e.id==a));2==t.length?j.value.initPosterData({title:t[1].content,content:t[0].content}):e.index.$u.toast("上下文数据不对～")})(a.id)),`${a.id} + ${t} + ''`),v:"5aaa34aa-6-"+o+",5aaa34aa-4",w:e.p({"record-id":a.id,type:"left",content:a.content,reasoning:a.reasoning,loading:a.loading,avatar:K.value.icons?K.value.icons:K.value.image,index:t,chatType:2,time:a.create_time,showCopyBtn:!0,images:a.images,files:a.files,videos:a.videos,showVoiceBtn:!0,"model-name":a.model,"show-poster":!0})}):{},{x:`${a.id} + ${t} + ''`})})),p:K.value.welcome_introducer},K.value.welcome_introducer?{q:e.unref(_)?1:"",r:e.o(e.unref(he)),s:e.p({type:"left",content:K.value.welcome_introducer,avatar:K.value.icons?K.value.icons:K.value.image,showCopyBtn:!1})}:{},{t:e.f(K.value.menus,((a,t,o)=>({a:e.t(a.keyword),b:t,c:e.o((t=>e.unref(he)(a.keyword)),t)}))),v:e.f(e.unref(h).files.value,((a,t,o)=>({a:e.t(a.name),b:e.o((t=>e.unref(h).removeFile(a)),a.id),c:"5aaa34aa-11-"+o+",5aaa34aa-10",d:a.id}))),w:e.p({type:"closeempty",size:16}),x:e.o(e.unref(he)),y:e.o(pe),z:e.o(X),A:e.o(e.unref(ie)),B:e.o((e=>Q.value=e)),C:e.p({loading:ce.value||3===q.value,"show-stop":ce.value,"safe-area-inset-bottom":!K.value.copyright,modelValue:Q.value}),D:e.unref(_)?"":1,E:e.sr(te,"5aaa34aa-4,5aaa34aa-3",{k:"pagingRef"}),F:e.o(ue),G:e.o(re),H:e.o(le),I:e.o((e=>w.value=e)),J:e.p({"use-chat-record-mode":!0,auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,fixed:!1,modelValue:w.value}),K:e.p({"z-index":"-1",content:e.unref(d).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}}),L:e.unref(_)?K.value.digital_bg:"",M:e.o((e=>H.show=e)),N:e.p({...H,show:H.show}),O:e.o((e=>I.show=e)),P:e.p({...I,show:I.show}),Q:e.o((e=>we.content=e)),R:e.p({placeholder:"描述一下你遇到了什么问题",modelValue:we.content}),S:e.o(ye),T:e.p({type:"primary"}),U:e.o((e=>ge.value=e)),V:e.p({"safe-area-inset-bottom":!0,closeable:!0,"border-radius":"16",mode:"center",modelValue:ge.value}),W:e.sr(j,"5aaa34aa-17",{k:"posterRef"})})}}});wx.createPage(m);
