"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/chat.js"),t=require("../../../api/role.js"),o=require("../../../hooks/useLockFn.js"),n=require("../../../stores/user.js"),l=require("../../../stores/app.js"),r=require("../../../hooks/useShareMessage.js"),s=require("../../../enums/requestEnums.js"),i=require("../../../hooks/useAudioPlay.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../utils/util.js"),require("../../../stores/navigationBarTitle.js"),require("../../../mixins/share.js"),require("../../../api/task_reward.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("chat-record-item")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark"))()}Math||(u+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../components/chat-input/chat-input.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js")+c)();const u=()=>"../../../components/model-picker/model-picker.js",c=()=>"../../components/dialog-poster/dialog-poster.js",d=e.defineComponent({__name:"dialogue_role",setup(u){const{useShare:c,resolveOptions:d,removeMixinShare:v}=r.useShareMessage(),p=l.useAppStore(),g=e.useRoute(),h=e.useRouter(),m=n.useUserStore();e.shallowRef();const f=e.ref(!1),w=e.ref(0),y=e.ref({image:"",tips:"",name:""}),j=e.ref(""),q=e.ref([]),k=e.ref(""),C=e.ref(""),x=()=>{U()},_=e.reactive({show:!1,data:{url:"",name:"",type:"image"}}),R=e=>{_.show=!!e.support_image,_.show||(_.data.url="")},T=e.shallowRef(),S=e.shallowRef(),$=async(e,t)=>{var o,n;try{const{lists:n=[],count:l}=await a.getChatRecord({type:3,other_id:w.value,page_size:t/2,page_no:e});null==(o=T.value)||o.complete(n.reverse()),0===l?setTimeout((()=>{var e;null==(e=T.value)||e.scrollToTop(!1)}),200):1===t&&setTimeout((()=>{U()}),100)}catch(l){null==(n=T.value)||n.complete(!1)}},b=e.ref(!1),z=e=>{e.height>0?b.value=!0:b.value=!1},B=()=>{b.value=!1},{lockFn:M}=o.useLockFn((async()=>{var t;if(!m.isLogin)return V();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(I(),await a.cleanChatRecord({type:3,other_id:w.value}),null==(t=T.value)||t.reload())})),A=e.ref(-1),{lockFn:L}=o.useLockFn((async e=>{if(F.value)return;const a=q.value[e],t=q.value.findLast((({id:e})=>e===a.id));t&&(A.value=a.id,q.value.splice(e,2),H(t.content))})),U=async()=>{var e;null==(e=T.value)||e.scrollToBottom(!1)},F=e.ref(!1);let E=null;const D=e.ref([]),I=()=>{null==E||E.abort(),setTimeout((()=>{k.value=""}))},O=e.ref({}),{pauseAll:P}=i.useAudioPlay(),V=()=>{h.navigateTo({path:"/pages/login/login"})},{lockFn:H}=o.useLockFn((async t=>{if(f.value=!1,!m.isLogin)return V();if(F.value)return;const o=t||k.value;if(o){T.value.addChatRecordData({type:1,content:o,files_plugin:[{..._.data}]}),O.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},T.value.addChatRecordData(O.value),C.value=k.value,k.value="";try{F.value=!0,await a.chatSendText({type:3,other_id:w.value,question:o,model:j.value,file:_.data.url},{onstart(e){E=e,P(),k.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o,n,l,r,s,i;if(""!==a)try{const u=JSON.parse(a),{object:c,choices:d,error:v}=u;if(v){console.log(v);const{message:a,code:t}=v;if(1100===t)if(p.getIsShowRecharge){const{cancel:a}=await e.index.showModal({title:"温馨提示",content:`${p.getTokenUnit}数量已用完，请前往充值`});if(a)return;h.navigateTo({path:"/packages/pages/recharge/recharge"})}else e.index.$u.toast(`${p.getTokenUnit}数量已用完。请联系客服增加`);else a&&e.index.$u.toast(a);return k.value=C.value,void q.value.splice(0,2)}switch(c){case"chat":{const e=null==(t=d[0])?void 0:t.index,a=null==(n=null==(o=d[0])?void 0:o.delta)?void 0:n.content;O.value.content[e]||(O.value.content[e]=""),O.value.content[e]+=a;break}case"reasoning":{const e=null==(r=null==(l=d[0])?void 0:l.delta)?void 0:r.content;O.value.reasoning+=e;break}case"question":D.value=JSON.parse(null==(i=null==(s=d[0])?void 0:s.delta)?void 0:i.content);break;case"finish":console.log("终端"),_.data.url=""}}catch(u){}}))},async onclose(){-1!==A.value&&O.value.content.length&&(await a.cleanChatRecord({type:1,id:A.value}),A.value=-1),F.value=!1,m.getUser(),setTimeout((()=>{var e;null==(e=T.value)||e.reload()}),1e3)}})}catch(n){console.log("发送消息失败=>",n),n.errMsg!==s.RequestErrMsgEnum.ABORT&&q.value.splice(0,2),k.value=C.value,F.value=!1}}}));return e.onMounted((async()=>{const{id:e}=g.query;w.value=e,await(async()=>{try{y.value=await t.getRoleDetail({id:w.value}),c({desc:y.value.describe,title:y.value.name,imageUrl:y.value.image})}catch(e){console.log("获取角色错误=>",e)}})()})),e.onUnmounted((()=>{I()})),v(),e.onShareAppMessage((async()=>await d({title:y.value.name,imageUrl:y.value.image}))),(a,t)=>e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:e.o(R),e:e.o((e=>j.value=e)),f:e.p({hasHiddenUnit:!1,sub_id:j.value}),g:e.f(q.value,((a,t,o)=>e.e({a:2==a.type&&0===t},2==a.type&&0===t?{b:"31a20e31-4-"+o+",31a20e31-3-"+o,c:e.p({name:"reload",size:"26"}),d:e.o((a=>e.unref(L)(t)),`${a.id} + ${t} + ''`)}:{},{e:0===t&&!F.value},0!==t||F.value?{}:{f:e.f(D.value.length?D.value:a.correlation,((a,t,n)=>({a:e.t(a),b:"31a20e31-5-"+o+"-"+n+",31a20e31-3-"+o,c:t,d:e.o((t=>e.unref(H)(a)),t)}))),g:e.p({name:"arrow-rightward",color:"#999",size:"30"})},{h:e.o((t=>(async a=>{const t=q.value.filter((e=>e.id==a));2==t.length?S.value.initPosterData({title:t[1].content,content:t[0].content}):e.index.$u.toast("上下文数据不对～")})(a.id)),`${a.id} + ${t} + ''`),i:"31a20e31-3-"+o+",31a20e31-2",j:e.p({"record-id":a.id,type:1==a.type?"right":"left",content:a.content,reasoning:a.reasoning,loading:a.loading,avatar:1==a.type?e.unref(m).userInfo.avatar:y.value.image,index:t,time:2==a.type?a.create_time:"",showCopyBtn:!0,showVoiceBtn:2==a.type,"files-plugin":a.files_plugin,"model-name":a.model,"show-poster":2==a.type}),k:`${a.id} + ${t} + ''`}))),h:e.o((a=>e.unref(H)(a))),i:e.p({type:"left",content:y.value.tips,loading:!1,avatar:y.value.image,index:0,showCollectBtn:!1,showCopyBtn:!1,showVoiceBtn:!1}),j:e.unref(m).isLogin},e.unref(m).isLogin?{k:e.t(e.unref(m).userInfo.balance),l:e.t(e.unref(p).getTokenUnit)}:{},{m:e.o(e.unref(H)),n:e.o(I),o:e.o(x),p:e.o(e.unref(M)),q:e.o((a=>e.unref(H)("继续"))),r:e.o((e=>k.value=e)),s:e.o((e=>_.data=e)),t:e.p({loading:F.value,showStop:F.value,safeAreaInsetBottom:!0,showContinue:q.value.length,"show-file-upload":_.show,modelValue:k.value,"file-plugin":_.data}),v:e.sr(T,"31a20e31-2,31a20e31-1",{k:"pagingRef"}),w:e.o($),x:e.o(z),y:e.o(B),z:e.o((e=>q.value=e)),A:e.p({"use-chat-record-mode":!0,fixed:!1,height:"100%",auto:!0,"safe-area-inset-bottom":!1,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,modelValue:q.value}),B:e.p({"z-index":"-1",content:e.unref(p).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}}),C:e.sr(S,"31a20e31-8",{k:"posterRef"})})}});d.__runtimeHooks=2,wx.createPage(d);
