"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../api/chat.js"),a=require("../../../../hooks/useLockFn.js"),t=require("../../../../stores/user.js"),n=require("../../../../stores/app.js"),s=require("../../../../enums/requestEnums.js"),l=require("../../../../components/chat-input/use-files-manage.js"),u=require("./components/useSessionList.js"),i=require("../../../../hooks/useAudioPlay.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../utils/request/cancel.js"),require("../../../../router/index.js"),require("../../../../utils/cache.js"),require("../../../../enums/constantEnums.js"),require("../../../../config/index.js"),require("../../../../utils/client.js"),require("../../../../enums/appEnums.js"),require("../../../../api/user.js"),require("../../../../utils/auth.js"),require("../../../../utils/unique-id.js"),require("../../../../api/app.js"),require("../../../../api/shop.js"),!Array){(e.resolveComponent("model-picker")+e.resolveComponent("u-icon")+e.resolveComponent("chat-record-item")+e.resolveComponent("uni-icons")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark")+e.resolveComponent("u-modal"))()}Math||((()=>"../../../../components/model-picker/model-picker.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/chat-record-item/chat-record-item.js")+d+(()=>"../../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../../components/chat-input/chat-input.js")+(()=>"../../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js")+r+p+c+(()=>"../../../../uni_modules/vk-uview-ui/components/u-modal/u-modal.js"))();const r=()=>"../../../components/session/popup.js",c=()=>"../../../components/dialog-poster/dialog-poster.js",d=()=>"./components/problem-example.js",p=()=>"./components/problem-example-popup.js",v=e.defineComponent({__name:"chat",props:{active:{default:0}},emits:["active"],setup(r,{expose:c,emit:d}){var p;const v=n.useAppStore(),m=e.useRouter(),g=t.useUserStore();e.shallowRef();const f=l.useFilesManage(),h=e.ref(!1),w=e.ref([]),y=e.ref(""),{getSessionLists:j,initSessionActive:q,sessionActive:C,sessionAdd:k,sessionEdit:_,sessionLists:x,sessionDelete:T,sessionClear:b,currentSession:L}=u.useSessionList(),R=e.ref(!1),S=e.ref(!1),z=e.ref(!1),A=e.ref([]),$=e.ref(""),F=e.ref("");Boolean(v.getChatConfig.support_file);const E=()=>{if(!g.isLogin)return ae();G()},B=e.shallowRef();(null==(p=v.getChatConfig)?void 0:p.is_reopen)&&(k(),v.getChatConfig.is_reopen=0);const D=e.shallowRef(),M=async(e,a)=>{var t,n;try{const{lists:n=[],count:s}=await o.getChatRecord({type:1,category_id:C.value,page_size:a/2,page_no:e});null==(t=B.value)||t.complete(n.reverse()),0===s?setTimeout((()=>{var e;null==(e=B.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{G()}),100)}catch(s){null==(n=B.value)||n.complete(!1)}},U=e.ref(!1),V=e=>{e.height>0?U.value=!0:U.value=!1},I=()=>{U.value=!1};e.watch(C,(e=>{console.log(e),setTimeout((()=>{var o,a;e?null==(o=B.value)||o.reload():(null==(a=B.value)||a.complete([]),setTimeout((()=>{var e;null==(e=B.value)||e.scrollToTop(!1)}),100))}),10)}),{immediate:!0});const P=e.reactive({show:!1,data:{url:"",name:"",type:"image"}}),O=e=>{P.show=!!e.support_image,P.show||(P.data.url="")},{lockFn:H}=a.useLockFn((async()=>{if(!g.isLogin)return ae();z.value=!0})),J=async()=>{Y(),await o.cleanChatRecord({type:1,category_id:C.value})},K=e.ref(-1),{lockFn:N}=a.useLockFn((async e=>{if(Q.value)return;const o=w.value[e],a=w.value.findLast((({id:e})=>e===o.id));a&&(K.value=o.id,w.value.splice(e,2),oe(a.content))})),G=async()=>{var e;null==(e=B.value)||e.scrollToBottom(!1)},Q=e.ref(!1);let W=null;const X=e.ref([]),Y=()=>{null==W||W.abort(),setTimeout((()=>{$.value=""}))},Z=e.ref({}),{pauseAll:ee}=i.useAudioPlay(),{lockFn:oe}=a.useLockFn((async(a,t)=>{if(console.log(t),h.value=!1,!g.isLogin)return ae();if(Q.value)return;const n=a||$.value;if(!n)return;0===C.value&&await k(),"新的会话"===L.value&&await _({id:C.value,name:n});const l=f.files.value.map((e=>({name:e.name,type:"30",url:e.url})));P.data.url&&l.push({...P.data}),B.value.addChatRecordData({type:1,content:n,files_plugin:l}),Z.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},B.value.addChatRecordData(Z.value),F.value=$.value,$.value="";try{Q.value=!0,await o.chatSendText({type:1,other_id:C.value,question:n,model:y.value,annex:P.data.url?[{type:P.data.type,name:P.data.name,url:P.data.url}]:[],files:f.files.value.map((e=>({...e,type:"30"}))),...t},{onstart(e){W=e,ee(),$.value=""},onmessage(o){o.trim().split("data:").forEach((async o=>{var a,t,n,s,l,u,i;if(""!==o)try{const r=JSON.parse(o),{object:c,choices:d,error:p}=r;if(p){console.log(p);const{message:o,code:a}=p;if(1100===a)if(v.getIsShowRecharge){const{cancel:o}=await e.index.showModal({title:"温馨提示",content:`${v.getTokenUnit}数量已用完，请前往充值`});if(o)return;m.navigateTo({path:"/packages/pages/recharge/recharge"})}else e.index.$u.toast(`${v.getTokenUnit}数量已用完。请联系客服增加`);else o&&e.index.$u.toast(o);return $.value=F.value,void w.value.splice(0,2)}switch(c){case"chat":{const e=null==(a=d[0])?void 0:a.index,o=null==(n=null==(t=d[0])?void 0:t.delta)?void 0:n.content;Z.value.content[e]||(Z.value.content[e]=""),Z.value.content[e]+=o;break}case"reasoning":{const e=null==(l=null==(s=d[0])?void 0:s.delta)?void 0:l.content;Z.value.reasoning+=e;break}case"question":X.value=JSON.parse(null==(i=null==(u=d[0])?void 0:u.delta)?void 0:i.content);break;case"finish":P.data.url=""}}catch(r){}}))},async onclose(){-1!==K.value&&Z.value.content.length&&(await o.cleanChatRecord({type:1,id:K.value}),K.value=-1),Q.value=!1,g.getUser(),setTimeout((()=>{var e;null==(e=B.value)||e.reload()}),1e3)}})}catch(u){console.log("发送消息失败=>",u),u.errMsg!==s.RequestErrMsgEnum.ABORT&&w.value.splice(0,2),$.value=F.value,Q.value=!1}})),ae=()=>{m.navigateTo({path:"/pages/login/login"})};return e.onShow((async()=>{await j(),q(),(async()=>{A.value=await o.getSamplesLists()})(),setTimeout((()=>{var o;e.index.onKeyboardHeightChange(null==(o=B.value)?void 0:o._handleKeyboardHeightChange)}),100)})),e.onUnmounted((()=>{Y()})),c({showPopup:R}),(o,a)=>e.e({a:e.o(O),b:e.o((e=>y.value=e)),c:e.p({sub_id:y.value}),d:e.f(w.value,((o,a,t)=>e.e(0===r.active?e.e({a:2==o.type&&0===a},2==o.type&&0===a?{b:"3de04224-4-"+t+",3de04224-3-"+t,c:e.p({name:"reload",size:"26"}),d:e.o((o=>e.unref(N)(a)),`${o.id} + ${a} + ''`)}:{},{e:0===a&&!Q.value},0!==a||Q.value?{}:{f:e.f(X.value.length?X.value:o.correlation,((o,a,n)=>({a:e.t(o),b:"3de04224-5-"+t+"-"+n+",3de04224-3-"+t,c:a,d:e.o((a=>e.unref(oe)(o)),a)}))),g:e.p({name:"arrow-rightward",color:"#999",size:"30"})},{h:e.o((a=>(async o=>{const a=w.value.filter((e=>e.id==o));2==a.length?D.value.initPosterData({title:a[1].content,content:a[0].content}):e.index.$u.toast("上下文数据不对～")})(o.id)),`${o.id} + ${a} + ''`),i:"3de04224-3-"+t+",3de04224-1",j:e.p({"record-id":o.id,type:1==o.type?"right":"left",content:o.content,reasoning:o.reasoning,loading:o.loading,"files-plugin":o.files_plugin,avatar:1==o.type?e.unref(g).userInfo.avatar:e.unref(v).getChatConfig.chat_logo,index:a,time:2==o.type?o.create_time:"",showCopyBtn:!0,showVoiceBtn:2==o.type,"model-name":o.model,"show-poster":2==o.type})}):{},{k:`${o.id} + ${a} + ''`}))),e:0===r.active,f:A.value.length},A.value.length?{g:e.o(e.unref(oe)),h:e.o((e=>S.value=!0)),i:e.p({data:A.value})}:{},{j:e.unref(g).isLogin},e.unref(g).isLogin?{k:e.t(e.unref(g).userInfo.balance),l:e.t(e.unref(v).getTokenUnit)}:{},{m:e.f(e.unref(f).files.value,((o,a,t)=>({a:e.t(o.name),b:e.o((a=>e.unref(f).removeFile(o)),o.id),c:"3de04224-8-"+t+",3de04224-7",d:o.id}))),n:e.p({type:"closeempty",size:16}),o:e.o(e.unref(oe)),p:e.o(Y),q:e.o(E),r:e.o(e.unref(H)),s:e.o((o=>e.unref(oe)("继续"))),t:e.o((e=>$.value=e)),v:e.o((e=>P.data=e)),w:e.p({loading:Q.value,showStop:Q.value,"show-file-upload":P.show,showContinue:w.value.length,safeAreaInsetBottom:!0,modelValue:$.value,"file-plugin":P.data}),x:e.sr(B,"3de04224-1,3de04224-0",{k:"pagingRef"}),y:e.o(M),z:e.o(V),A:e.o(I),B:e.o((e=>w.value=e)),C:e.p({"use-chat-record-mode":!0,fixed:!1,height:"100%",auto:!1,"safe-area-inset-bottom":!1,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,modelValue:w.value}),D:e.p({"z-index":"-1",content:e.unref(v).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}}),E:e.o(e.unref(k)),F:e.o(e.unref(b)),G:e.o(e.unref(T)),H:e.o(e.unref(_)),I:e.o((e=>R.value=e)),J:e.o((o=>e.isRef(C)?C.value=o:null)),K:e.p({lists:e.unref(x),show:R.value,modelValue:e.unref(C)}),L:e.o((o=>e.unref(oe)(o))),M:e.o((e=>S.value=e)),N:e.p({data:A.value,modelValue:S.value}),O:e.sr(D,"3de04224-11",{k:"posterRef"}),P:e.o(J),Q:e.o((e=>z.value=e)),R:e.p({content:"确定清空对话？","show-cancel-button":!0,modelValue:z.value})})}});wx.createComponent(v);
