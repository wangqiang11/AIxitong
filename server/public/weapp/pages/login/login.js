"use strict";const e=require("../../common/vendor.js"),n=require("../../stores/app.js"),o=require("../../hooks/useLockFn.js"),i=require("../../api/account.js"),u=require("../../stores/user.js"),t=require("../../utils/cache.js"),r=require("../../enums/constantEnums.js"),s=require("../../utils/util.js"),a=require("../../api/user.js");if(require("../../utils/client.js"),require("../../api/app.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../api/shop.js"),require("../../utils/auth.js"),require("../../utils/unique-id.js"),require("../../enums/appEnums.js"),!Array){(e.resolveComponent("u-divider")+e.resolveComponent("u-icon"))()}Math||(c+l+g+(()=>"../../uni_modules/vk-uview-ui/components/u-divider/u-divider.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+d+p)();const c=()=>"./components/weixin.js",l=()=>"./components/mobile.js",g=()=>"./components/mailbox.js",d=()=>"./components/update-user-info.js",p=()=>"./components/bind-mobile.js",m=e.defineComponent({__name:"login",setup(c){const l=n.useAppStore(),g=u.useUserStore(),d=e.useRouter(),p=e.useRoute(),m=e.ref(!1),f=e.ref(!1),v=e.ref(0),h=e.computed((()=>"3"==v.value)),_=e.computed((()=>"1"==v.value)),j=e.computed((()=>"2"==v.value)),q=e.computed((()=>l.getLoginConfig.login_way.includes("3"))),w=e.computed((()=>l.getLoginConfig.login_way.includes("1"))),y=e.computed((()=>l.getLoginConfig.login_way.includes("2"))),L=e.computed((()=>{var e;return(null==(e=l.getLoginConfig.login_way)?void 0:e.length)>1})),C=e.computed((()=>l.getWebsiteConfig)),k=e=>{v.value=e},x=e.ref({}),S=async()=>{!x.value.mobile&&l.getLoginConfig.coerce_mobile?f.value=!0:A()},A=async()=>{const{token:e}=x.value;g.login(e),g.getUser();const n=getCurrentPages();if(n.length>1){const e=n[n.length-2];await d.navigateBack();const{onLoad:o,options:i}=e;o&&o(i)}else if(t.cache.get(r.BACK_URL))try{d.redirectTo(t.cache.get(r.BACK_URL))}finally{d.switchTab(t.cache.get(r.BACK_URL))}else d.reLaunch("/pages/index/index");t.cache.remove(r.BACK_URL)},b=s.series((async()=>{const e=t.cache.get(r.SHARE_ID),n=t.cache.get(r.USER_SN);try{(e||n)&&(await a.bindInvite({share_id:e,user_sn:n},x.value.token),t.cache.remove(r.SHARE_ID),t.cache.remove(r.USER_SN))}catch(o){}}),(async()=>{if(x.value.is_new_user&&!m.value)try{await i.updateUser({avatar:x.value.avatar,nickname:x.value.nickname},{token:x.value.token})}catch(e){}else if(m.value)return Promise.reject()}),S),R=()=>{f.value=!1,A()},{lockFn:U,isLock:E}=o.useLockFn((async()=>{let n=null;n=await(async()=>{const{code:n}=await e.index.login({provider:"weixin"}),o=await i.mnpLogin({code:n});return o.is_new_user&&(m.value=!0),o})(),console.log(n),n&&(x.value=n,b())})),{lockFn:B}=o.useLockFn((async n=>{e.index.showLoading({title:"请稍后..."});try{const o=await i.login(n);x.value=o,await b(),e.index.hideLoading()}catch(o){e.index.hideLoading(),e.index.$u.toast(o)}})),I=async e=>{await i.updateUser(e,{token:x.value.token}),m.value=!1,S()};e.watch((()=>l.getLoginConfig),(e=>{var n;v.value=null==(n=e.default_login_way)?void 0:n.toString()}),{immediate:!0});const D=()=>{const e=p.query;e.code&&e.state&&(delete e.code,delete e.state,d.redirectTo({path:p.path,query:e}))};return e.onLoad((async()=>{})),e.onShow((()=>{const e=t.cache.get(r.USER_LOGIN_DATA);e&&(x.value=JSON.parse(e),t.cache.remove(r.USER_LOGIN_DATA),b())})),(n,o)=>e.e({a:n.$theme.navColor,b:n.$theme.navBgColor,c:n.$theme.pageStyle,d:e.unref(l).getWebsiteConfig.pc_logo,e:e.t(e.unref(l).getWebsiteConfig.pc_name),f:e.unref(h)},e.unref(h)?{g:e.o(e.unref(U)),h:e.p({loading:e.unref(E)})}:{},{i:e.unref(_)},e.unref(_)?{j:e.o(e.unref(B))}:{},{k:e.unref(j)},e.unref(j)?{l:e.o(e.unref(B))}:{},{m:e.unref(L)},e.unref(L)?e.e({n:e.unref(q)&&!e.unref(h)},e.unref(q)&&!e.unref(h)?{o:e.p({name:"/static/images/icon/icon_wx.png",size:80}),p:e.o((e=>k("3")))}:{},{q:e.unref(w)&&!e.unref(_)},e.unref(w)&&!e.unref(_)?{r:e.p({name:"/static/images/icon/icon_phone.png",size:80}),s:e.o((e=>k("1")))}:{},{t:e.unref(y)&&!e.unref(j)},e.unref(y)&&!e.unref(j)?{v:e.p({name:"/static/images/icon/icon_email.png",size:80}),w:e.o((e=>k("2")))}:{},{x:e.unref(h)?1:""}):{},{y:e.o(I),z:e.o((e=>m.value=e)),A:e.p({logo:e.unref(C).pc_logo,title:e.unref(C).pc_name,userInfo:x.value,show:m.value}),B:e.o(R),C:e.o(D),D:e.o((e=>f.value=e)),E:e.p({userInfo:x.value,show:f.value})})}});wx.createPage(m);
