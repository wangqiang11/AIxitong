"use strict";const t=require("../../../../common/vendor.js");var e=void 0,n=["touchstarted","touchmoved","touchended"];function o(t){for(var e=[],o=arguments.length-1;o-- >0;)e[o]=arguments[o+1];n.forEach((function(n,o){void 0!==e[o]&&(t[n]=e[o])}))}function r(){return e||(e=t.index.getSystemInfoSync()),e}var a={},i={id:{default:"cropper",get:function(){return a.id},set:function(t){"string"!=typeof t&&console.error("id："+t+" is invalid"),a.id=t}},width:{default:750,get:function(){return a.width},set:function(t){"number"!=typeof t&&console.error("width："+t+" is invalid"),a.width=t}},height:{default:750,get:function(){return a.height},set:function(t){"number"!=typeof t&&console.error("height："+t+" is invalid"),a.height=t}},pixelRatio:{default:r().pixelRatio,get:function(){return a.pixelRatio},set:function(t){"number"!=typeof t&&console.error("pixelRatio："+t+" is invalid"),a.pixelRatio=t}},scale:{default:2.5,get:function(){return a.scale},set:function(t){"number"!=typeof t&&console.error("scale："+t+" is invalid"),a.scale=t}},zoom:{default:5,get:function(){return a.zoom},set:function(t){"number"!=typeof t?console.error("zoom："+t+" is invalid"):(t<0||t>10)&&console.error("zoom should be ranged in 0 ~ 10"),a.zoom=t}},src:{default:"",get:function(){return a.src},set:function(t){"string"!=typeof t&&console.error("src："+t+" is invalid"),a.src=t}},cut:{default:{},get:function(){return a.cut},set:function(t){"object"!=typeof t&&console.error("cut："+t+" is invalid"),a.cut=t}},boundStyle:{default:{},get:function(){return a.boundStyle},set:function(t){"object"!=typeof t&&console.error("boundStyle："+t+" is invalid"),a.boundStyle=t}},onReady:{default:null,get:function(){return a.ready},set:function(t){a.ready=t}},onBeforeImageLoad:{default:null,get:function(){return a.beforeImageLoad},set:function(t){a.beforeImageLoad=t}},onImageLoad:{default:null,get:function(){return a.imageLoad},set:function(t){a.imageLoad=t}},onBeforeDraw:{default:null,get:function(){return a.beforeDraw},set:function(t){a.beforeDraw=t}}},c=r().windowWidth;var u="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function s(t,e){return t(e={exports:{}},e.exports),e.exports}var d=s((function(t,e){e.isStr=function(t){return"string"==typeof t},e.isNum=function(t){return"number"==typeof t},e.isArr=Array.isArray,e.isUndef=function(t){return void 0===t},e.isTrue=function(t){return!0===t},e.isFalse=function(t){return!1===t},e.isFunc=function(t){return"function"==typeof t},e.isObj=e.isObject=function(t){return null!==t&&"object"==typeof t};var n=Object.prototype.toString;e.isPlainObject=function(t){return"[object Object]"===n.call(t)};var o=Object.prototype.hasOwnProperty;e.hasOwn=function(t,e){return o.call(t,e)},e.noop=function(t,e,n){},e.isValidArrayIndex=function(t){var e=parseFloat(String(t));return e>=0&&Math.floor(e)===e&&isFinite(t)}})),h=d.isFunc,f=d.isPlainObject,l=["ready","beforeImageLoad","beforeDraw","imageLoad"];function g(t){return function(e){for(var n=[],o=arguments.length-1;o-- >0;)n[o]=arguments[o+1];return void 0===e&&(e={}),new Promise((function(o,r){e.success=function(t){o(t)},e.fail=function(t){r(t)},t.apply(void 0,[e].concat(n))}))}}function p(t,e){return void 0===e&&(e=!1),new Promise((function(n){t.draw(e,n)}))}var v=g(t.index.getImageInfo),y=g(t.index.canvasToTempFilePath),x=s((function(t,e){
/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */
!function(n){var o=e,r=t&&t.exports==o&&t,a="object"==typeof u&&u;a.global!==a&&a.window!==a||(n=a);var i=function(t){this.message=t};(i.prototype=new Error).name="InvalidCharacterError";var c=function(t){throw new i(t)},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=/[\t\n\f\r ]/g,h={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&c("The string to be encoded contains characters outside of the Latin1 range.");for(var e,n,o,r,a=t.length%3,i="",u=-1,d=t.length-a;++u<d;)e=t.charCodeAt(u)<<16,n=t.charCodeAt(++u)<<8,o=t.charCodeAt(++u),i+=s.charAt((r=e+n+o)>>18&63)+s.charAt(r>>12&63)+s.charAt(r>>6&63)+s.charAt(63&r);return 2==a?(e=t.charCodeAt(u)<<8,n=t.charCodeAt(++u),i+=s.charAt((r=e+n)>>10)+s.charAt(r>>4&63)+s.charAt(r<<2&63)+"="):1==a&&(r=t.charCodeAt(u),i+=s.charAt(r>>2)+s.charAt(r<<4&63)+"=="),i},decode:function(t){var e=(t=String(t).replace(d,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&c("Invalid character: the string to be decoded is not correctly encoded.");for(var n,o,r=0,a="",i=-1;++i<e;)o=s.indexOf(t.charAt(i)),n=r%4?64*n+o:o,r++%4&&(a+=String.fromCharCode(255&n>>(-2*r&6)));return a},version:"0.1.0"};if(o&&!o.nodeType)if(r)r.exports=h;else for(var f in h)h.hasOwnProperty(f)&&(o[f]=h[f]);else n.base64=h}(u)}));function m(t){var e="";if("string"==typeof t)e=t;else for(var n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return x.encode(e)}function b(e,n,o,r,a,i,c){void 0===c&&(c=function(){}),void 0===i&&(i="png"),i=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]}(i),/bmp/.test(i)?function(e,n,o,r,a,i){t.index.canvasGetImageData({canvasId:e,x:n,y:o,width:r,height:a,success:function(t){i(t,null)},fail:function(t){i(null,t)}})}(e,n,o,r,a,(function(t,e){var n=function(t){var e=t.width,n=t.height,o=e*n*3,r=o+54,a=[66,77,255&r,r>>8&255,r>>16&255,r>>24&255,0,0,0,0,54,0,0,0],i=[40,0,0,0,255&e,e>>8&255,e>>16&255,e>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,1,0,24,0,0,0,0,0,255&o,o>>8&255,o>>16&255,o>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c=(4-3*e%4)%4,u=t.data,s="",d=e<<2,h=n,f=String.fromCharCode;do{for(var l=d*(h-1),g="",p=0;p<e;p++){var v=p<<2;g+=f(u[l+v+2])+f(u[l+v+1])+f(u[l+v])}for(var y=0;y<c;y++)g+=String.fromCharCode(0);s+=g}while(--h);return m(a.concat(i))+m(s)}(t);h(c)&&c(function(t,e){return"data:"+e+";base64,"+t}(n,"image/"+i),e)})):console.error("暂不支持生成'"+i+"'类型的base64图片")}var w=function(t,e){return void 0===t&&(t={}),void 0===e&&(e=function(){}),b(t.canvasId,t.x,t.y,t.width,t.height,"bmp",e)};var C={touchStart:function(t){var e=this,n=t.touches,r=n[0],a=n[1];e.src&&(o(e,!0,null,null),e.__oneTouchStart(r),t.touches.length>=2&&e.__twoTouchStart(r,a))},touchMove:function(t){var e=this,n=t.touches,r=n[0],a=n[1];e.src&&(o(e,null,!0),1===t.touches.length&&e.__oneTouchMove(r),t.touches.length>=2&&e.__twoTouchMove(r,a))},touchEnd:function(t){var e=this;e.src&&(o(e,!1,!1,!0),e.__xtouchEnd())}};var S=function(t){var e,n,o=this,r={};return e=o,n=i,Object.defineProperties(e,n),Object.keys(i).forEach((function(t){r[t]=i[t].default})),Object.assign(o,r,t),o.prepare(),o.attachPage(),o.createCtx(),o.observer(),o.cutt(),o.methods(),o.init(),o.update(),o};S.prototype.init=function(){var t=this,e=t.src;return t.version="1.3.9","function"==typeof t.onReady&&t.onReady(t.ctx,t),e?t.pushOrign(e):t.updateCanvas(),o(t,!1,!1,!1),t.oldScale=1,t.newScale=1,t},Object.assign(S.prototype,C),S.prototype.prepare=function(){var e=this;e.attachPage=function(){var t=getCurrentPages(),n=t[t.length-1];Object.defineProperty(n,"wecropper",{get:function(){return console.warn("Instance will not be automatically bound to the page after v1.4.0\n\nPlease use a custom instance name instead\n\nExample: \nthis.mycropper = new WeCropper(options)\n\n// ...\nthis.mycropper.getCropperImage()"),e},configurable:!0})},e.createCtx=function(){var n=e.id,o=e.targetId;n?(e.ctx=e.ctx||t.index.createCanvasContext(n),e.targetCtx=e.targetCtx||t.index.createCanvasContext(o)):console.error("constructor: create canvas context failed, 'id' must be valuable")},e.deviceRadio=c/750},S.prototype.observer=function(){var t=this;t.on=function(e,n){var o;return l.indexOf(e)>-1?h(n)&&("ready"===e?n(t):t["on"+(o=e,o.charAt(0).toUpperCase()+o.slice(1))]=n):console.error("event: "+e+" is invalid"),t}},S.prototype.methods=function(){var t=this,e=t.width,n=t.height,o=t.id,r=t.targetId,a=t.pixelRatio,i=t.cut,c=i.x;void 0===c&&(c=0);var u=i.y;void 0===u&&(u=0);var s=i.width;void 0===s&&(s=e);var d=i.height;void 0===d&&(d=n),t.updateCanvas=function(e){return t.croperTarget&&t.ctx.drawImage(t.croperTarget,t.imgLeft,t.imgTop,t.scaleWidth,t.scaleHeight),h(t.onBeforeDraw)&&t.onBeforeDraw(t.ctx,t),t.setBoundStyle(t.boundStyle),t.ctx.draw(!1,e),t},t.pushOrigin=t.pushOrign=function(e){return t.src=e,h(t.onBeforeImageLoad)&&t.onBeforeImageLoad(t.ctx,t),v({src:e}).then((function(e){var n=e.width/e.height,o=s/d;return t.croperTarget=e.path,n<o?(t.rectX=c,t.baseWidth=s,t.baseHeight=s/n,t.rectY=u-Math.abs((d-t.baseHeight)/2)):(t.rectY=u,t.baseWidth=d*n,t.baseHeight=d,t.rectX=c-Math.abs((s-t.baseWidth)/2)),t.imgLeft=t.rectX,t.imgTop=t.rectY,t.scaleWidth=t.baseWidth,t.scaleHeight=t.baseHeight,t.update(),new Promise((function(e){t.updateCanvas(e)}))})).then((function(){h(t.onImageLoad)&&t.onImageLoad(t.ctx,t)}))},t.removeImage=function(){return t.src="",t.croperTarget="",p(t.ctx)},t.getCropperBase64=function(t){void 0===t&&(t=function(){}),w({canvasId:o,x:c,y:u,width:s,height:d},t)},t.getCropperImage=function(e,n){var i=e,l={canvasId:o,x:c,y:u,width:s,height:d},g=function(){return Promise.resolve()};return f(i)&&i.original&&(g=function(){return t.targetCtx.drawImage(t.croperTarget,t.imgLeft*a,t.imgTop*a,t.scaleWidth*a,t.scaleHeight*a),l={canvasId:r,x:c*a,y:u*a,width:s*a,height:d*a},p(t.targetCtx)}),g().then((function(){f(i)&&(l=Object.assign({},l,i)),h(i)&&(n=i);var t=l.componentContext?[l,l.componentContext]:[l];return y.apply(null,t)})).then((function(e){var o=e.tempFilePath;return h(n)?n.call(t,o,null):o})).catch((function(e){if(!h(n))throw e;n.call(t,null,e)}))}},S.prototype.cutt=function(){var t=this,e=t.width,n=t.height,o=t.cut,r=o.x;void 0===r&&(r=0);var a=o.y;void 0===a&&(a=0);var i=o.width;void 0===i&&(i=e);var c=o.height;void 0===c&&(c=n),t.outsideBound=function(e,n){t.imgLeft=e>=r?r:t.scaleWidth+e-r<=i?r+i-t.scaleWidth:e,t.imgTop=n>=a?a:t.scaleHeight+n-a<=c?a+c-t.scaleHeight:n},t.setBoundStyle=function(o){void 0===o&&(o={});var u=o.color;void 0===u&&(u="#04b00f");var s=o.mask;void 0===s&&(s="rgba(0, 0, 0, 0.3)");var d=o.lineWidth;void 0===d&&(d=1);var h=d/2,f=[{start:{x:r-h,y:a+10-h},step1:{x:r-h,y:a-h},step2:{x:r+10-h,y:a-h}},{start:{x:r-h,y:a+c-10+h},step1:{x:r-h,y:a+c+h},step2:{x:r+10-h,y:a+c+h}},{start:{x:r+i-10+h,y:a-h},step1:{x:r+i+h,y:a-h},step2:{x:r+i+h,y:a+10-h}},{start:{x:r+i+h,y:a+c-10+h},step1:{x:r+i+h,y:a+c+h},step2:{x:r+i-10+h,y:a+c+h}}];t.ctx.beginPath(),t.ctx.setFillStyle(s),t.ctx.fillRect(0,0,r,n),t.ctx.fillRect(r,0,i,a),t.ctx.fillRect(r,a+c,i,n-a-c),t.ctx.fillRect(r+i,0,e-r-i,n),t.ctx.fill(),f.forEach((function(e){t.ctx.beginPath(),t.ctx.setStrokeStyle(u),t.ctx.setLineWidth(d),t.ctx.moveTo(e.start.x,e.start.y),t.ctx.lineTo(e.step1.x,e.step1.y),t.ctx.lineTo(e.step2.x,e.step2.y),t.ctx.stroke()}))}},S.prototype.update=function(){var t=this;t.src&&(t.__oneTouchStart=function(e){t.touchX0=Math.round(e.x),t.touchY0=Math.round(e.y)},t.__oneTouchMove=function(e){var n,o;if(t.touchended)return t.updateCanvas();n=Math.round(e.x-t.touchX0),o=Math.round(e.y-t.touchY0);var r=Math.round(t.rectX+n),a=Math.round(t.rectY+o);t.outsideBound(r,a),t.updateCanvas()},t.__twoTouchStart=function(e,n){var o,r,a;t.touchX1=Math.round(t.rectX+t.scaleWidth/2),t.touchY1=Math.round(t.rectY+t.scaleHeight/2),o=Math.round(n.x-e.x),r=Math.round(n.y-e.y),a=Math.round(Math.sqrt(o*o+r*r)),t.oldDistance=a},t.__twoTouchMove=function(e,n){var o=t.oldScale,r=t.oldDistance,a=t.scale,i=t.zoom;t.newScale=function(t,e,n,o,r){var a,i;return a=Math.round(r.x-o.x),i=Math.round(r.y-o.y),t+.001*n*(Math.round(Math.sqrt(a*a+i*i))-e)}(o,r,i,e,n),t.newScale<=1&&(t.newScale=1),t.newScale>=a&&(t.newScale=a),t.scaleWidth=Math.round(t.newScale*t.baseWidth),t.scaleHeight=Math.round(t.newScale*t.baseHeight);var c=Math.round(t.touchX1-t.scaleWidth/2),u=Math.round(t.touchY1-t.scaleHeight/2);t.outsideBound(c,u),t.updateCanvas()},t.__xtouchEnd=function(){t.oldScale=t.newScale,t.rectX=t.imgLeft,t.rectY=t.imgTop})},exports.WeCropper=S;
