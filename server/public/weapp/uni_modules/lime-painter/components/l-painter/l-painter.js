"use strict";const t=require("../../../../common/vendor.js"),e=require("../common/relation.js"),i=require("./props.js"),s=require("./utils.js"),a=require("./painter.js"),h={name:"lime-painter",mixins:[i.props,e.parent("painter"),{}],data:()=>({use2dCanvas:!0,canvasHeight:150,canvasWidth:null,parentWidth:0,inited:!1,progress:0,firstRender:0,done:!1,isPc:!1}),computed:{styles(){return`${this.size}${this.customStyle||""};`+(this.hidden&&"position: fixed; left: 1500rpx;")},canvasId(){return`l-painter${this._&&this._.uid||this._uid}`},size(){if(this.boardWidth&&this.boardHeight)return`width:${this.boardWidth}px; height: ${this.boardHeight}px;`},dpr(){return this.pixelRatio||t.index.getSystemInfoSync().pixelRatio},boardWidth(){const{width:t=0}=this.elements&&this.elements.css||this.elements||this,e=s.toPx(t||this.width);return e||Math.max(e,s.toPx(this.canvasWidth))},boardHeight(){const{height:t=0}=this.elements&&this.elements.css||this.elements||this,e=s.toPx(t||this.height);return e||Math.max(e,s.toPx(this.canvasHeight))},hasBoard(){return this.board&&Object.keys(this.board).length},elements(){return this.hasBoard?this.board:JSON.parse(JSON.stringify(this.el))}},watch:{size(t){this.use2dCanvas&&(this.inited=!1)}},created(){this.show=!0;const{SDKVersion:e,version:i,platform:a}=t.index.getSystemInfoSync();this.isPc=/windows|mac/.test(a),this.use2dCanvas="2d"===this.type&&s.compareVersion(e,"2.9.2")>=0},async mounted(){await s.sleep(30),await this.getParentWeith(),this.$nextTick((()=>{setTimeout((()=>{this.$watch("elements",this.watchRender,{deep:!0,immediate:!0})}),30)}))},unmounted(){this.done=!1,this.inited=!1,this.firstRender=0,this.progress=0,this.painter=null,clearTimeout(this.rendertimer)},methods:{async watchRender(t,e){t&&t.views&&(this.firstRender?this.firstRender:t.views.length)&&Object.keys(t).length&&JSON.stringify(t)!=JSON.stringify(e)&&(this.firstRender=1,this.progress=0,this.done=!1,clearTimeout(this.rendertimer),this.rendertimer=setTimeout((()=>{this.render(t)}),this.beforeDelay))},async setFilePath(t,e){let i=t;const{pathType:a=this.pathType}=e||this;return"base64"!=a||s.isBase64(t)?"url"==a&&s.isBase64(t)&&(i=await s.base64ToPath(t)):i=await s.pathToBase64(t),e&&e.isEmit&&this.$emit("success",i),i},async getSize(t){const{width:e}=t.css||t,{height:i}=t.css||t;this.size||(e||i?(this.canvasWidth=e||this.canvasWidth,this.canvasHeight=i||this.canvasHeight,await s.sleep(30)):await this.getParentWeith())},canvasToTempFilePathSync(t){this.stopWatch=this.$watch("done",(e=>{e&&(this.canvasToTempFilePath(t),this.stopWatch&&this.stopWatch())}),{immediate:!0})},getParentWeith(){return new Promise((e=>{t.index.createSelectorQuery().in(this).select(".lime-painter").boundingClientRect().exec((t=>{const{width:i,height:s}=t[0]||{};this.parentWidth=Math.ceil(i||0),this.canvasWidth=this.parentWidth||300,this.canvasHeight=s||this.canvasHeight||150,e(t[0])}))}))},async render(t={}){if(!Object.keys(t).length)return console.error("空对象");this.progress=0,this.done=!1,await this.getSize(t);const e=await this.getContext();let{use2dCanvas:i,boardWidth:h,boardHeight:n,canvas:r,afterDelay:c}=this;if(i&&!r)return Promise.reject(new Error("render: fail canvas has not been created"));if(this.boundary={top:0,left:0,width:h,height:n},this.painter=null,!this.painter){const{width:i}=t.css||t;t.css,!i&&this.parentWidth&&Object.assign(t,{width:this.parentWidth});const c={context:e,canvas:r,width:h,height:n,pixelRatio:this.dpr,useCORS:this.useCORS,createImage:s.getImageInfo.bind(this),listen:{onProgress:t=>{this.progress=t,this.$emit("progress",t)},onEffectFail:t=>{this.$emit("faill",t)}}};this.painter=new a.zt(c)}const{width:o,height:d}=await this.painter.source(JSON.parse(JSON.stringify(t)));return this.boundary.height=this.canvasHeight=d,this.boundary.width=this.canvasWidth=o,await s.sleep(this.sleep),this.painter.setContext(this.ctx),await this.painter.render(),await new Promise((t=>this.$nextTick(t))),i||await this.canvasDraw(),c&&i&&await s.sleep(c),this.$emit("done"),this.done=!0,this.isCanvasToTempFilePath&&this.canvasToTempFilePath().then((t=>{this.$emit("success",t.tempFilePath)})).catch((t=>{this.$emit("fail",new Error(JSON.stringify(t)))})),Promise.resolve({ctx:e,draw:this.painter,node:this.node})},canvasDraw(t=!1){return new Promise(((e,i)=>this.ctx.draw(t,(()=>setTimeout((()=>e()),this.afterDelay)))))},async getContext(){if(!this.canvasWidth)return this.$emit("fail","painter no size"),console.error("[lime-painter] no size: 请给画板或父级设置尺寸"),Promise.reject();if(this.ctx&&this.inited)return Promise.resolve(this.ctx);const{type:e,use2dCanvas:i,dpr:s,boardWidth:a,boardHeight:h}=this,n=()=>new Promise((e=>{t.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).boundingClientRect().exec((i=>{if(i){const s=t.index.createCanvasContext(this.canvasId,this);this.inited||(this.inited=!0,this.use2dCanvas=!1,this.canvas=i),this.ctx=s,e(this.ctx)}else console.error("[lime-painter] no node")}))}));return i?new Promise((i=>{t.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).node().exec((t=>{let{node:s}=t&&t[0]||{};if(s){const t=s.getContext(e);this.inited||(this.inited=!0,this.use2dCanvas=!0,this.canvas=s),this.ctx=t,i(this.ctx)}else console.error("[lime-painter]: no size")}))})):n()},canvasToTempFilePath(e={}){return new Promise((async(i,s)=>{const{use2dCanvas:a,canvasId:h,dpr:n,fileType:r,quality:c}=this;let{top:o=0,left:d=0,width:l,height:p}=this.boundary||this,m=l*n,u=p*n;const g=Object.assign({x:d,y:o,width:l,height:p,destWidth:m,destHeight:u,canvasId:h,fileType:r,quality:c},e,{success:async t=>{try{const s=await this.setFilePath(t.tempFilePath||t,e),a=Object.assign(t,{tempFilePath:s});e.success&&e.success(a),i(a)}catch(s){this.$emit("fail",s)}}});if((this.isPc||a)&&(g.canvas=this.canvas),a&&!this.isPc)try{const s=this.canvas.toDataURL(`image/${e.fileType||r}`.replace(/pg/,"peg"),e.quality||c);if(/data:,/.test(s))t.index.canvasToTempFilePath(g,this);else{const t=await this.setFilePath(s,e);e.success&&e.success({tempFilePath:t}),i({tempFilePath:t})}}catch(v){e.fail&&e.fail(v),s(v)}else t.index.canvasToTempFilePath(g,this)}))}}};const n=t._export_sfc(h,[["render",function(e,i,s,a,h,n){return t.e({a:n.canvasId&&n.size},n.canvasId&&n.size?t.e({b:h.use2dCanvas},h.use2dCanvas?{c:n.canvasId,d:t.s(n.size)}:{e:n.canvasId,f:t.s(n.size),g:n.canvasId,h:n.boardWidth*n.dpr,i:n.boardHeight*n.dpr},{j:t.s(n.styles)}):{})}]]);wx.createComponent(n);
