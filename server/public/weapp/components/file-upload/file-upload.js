"use strict";const e=require("../../common/vendor.js"),s=require("./choose-file.js"),r=require("../../api/app.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../stores/user.js"),require("../../api/user.js"),require("../../enums/constantEnums.js"),require("../../utils/auth.js"),require("../../utils/cache.js"),require("../../utils/unique-id.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../utils/client.js"),require("../../enums/appEnums.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-line-progress"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js"))();const t=e.defineComponent({__name:"file-upload",props:{modelValue:{type:[Array,Object],default:()=>[]},limit:{type:Number,default:10},disabled:{type:Boolean,default:!1},fileType:{type:String,default:"all"},returnType:{type:String,default:"array"},fileExtname:{type:Array,default:()=>[]},data:{type:Object,default:()=>({})},header:{type:Object,default:()=>({})},sizeType:{type:Array,default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},showProgress:{type:Boolean,default:!0},maxCount:{type:Number,default:2},showFilesLists:{type:Boolean,default:!0}},emits:["update:modelValue"],setup(t,{expose:u,emit:a}){const l=t,i=e.ref([]),o=e.computed((()=>"object"===l.returnType?1:l.limit?l.limit:1)),n=async()=>{if(l.disabled)return;if(i.value.length>=Number(o.value)&&"array"===l.returnType&&o.value>1)return void e.index.showToast({title:`您最多选择 ${o.value} 个文件`,icon:"none"});const r=await s.chooseFile({type:l.fileType,compressed:!1,sizeType:l.sizeType,sourceType:l.sourceType,extension:l.fileExtname.length?l.fileExtname:void 0,count:o.value-i.value.length});p(r)},p=async e=>{1===Number(o.value)&&(i.value=[]);const{files:r}=s.getFilesByExtname(e,l.fileExtname),t=[];for(let u=0;u<r.length&&!(o.value-i.value.length<=0);u++){const e=s.normalizeFileData(r[u]);i.value.push(e),t.push(e)}await m(t),c()},c=()=>{let e={};if("object"===l.returnType){const[s]=i.value;"success"===s.status&&(e={url:s.url,name:s.name})}else{e=i.value.filter((e=>"success"===e.status)).map((e=>({url:e.url,name:e.name})))}a("update:modelValue",e)},m=e=>{const s=e.length;let t=0,u=0;return new Promise((a=>{const o=async()=>{const n=t++,p=e[n],c=i.value.findIndex((e=>e.path===p.path));try{const{uri:e}=await r.uploadFileByType(l.fileType,{filePath:p.url,formData:l.data,header:l.header},(e=>{i.value[c].progress=e}));i.value[c].status="success",i.value[c].url=e}catch(m){i.value[c].errMsg=m,i.value[c].status="error"}u++,u!==s?t<s&&o():a()};for(let e=0;e<Math.min(s,l.maxCount);e++)o()}))},d=e.computed((()=>{switch(l.fileType){case"image":return"上传图片";case"video":return"上传视频";default:return"上传文件"}})),f=e=>{if(!e.url)return;i.value.some((s=>s.url==e.url))||(e.name||(e.name=s.getFileName(e.url)),e.status="success",i.value.push({...e}))};e.watch((()=>l.modelValue),(e=>{Array.isArray(e)?e.forEach((e=>{f(e)})):(e.url||(i.value=[]),f(e))}),{immediate:!0});return u({clear:()=>{i.value=[]}}),(s,r)=>e.e({a:"file"===t.fileType},"file"===t.fileType?{b:e.p({name:"arrow-upward",size:32})}:{c:e.p({name:"camera",size:32})},{d:e.t(e.unref(d)),e:e.o(n),f:t.showFilesLists},t.showFilesLists?{g:e.f(i.value,((r,u,a)=>e.e("file"==t.fileType?{a:"a0d366e2-2-"+a,b:e.p({size:32,name:"file-text"})}:{},"image"==t.fileType?{c:r.path||r.url}:{},"video"==t.fileType?{d:r.path||r.url}:{},{e:e.t(r.name)},t.disabled?{}:{f:"a0d366e2-3-"+a,g:e.p({name:"close",size:28}),h:e.o((e=>(e=>{const s=i.value.findIndex((s=>s.url===e));s>-1&&(i.value.splice(s,1),c())})(r.url)),r.url)},{i:t.showProgress&&r.progress>=0&&r.progress&&"success"!==r.status},t.showProgress&&r.progress>=0&&r.progress&&"success"!==r.status?{j:"a0d366e2-4-"+a,k:e.p({height:"6","show-percent":!1,"active-color":s.$theme.primaryColor,percent:r.progress})}:{},{l:"error"===r.status},"error"===r.status?{m:e.o((e=>(async e=>{e.status="ready",e.progress=0,await m([{...e}])})(r)),r.url)}:{},{n:r.url}))),h:"file"==t.fileType,i:"image"==t.fileType,j:"video"==t.fileType,k:!t.disabled}:{},{l:1===e.unref(o)?1:""})}});wx.createComponent(t);
