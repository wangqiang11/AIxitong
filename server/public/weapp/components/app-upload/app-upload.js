"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/request/index.js"),u=require("./utils.js");if(require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../stores/user.js"),require("../../api/user.js"),require("../../enums/constantEnums.js"),require("../../utils/auth.js"),require("../../utils/cache.js"),require("../../utils/unique-id.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../utils/client.js"),require("../../enums/appEnums.js"),!Array){e.resolveComponent("uv-upload")()}Math;const t=e.defineComponent({__name:"app-upload",props:{modelValue:null,accept:{default:"image"},capture:{default:()=>["album","camera"]},compressed:{type:Boolean,default:!0},camera:{default:"back"},maxDuration:{default:120},uploadIcon:{default:"camera-fill"},previewFullVideo:{type:Boolean,default:!0},previewFullImage:{type:Boolean,default:!0},maxCount:{default:1},maxUploadCount:{default:9},disabled:{type:Boolean,default:!1},imageMode:{default:"aspectFill"},width:{default:"180rpx"},height:{default:"180rpx"},header:{default:()=>({})},data:{default:()=>({})},multiple:{type:Boolean,default:!0},deletable:{type:Boolean,default:!0},returnType:{default:"string"},extname:null,previewImage:{type:Boolean,default:!0}},emits:["update:modelValue"],setup(t,{expose:l,emit:r}){const s=t,i=e.ref([]),n=e=>{i.value.splice(e.index,1),m()},o=e.computed((()=>"object"==s.returnType||"string"==s.returnType?1:s.maxCount)),c=e.computed((()=>{let a=s.extname;if(!a)switch(s.accept){case"image":a="jpg,png,gif,jpeg";break;case"video":a="wmv,avi,mpg,mpeg,3gp,mov,mp4,flv,rmvb,mkv";break;default:a="*"}return e.isString(a)?"*"==a?[]:a.split(","):Array.isArray(a)?a:[]})),d=async({file:e})=>{let a=0,t=0;const l=u.filterFile(e,c.value),r=l.length;l.forEach((e=>{i.value.push({...e,status:"uploading",message:"上传中"})}));const n=async()=>{const e=a++,u=l[e],s=i.value.find((e=>e.url===u.url));try{const e=await p(u.url);s.status="success",s.url=e}catch(o){s.status="failed",s.message="上传失败"}if(t++,t===r)return console.log(i.value),void m();a<r&&n()};for(let u=0;u<Math.min(r,s.maxUploadCount);u++)n()},p=async e=>{let u=s.accept;"all"==u&&(u="file");return(await a.request.uploadFile({url:`/upload/${u}`,filePath:e,name:"file",header:s.header,formData:s.data})).uri},m=()=>{let e="";switch(s.returnType){case"string":{const[a]=i.value;e="success"===(null==a?void 0:a.status)?a.url:"";break}case"object":{const[a]=i.value;e="success"===(null==a?void 0:a.status)?{url:a.url,name:a.name}:{};break}case"object-array":e=i.value.filter((e=>"success"===e.status)).map((e=>({url:e.url,name:e.name})));break;case"string-array":e=i.value.filter((e=>"success"===e.status)).map((e=>e.url));break}r("update:modelValue",e)},f=e=>{if(!e.url)return;const a=i.value.some((a=>a.url==e.url));console.log(i.value),a||(e.status="success",i.value.push({...e}))};e.watch((()=>s.modelValue),(a=>{if(e.isString(a)){if(!a)return void(i.value=[]);i.value=[{url:a}]}else if(e.isArray(a)){if(!a.length)return void(i.value=[]);a.forEach((a=>{e.isString(a)?f({url:a}):f(a)}))}else if(e.isObject(a)){if(!a.url)return void(i.value=[]);f(a)}}),{immediate:!0});return l({clear:()=>{i.value=[]}}),(a,u)=>({a:e.o(d),b:e.o(n),c:e.p({...s,useBeforeRead:!0,fileList:i.value,maxCount:e.unref(o)})})}});wx.createComponent(t);
