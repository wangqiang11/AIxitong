var e,t;import{r as a,a as s,o as l,c as i,w as u,b as o,g as r,aE as n,j as d,b5 as c,b6 as p,au as m,av as f,k as h,F as v,l as g,n as y,f as b,t as _,p as w,m as k,i as x,h as C,b1 as I,d as j,s as F,C as S,x as z,aU as B,b0 as $,O as D,aQ as O,e as T,aK as R}from"./index-d6d2a33a.js";import{_ as P,a as V,b as A}from"./uv-popup.0236847c.js";import{_ as L}from"./_plugin-vue_export-helper.1b428a4d.js";import{m as U,a as M,i as N,v as E,b as K,f as Q,p as X}from"./mixin.91a2f735.js";import{i as q}from"./isString.6d1f126a.js";const G=L({props:{src:{type:String,default:""},autoplay:{type:Boolean,default:!0}},data:()=>({videoSrc:"",show:!1}),computed:{getSec(){return this.src||this.videoSrc}},methods:{open(e){this.videoSrc=e,this.$refs.popup.open()},close(){this.$refs.popup.close()},change(e){this.show=e.show}}},[["render",function(e,t,c,p,m,f){const h=n,v=d,g=a(s("uv-popup"),P);return l(),i(g,{ref:"popup",onChange:f.change},{default:u((()=>[m.show?(l(),i(v,{key:0,class:"video-view"},{default:u((()=>[o(h,{class:"video",src:f.getSec,autoplay:c.autoplay},null,8,["src","autoplay"])])),_:1})):r("v-if",!0)])),_:1},8,["onChange"])}],["__scopeId","data-v-0ff84edc"]]);function H(e,t){return["[object Object]","[object File]"].includes(Object.prototype.toString.call(e))?Object.keys(e).reduce(((a,s)=>(t.includes(s)||(a[s]=e[s]),a)),{}):{}}function J(e){return e.tempFiles.map((e=>({...H(e,["path"]),url:e.path,size:e.size,name:e.name,type:e.type})))}function W({accept:e,multiple:t,capture:a,compressed:s,maxDuration:l,sizeType:i,camera:u,maxCount:o}){return new Promise(((r,n)=>{switch(e){case"image":m({count:t?Math.min(o,9):1,sourceType:a,sizeType:i,success:e=>r(function(e){return e.tempFiles.map((e=>{const t={...H(e,["path"]),type:"image",url:e.path,thumb:e.path,size:e.size,name:e.name};return t.name||(t.name=e.path.substring(e.path.lastIndexOf("/")+1)),t}))}(e)),fail:n});break;case"video":p({sourceType:a,compressed:s,maxDuration:l,camera:u,success:e=>r(function(e){return[{...H(e,["tempFilePath","thumbTempFilePath","errMsg"]),type:"video",url:e.tempFilePath,thumb:e.thumbTempFilePath,size:e.size,name:e.name||e.path.substring(e.path.lastIndexOf("/")+1)}]}(e)),fail:n});break;case"file":c({count:t?o:1,type:e,success:e=>r(J(e)),fail:n});break;default:c({count:t?o:1,type:"all",success:e=>r(J(e)),fail:n})}}))}const Y=L({name:"uv-upload",emits:["error","beforeRead","oversize","afterRead","delete","clickPreview"],mixins:[U,M,{watch:{accept:{immediate:!0,handler(e){}}}},{props:{accept:{type:String,default:"image"},capture:{type:[String,Array],default:()=>["album","camera"]},compressed:{type:Boolean,default:!0},camera:{type:String,default:"back"},maxDuration:{type:Number,default:60},uploadIcon:{type:String,default:"camera-fill"},uploadIconColor:{type:String,default:"#D3D4D6"},useBeforeRead:{type:Boolean,default:!1},afterRead:{type:Function,default:null},beforeRead:{type:Function,default:null},previewFullImage:{type:Boolean,default:!0},previewFullVideo:{type:Boolean,default:!0},maxCount:{type:[String,Number],default:52},disabled:{type:Boolean,default:!1},imageMode:{type:String,default:"aspectFill"},name:{type:String,default:""},sizeType:{type:Array,default:()=>["original","compressed"]},multiple:{type:Boolean,default:!1},deletable:{type:Boolean,default:!0},maxSize:{type:[String,Number],default:Number.MAX_VALUE},fileList:{type:Array,default:()=>[]},uploadText:{type:String,default:""},width:{type:[String,Number],default:80},height:{type:[String,Number],default:80},previewImage:{type:Boolean,default:!0},...null==(t=null==(e=uni.$uv)?void 0:e.props)?void 0:t.upload}}],data:()=>({lists:[],isInCount:!0}),watch:{fileList:{deep:!0,immediate:!0,handler(){this.formatFileList()}},deletable(e){e||this.lists.map((e=>{e.deletable=this.deletable}))}},methods:{formatFileList(){const{fileList:e=[],maxCount:t}=this,a=e.map((e=>Object.assign(Object.assign({},e),{isImage:"image"===this.accept||N(e.url||e.thumb),isVideo:"video"===this.accept||E(e.url||e.thumb),deletable:"boolean"==typeof e.deletable?e.deletable:this.deletable})));this.lists=a,this.isInCount=a.length<t},chooseFile(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{const{maxCount:e,multiple:t,lists:a,disabled:s}=this;if(s)return;let l;try{l=K(this.capture)?this.capture:this.capture.split(",")}catch(i){l=[]}W(Object.assign({accept:this.accept,multiple:this.multiple,capture:l,compressed:this.compressed,maxDuration:this.maxDuration,sizeType:this.sizeType,camera:this.camera},{maxCount:e-a.length})).then((e=>{this.onBeforeRead(t?e:e[0])})).catch((e=>{this.$emit("error",e)}))}),100)},onBeforeRead(e){const{beforeRead:t,useBeforeRead:a}=this;let s=!0;Q(t)&&(s=t(e,this.getDetail())),a&&(s=new Promise(((t,a)=>{this.$emit("beforeRead",Object.assign(Object.assign({file:e},this.getDetail()),{callback:e=>{e?t():a()}}))}))),s&&(X(s)?s.then((t=>this.onAfterRead(t||e))):this.onAfterRead(e))},getDetail(e){return{name:this.name,index:null==e?this.fileList.length:e}},onAfterRead(e){const{maxSize:t,afterRead:a}=this;(Array.isArray(e)?e.some((e=>e.size>t)):e.size>t)?this.$emit("oversize",Object.assign({file:e},this.getDetail())):("function"==typeof a&&a(e,this.getDetail()),this.$emit("afterRead",Object.assign({file:e},this.getDetail())))},deleteItem(e){this.$emit("delete",Object.assign(Object.assign({},this.getDetail(e)),{file:this.fileList[e]}))},onPreviewImage(e,t){const a=this.$uv.deepClone(this.lists);a.map(((e,a)=>{a==t&&(e.current=!0)}));const s=a.filter((e=>e.isImage)).findIndex((e=>e.current));this.onClickPreview(e,t),e.isImage&&this.previewFullImage&&f({urls:this.lists.filter((e=>"image"===this.accept||N(e.url||e.thumb))).map((e=>e.url||e.thumb)),current:s,fail(){this.$uv.toast("预览图片失败")}})},onPreviewVideo(e,t){this.onClickPreview(e,t),this.previewFullVideo&&e.isVideo&&this.$refs.previewVideo.open(e.url)},onClickPreview(e,t){this.$emit("clickPreview",Object.assign(Object.assign({},e),this.getDetail(t)))}}},[["render",function(e,t,n,c,p,m){const f=x,I=a(s("uv-icon"),V),j=C,F=d,S=a(s("uv-loading-icon"),A),z=a(s("uv-preview-video"),G);return l(),i(F,{class:"uv-upload",style:y([e.$uv.addStyle(e.customStyle)])},{default:u((()=>[o(F,{class:"uv-upload__wrap"},{default:u((()=>[e.previewImage?(l(!0),h(v,{key:0},g(p.lists,((t,a)=>(l(),i(F,{class:"uv-upload__wrap__preview",key:a},{default:u((()=>[t.isImage||t.type&&"image"===t.type?(l(),i(f,{key:0,src:t.thumb||t.url,mode:e.imageMode,class:"uv-upload__wrap__preview__image",onClick:e=>m.onPreviewImage(t,a),style:y([{width:e.$uv.addUnit(e.width),height:e.$uv.addUnit(e.height)}])},null,8,["src","mode","onClick","style"])):(l(),i(F,{key:1,class:"uv-upload__wrap__preview__other",onClick:e=>m.onPreviewVideo(t,a),style:y([{width:e.$uv.addUnit(e.width),height:e.$uv.addUnit(e.height)}])},{default:u((()=>[o(I,{color:"#80CBF9",size:"26",name:t.isVideo||t.type&&"video"===t.type?"movie":"folder"},null,8,["name"]),o(j,{class:"uv-upload__wrap__preview__other__text"},{default:u((()=>[b(_(t.isVideo||t.type&&"video"===t.type?"视频":"文件"),1)])),_:2},1024)])),_:2},1032,["onClick","style"])),"uploading"===t.status||"failed"===t.status?(l(),i(F,{key:2,class:"uv-upload__status"},{default:u((()=>[o(F,{class:"uv-upload__status__icon"},{default:u((()=>["failed"===t.status?(l(),i(I,{key:0,name:"close-circle",color:"#ffffff",size:"25"})):(l(),i(S,{key:1,size:"22",mode:"circle"}))])),_:2},1024),t.message?(l(),i(j,{key:0,class:"uv-upload__status__message"},{default:u((()=>[b(_(t.message),1)])),_:2},1024)):r("v-if",!0)])),_:2},1024)):r("v-if",!0),"uploading"!==t.status&&(e.deletable||t.deletable)?(l(),i(F,{key:3,class:"uv-upload__deletable",onClick:w((e=>m.deleteItem(a)),["stop"])},{default:u((()=>[o(F,{class:"uv-upload__deletable__icon"},{default:u((()=>[o(I,{name:"close",color:"#ffffff",size:"10"})])),_:1})])),_:2},1032,["onClick"])):r("v-if",!0),"success"===t.status?(l(),i(F,{key:4,class:"uv-upload__success"},{default:u((()=>[o(F,{class:"uv-upload__success__icon"},{default:u((()=>[o(I,{name:"checkmark",color:"#ffffff",size:"12"})])),_:1})])),_:1})):r("v-if",!0)])),_:2},1024)))),128)):r("v-if",!0),p.isInCount?(l(),i(F,{key:1,onClick:m.chooseFile},{default:u((()=>[o(F,{class:k(["uv-upload__button",[e.disabled&&"uv-upload__button--disabled"]]),"hover-class":e.disabled?"":"uv-upload__button--hover","hover-stay-time":"150",onClick:w(m.chooseFile,["stop"]),style:y([{width:e.$uv.addUnit(e.width),height:e.$uv.addUnit(e.height)}])},{default:u((()=>[o(I,{name:e.uploadIcon,size:"26",color:e.uploadIconColor},null,8,["name","color"]),e.uploadText?(l(),i(j,{key:0,class:"uv-upload__button__text"},{default:u((()=>[b(_(e.uploadText),1)])),_:1})):r("v-if",!0)])),_:1},8,["hover-class","onClick","class","style"])])),_:1},8,["onClick"])):r("v-if",!0)])),_:1}),o(z,{ref:"previewVideo"},null,512)])),_:1},8,["style"])}],["__scopeId","data-v-c5150532"]]),Z=j({__name:"app-upload",props:{modelValue:null,accept:{default:"image"},capture:{default:()=>["album","camera"]},compressed:{type:Boolean,default:!0},camera:{default:"back"},maxDuration:{default:120},uploadIcon:{default:"camera-fill"},previewFullVideo:{type:Boolean,default:!0},previewFullImage:{type:Boolean,default:!0},maxCount:{default:1},maxUploadCount:{default:9},disabled:{type:Boolean,default:!1},imageMode:{default:"aspectFill"},width:{default:"180rpx"},height:{default:"180rpx"},header:{default:()=>({})},data:{default:()=>({})},multiple:{type:Boolean,default:!0},deletable:{type:Boolean,default:!0},returnType:{default:"string"},extname:null,previewImage:{type:Boolean,default:!0}},emits:["update:modelValue"],setup(e,{expose:t,emit:o}){const r=e,n=F([]),d=e=>{n.value.splice(e.index,1),h()},c=S((()=>"object"==r.returnType||"string"==r.returnType?1:r.maxCount)),p=S((()=>{let e=r.extname;if(!e)switch(r.accept){case"image":e="jpg,png,gif,jpeg";break;case"video":e="wmv,avi,mpg,mpeg,3gp,mov,mp4,flv,rmvb,mkv";break;default:e="*"}return q(e)?"*"==e?[]:e.split(","):Array.isArray(e)?e:[]})),m=async({file:e})=>{let t=0,a=0;const s=((e,t=[])=>{const a=[];return t.length?(e.forEach((e=>{const s=(e=>{const t=e.lastIndexOf("."),a=e.length;return{name:e.substring(0,t),ext:e.substring(t+1,a)}})(e.name).ext.toLowerCase();-1!==t.indexOf(s)&&a.push(e)})),a.length!==e.length&&I({title:`当前选择了${e.length}个文件 ，${e.length-a.length} 个文件格式不正确，已自动剔除`,icon:"none",duration:5e3}),a):e})(e,p.value),l=s.length;s.forEach((e=>{n.value.push({...e,status:"uploading",message:"上传中"})}));const i=async()=>{const e=t++,u=s[e],o=n.value.find((e=>e.url===u.url));try{const e=await f(u.url);o.status="success",o.url=e}catch(r){o.status="failed",o.message="上传失败"}if(a++,a===l)return console.log(n.value),void h();t<l&&i()};for(let u=0;u<Math.min(l,r.maxUploadCount);u++)i()},f=async e=>{let t=r.accept;"all"==t&&(t="file");return(await R.uploadFile({url:`/upload/${t}`,filePath:e,name:"file",header:r.header,formData:r.data})).uri},h=()=>{let e="";switch(r.returnType){case"string":{const[t]=n.value;e="success"===(null==t?void 0:t.status)?t.url:"";break}case"object":{const[t]=n.value;e="success"===(null==t?void 0:t.status)?{url:t.url,name:t.name}:{};break}case"object-array":e=n.value.filter((e=>"success"===e.status)).map((e=>({url:e.url,name:e.name})));break;case"string-array":e=n.value.filter((e=>"success"===e.status)).map((e=>e.url));break}o("update:modelValue",e)},v=e=>{if(!e.url)return;const t=n.value.some((t=>t.url==e.url));console.log(n.value),t||(e.status="success",n.value.push({...e}))};z((()=>r.modelValue),(e=>{if(q(e)){if(!e)return void(n.value=[]);n.value=[{url:e}]}else if(B(e)){if(!e.length)return void(n.value=[]);e.forEach((e=>{q(e)?v({url:e}):v(e)}))}else if($(e)){if(!e.url)return void(n.value=[]);v(e)}}),{immediate:!0});return t({clear:()=>{n.value=[]}}),(e,t)=>{const o=a(s("uv-upload"),Y);return l(),i(o,O(r,{useBeforeRead:!0,fileList:n.value,maxCount:T(c),onAfterRead:m,onDelete:d}),{default:u((()=>[D(e.$slots,"default"),b(" 111 ")])),_:3},16,["fileList","maxCount"])}}});export{Z as _};
