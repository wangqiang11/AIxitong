var t=Object.defineProperty,e=(e,r,n)=>(((e,r,n)=>{r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n})(e,"symbol"!=typeof r?r+"":r,n),n);import{_ as r}from"./u-icon.992584aa.js";import{d as n,C as a,J as o,s as i,r as s,a as l,o as u,c,w as f,b as p,m as d,f as h,g as v,e as m,t as g,O as x,P as y,p as w,b7 as b,j as k,i as P,h as S,M as A,b8 as _,ap as E,K as T,ar as O,x as C,b9 as M,ba as j,aq as B,ay as I,aF as L,bb as F,u as z,A as R,_ as N,k as U,B as Y,F as J,a4 as V,I as X,V as Q,a6 as W}from"./index-d6d2a33a.js";import{_ as q}from"./u-loading.d153dd1a.js";import{_ as D}from"./uni-file-picker.87d7f36a.js";import{_ as G}from"./u-input.e3cf3beb.js";import{u as H}from"./index.3dd6f2ef.js";import{_ as Z}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as K}from"./l-painter-image.027bd37e.js";import{a as $,b as tt,_ as et,c as rt}from"./l-painter.cecf0579.js";import{_ as nt}from"./u-button.97a3d07f.js";import{_ as at}from"./u-popup.21776ef7.js";const ot=Z(n({__name:"chat-input",props:{modelValue:null,placeholder:{default:"请输入问题"},loading:{type:Boolean,default:!1},showManual:{type:Boolean,default:!1},showStop:{type:Boolean},showContinue:{type:Boolean,default:!1},btnColor:{default:"#fff"},safeAreaInsetBottom:{type:Boolean,default:!1},filePlugin:{default:()=>({})},showFileUpload:{type:Boolean,default:!1}},emits:["clear","pause","continue","focus","update:modelValue","update:filePlugin","send"],setup(t,{emit:e}){const n=t,A=a({get:()=>n.modelValue,set(t){e("update:modelValue",t)}}),_=o(),E=H(n,"filePlugin",e),T=i(!1),O=async t=>{var e;console.log(t),T.value=!0,null==(e=_.value)||e.clearFiles();const[r]=t.tempFiles;try{const t=await b("image",{filePath:r.url,name:"file",header:{}});E.value.url=t.uri,E.value.name=t.name}finally{T.value=!1}};return(n,a)=>{const o=s(l("u-icon"),r),i=k,b=P,C=S,M=s(l("u-loading"),q),j=s(l("uni-file-picker"),D),B=s(l("u-input"),G);return u(),c(i,{class:"send-area"},{default:f((()=>[p(i,{class:d([t.safeAreaInsetBottom?"safe-area-inset-bottom":""])},{default:f((()=>[p(i,{class:"float-btn"},{default:f((()=>[(void 0!==t.showStop?t.showStop:t.loading)?(u(),c(i,{key:0,class:"px-[20rpx] py-[10rpx] text-xs flex items-center",onClick:a[0]||(a[0]=t=>e("pause"))},{default:f((()=>[p(o,{name:"pause-circle",class:"mr-[8rpx]",size:"36"}),h(" 停止 ")])),_:1})):v("v-if",!0),!t.loading&&t.showContinue?(u(),c(i,{key:1,class:"px-[20rpx] py-[10rpx] text-xs flex items-center",onClick:a[1]||(a[1]=t=>e("continue"))},{default:f((()=>[p(o,{name:"play-circle",class:"mr-[8rpx]",size:"36"}),h(" 继续 ")])),_:1})):v("v-if",!0)])),_:1}),m(E).url?(u(),c(i,{key:0,class:"flex mb-[20rpx]"},{default:f((()=>[p(i,{class:"flex bg-page p-[20rpx] rounded-[16rpx] items-center"},{default:f((()=>[p(b,{src:m(E).url,class:"w-[60rpx] h-[60rpx] flex-none"},null,8,["src"]),p(C,{class:"line-clamp-2 ml-[20rpx] flex-1 min-w-0",style:{"word-break":"break-word"}},{default:f((()=>[h(g(m(E).name),1)])),_:1}),p(i,{class:"pl-[20rpx] flex"},{default:f((()=>[p(o,{name:"close-circle",size:38,onClick:a[2]||(a[2]=t=>m(E).url="")})])),_:1})])),_:1})])),_:1})):v("v-if",!0),p(i,{class:"flex flex-wrap gap-3 pb-1"},{default:f((()=>[x(n.$slots,"file-list",{},void 0,!0)])),_:3}),p(i,{class:"mb-[20rpx] flex items-center"},{default:f((()=>[p(i,{class:"flex-1 min-w-0 mr-[20rpx]"},{default:f((()=>[x(n.$slots,"actions",{},void 0,!0)])),_:3}),p(i,{class:"mr-[20rpx]"},{default:f((()=>[t.showFileUpload?(u(),c(j,{key:0,ref_key:"filePickerRef",ref:_,limit:1,fileMediatype:"image",onSelect:O,mode:"list","list-styles":{display:"none"},"auto-upload":!1},{default:f((()=>[p(i,{class:"text-sm text-primary flex items-center bg-[#ECF6FF] py-[10rpx] px-[18rpx] rounded-full"},{default:f((()=>[T.value?(u(),c(M,{key:0,mode:"flower",class:"mr-[4rpx]",size:"28"})):(u(),c(o,{key:1,name:"arrow-upward",class:"mr-[4rpx]",size:"28"})),h(" 图片 ")])),_:1})])),_:1},512)):v("v-if",!0)])),_:1}),p(i,{class:"text-sm text-primary flex text-content items-center bg-[#ECF6FF] py-[10rpx] px-[18rpx] rounded-full",onClick:a[3]||(a[3]=t=>e("clear"))},{default:f((()=>[p(o,{name:"trash",class:"mr-[4rpx]",size:"28"}),h(" 清空 ")])),_:1})])),_:3}),p(i,{class:"send-area__content border-[#DCDFE6] border border-solid rounded-[22px]"},{default:f((()=>[p(i,{class:"flex-1 min-w-0 relative"},{default:f((()=>[p(B,{type:"textarea",modelValue:m(A),"onUpdate:modelValue":a[4]||(a[4]=t=>y(A)?A.value=t:null),placeholder:t.placeholder,maxlength:"-1",height:30,"auto-height":!0,"confirm-type":"send","adjust-position":!1,fixed:!1,"custom-style":{background:"white",maxHeight:"174rpx"},"adjust-keyboard-to":"bottom",onFocus:a[5]||(a[5]=t=>e("focus"))},null,8,["modelValue","placeholder"])])),_:1}),p(i,{class:"ml-[20rpx] h-[65rpx]"},{default:f((()=>[p(i,null,{default:f((()=>[v('                    v-if="userInput"'),p(b,{class:"w-[100rpx] h-[65rpx]",src:"data:image/png;base64,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",onClick:a[6]||(a[6]=w((t=>e("send",m(A))),["stop"]))}),v("                    loading")])),_:1})])),_:1})])),_:1})])),_:3},8,["class"])])),_:3})}}}),[["__scopeId","data-v-2fadb237"]]),it={zIndex:{type:Number,default:9},rotate:{type:Number,default:-22},width:Number,height:Number,image:String,content:[String,Array],font:{type:Object},gap:{type:Array,default:()=>[30,30]},offset:Array,fullScreen:Boolean,baseSize:{type:Number,default:2},fontGap:{type:Number,default:3}};function st(t){return Object.keys(t).map((e=>`${function(t){return t.replace(/([A-Z])/g,"-$1").toLowerCase()}(e)}: ${t[e]};`)).join(" ")}const{pixelRatio:lt,platform:ut}=A(),ct=_("createOffscreenCanvas")&&Boolean(uni.createOffscreenCanvas)&&!/window|mac/.test(ut);function ft(t,e,r={}){let n;const a="undefined"!=typeof window&&"MutationObserver"in window,o=()=>{n&&(n.disconnect(),n=void 0)},i=C(t,(t=>{o(),a&&window&&t&&(n=new MutationObserver(e),n.observe(t.$el?t.$el:t,r))}),{immediate:!0}),s=()=>{o(),i()};var l;return l=s,M()&&j(l),{isSupported:a,stop:s}}function pt(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */
pt=function(){return t};var t={},e=Object.prototype,r=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(_){s=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var a,o,i,s,l=Object.create((e&&e.prototype instanceof f?e:f).prototype),p=new P(n||[]);return l._invoke=(a=t,o=r,i=p,s="suspendedStart",function(t,e){if("executing"===s)throw Error("Generator is already running");if("completed"===s){if("throw"===t)throw e;return{value:void 0,done:!0}}for(i.method=t,i.arg=e;;){var r=i.delegate;if(r){var n=w(r,i);if(n){if(n===c)continue;return n}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===s)throw s="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);s="executing";var l=u(a,o,i);if("normal"===l.type){if(s=i.done?"completed":"suspendedYield",l.arg===c)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(s="completed",i.method="throw",i.arg=l.arg)}}),l}function u(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(n){return{type:"throw",arg:n}}}t.wrap=l;var c={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var v=Object.getPrototypeOf,m=v&&v(v(S([])));m&&m!==e&&r.call(m,a)&&(h=m);var g=d.prototype=f.prototype=Object.create(h);function x(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}))}))}function y(t,e){function n(a,o,i,s){var l=u(t[a],t,o);if("throw"!==l.type){var c=l.arg,f=c.value;return f&&"object"==typeof f&&r.call(f,"__await")?e.resolve(f.__await).then((function(t){n("next",t,i,s)}),(function(t){n("throw",t,i,s)})):e.resolve(f).then((function(t){c.value=t,i(c)}),(function(t){return n("throw",t,i,s)}))}s(l.arg)}var a;this._invoke=function(t,r){function o(){return new e((function(e,a){n(t,r,e,a)}))}return a=a?a.then(o,o):o()}}function w(t,e){var r=t.iterator[e.method];if(void 0===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,w(t,e),"throw"===e.method))return c;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var n=u(r,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,c;var a=n.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,c):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,c)}function b(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function k(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(b,this),this.reset(!0)}function S(t){if(t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:A}}function A(){return{value:void 0,done:!0}}return p.prototype=d,s(g,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===p||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,d):(t.__proto__=d,s(t,i,"GeneratorFunction")),t.prototype=Object.create(g),t},t.awrap=function(t){return{__await:t}},x(y.prototype),s(y.prototype,o,(function(){return this})),t.AsyncIterator=y,t.async=function(e,r,n,a,o){void 0===o&&(o=Promise);var i=new y(l(e,r,n,a),o);return t.isGeneratorFunction(r)?i:i.next().then((function(t){return t.done?t.value:i.next()}))},x(g),s(g,i,"Generator"),s(g,a,(function(){return this})),s(g,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=S,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return i.type="throw",i.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(this.prev>=o.tryLoc){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(o.catchLoc>this.prev)return n(o.catchLoc,!0);if(o.finallyLoc>this.prev)return n(o.finallyLoc)}else if(s){if(o.catchLoc>this.prev)return n(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(o.finallyLoc>this.prev)return n(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(this.prev>=a.tryLoc&&r.call(a,"finallyLoc")&&a.finallyLoc>this.prev){var o=a;break}}o&&("break"===t||"continue"===t)&&e>=o.tryLoc&&o.finallyLoc>=e&&(o=null);var i=o?o.completion:{};return i.type=t,i.arg=e,o?(this.method="next",this.next=o.finallyLoc,c):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),c},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),k(r),c}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var a=n.arg;k(r)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:S(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),c}},t}function dt(t,e,r,n,a,o,i){try{var s=t[o](i),l=s.value}catch(u){return void r(u)}s.done?e(l):Promise.resolve(l).then(n,a)}function ht(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(t);!(i=(n=r.next()).done)&&(o.push(n.value),!e||o.length!==e);i=!0);}catch(l){s=!0,a=l}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(t,e)||vt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function vt(t,e){if(t){if("string"==typeof t)return mt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?mt(t,e):void 0}}function mt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);e>r;r++)n[r]=t[r];return n}var gt={color:"rgba(0,0,0,.15)",fontSize:16,fontWeight:"normal",fontStyle:"normal",fontFamily:"sans-serif"},xt=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")})(this,t),this.canvas=null,this.ctx=null,this.options={pixelRatio:1},this.props={rotate:-22,baseSize:2,fontGap:3,gap:[30,30]},this.gap={gapX:0,gapY:0,gapXCenter:0,gapYCenter:0,offsetLeft:0,offsetTop:0},this.font=gt,this.appendWatermark=function(){},this.createImage=function(){return new Image},e?this.canvas=e:"undefined"!=typeof window&&(this.canvas=document.createElement("canvas"));var n=r.appendWatermark,a=r.createImage;n&&(this.appendWatermark=n),a&&(this.createImage=a),Object.assign(this.options,r)}var e,r,n,a;return e=t,r=[{key:"rotateWatermark",value:function(t,e,r,n){t.translate(e,r),t.rotate(Math.PI/180*Number(n)),t.translate(-e,-r)}},{key:"calcFont",value:function(){Object.assign(this.font,gt,this.props.font||{})}},{key:"calcGap",value:function(){var t,e,r=this.props,n=r.gap,a=r.offset,o=ht(void 0===n?[20,20]:n,2),i=o[0],s=o[1],l=i/2,u=s/2,c=null!==(t=null==a?void 0:a[0])&&void 0!==t?t:l,f=null!==(e=null==a?void 0:a[1])&&void 0!==e?e:u;this.gap={gapX:i,gapY:s,gapXCenter:l,gapYCenter:u,offsetLeft:c,offsetTop:f}}},{key:"getPixelRatio",value:function(){return this.options.pixelRatio||("undefined"!=typeof window?window.devicePixelRatio:1)}},{key:"calcRotateMarkSize",value:function(t,e){var r=this.props.rotate;if(!r)return[t,e];var n=r*Math.PI/180,a=-t/2*Math.cos(n)+e/2*Math.sin(n),o=-t/2*Math.sin(n)-e/2*Math.cos(n),i=t/2*Math.cos(n)+e/2*Math.sin(n),s=t/2*Math.sin(n)-e/2*Math.cos(n),l=t/2*Math.cos(n)-e/2*Math.sin(n),u=t/2*Math.sin(n)+e/2*Math.cos(n),c=-t/2*Math.cos(n)-e/2*Math.sin(n),f=-t/2*Math.sin(n)+e/2*Math.cos(n);return[Math.round(Math.max(a,i,l,c)-Math.min(a,i,l,c)),Math.round(Math.max(o,s,u,f)-Math.min(o,s,u,f))]}},{key:"getMarkSize",value:function(t){var e=this.props,r=e.width,n=e.height,a=e.content,o=e.fontGap,i=this.font,s=i.fontSize,l=i.fontFamily,u=120,c=64;if(!e.image&&t.measureText){t.font="".concat(Number(s),"px ").concat(l);var f=Array.isArray(a)?a:[a],p=f.map((function(e){return t.measureText(e).width}));u=Math.ceil(Math.max.apply(Math,function(t){return function(t){if(Array.isArray(t))return mt(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||vt(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(p)));var d=ht(this.calcRotateMarkSize(u,c=Number(s)*f.length+(f.length-1)*o),2);u=d[0],c=d[1]}return[r||u,n||c]}},{key:"fillTexts",value:function(t,e,r,n,a){var o=this.getPixelRatio(),i=this.font,s=i.fontFamily,l=i.fontWeight,u=i.fontStyle,c=i.color,f=this.props,p=f.content,d=f.fontGap,h=Number(i.fontSize)*o;t.font="".concat(u," normal ").concat(l," ").concat(h,"px/").concat(a,"px ").concat(s),t.fillStyle=c,t.textAlign="center",t.textBaseline="top",t.translate(n/2,0);var v=Array.isArray(p)?p:[p];null==v||v.forEach((function(n,a){t.fillText(null!=n?n:"",e,r+a*(h+d*o))}))}},{key:"toDataURL",value:function(t){try{var e=t.toDataURL();return"string"==typeof e?Promise.resolve(e):e}catch(r){return console.warn(r),Promise.reject(r)}}},{key:"drawText",value:function(t,e,r,n,a,o,i,s,l,u,c){var f=this,p=this.props.rotate;this.fillTexts(e,r,n,a,o),e.restore(),this.rotateWatermark(e,i,s,p),this.fillTexts(e,l,u,a,o),this.draw(e),this.toDataURL(t).then((function(t){return f.appendWatermark(t,c,f.gap)}))}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};t.draw?t.draw(!1,e):e()}},{key:"render",value:(n=pt().mark((function t(e){var r,n,a,o,i,s,l,u,c,f,p,d,h,v,m,g,x,y,w,b,k,P,S,A,_,E,T,O=this;return pt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Object.assign(this.props,e||{}),this.calcFont(),this.calcGap(),r=this.canvas){t.next=6;break}return t.abrupt("return");case 6:if(n=r.getContext("2d"),this.ctx=n,!n){t.next=33;break}if(a=this.getPixelRatio(),o=this.getMarkSize(n),i=ht(o,2),d=(p=this.props).rotate,h=p.image,g=((f=(u=this.gap).gapY)+(l=i[1]))*a,r.width=(m=((c=u.gapX)+(s=i[0]))*a)*(v=p.baseSize),r.height=g*v,!("draw"in n)){t.next=20;break}return t.next=20,new Promise((function(t){return setTimeout(t,100)}));case 20:S=(x=c*a/2)+m,A=(y=f*a/2)+g,_=(k=((w=s*a)+c*a)/2)+m,E=(P=((b=l*a)+f*a)/2)+g,n.save(),this.rotateWatermark(n,k,P,d),h?((T=this.createImage(this.canvas)).onload=function(){var t="path"in T?T.path:T;n.drawImage(t,x,y,w,b),n.restore(),O.rotateWatermark(n,_,E,d),n.drawImage(t,S,A,w,b),O.draw(n,(function(){return O.toDataURL(r).then((function(t){return O.appendWatermark(t,s,O.gap)}))}))},T.onerror=function(){return O.drawText(r,n,x,y,w,b,_,E,S,A,s)},T.crossOrigin="anonymous",T.referrerPolicy="no-referrer",T.src=h):this.drawText(r,n,x,y,w,b,_,E,S,A,s);case 33:case"end":return t.stop()}}),t,this)})),a=function(){var t=this,e=arguments;return new Promise((function(r,a){var o=n.apply(t,e);function i(t){dt(o,r,a,i,s,"next",t)}function s(t){dt(o,r,a,i,s,"throw",t)}i(void 0)}))},function(t){return a.apply(this,arguments)})}],r&&function(t,e){for(var r=0;e.length>r;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function yt(t){if(function(t){return null!=t}(t))return function(t){return/^(-)?\d+(\.\d+)?$/.test(t)}(t=String(t))?`${t}px`:t}const wt="undefined"!=typeof window;let bt=class{constructor(){e(this,"currentSrc",null),e(this,"naturalHeight",0),e(this,"naturalWidth",0),e(this,"width",0),e(this,"height",0),e(this,"tagName","IMG"),e(this,"path",""),e(this,"crossOrigin",""),e(this,"referrerPolicy",""),e(this,"onload",(()=>{})),e(this,"onerror",(()=>{})),e(this,"complete",!1)}set src(t){if(console.log("src",t),!t)return this.onerror();t=t.replace(/^@\//,"/"),this.currentSrc=t,B({src:t,success:t=>{this.complete=!0,this.path=t.path,this.naturalWidth=this.width=t.width,this.naturalHeight=this.height=t.height,this.onload()},fail:()=>{this.onerror()}})}get src(){return this.currentSrc}};function kt(t){return t&&t.createImage?t.createImage():"canvas"==this.tagName&&!("toBlob"in this)||t&&!("toBlob"in t)?new bt:wt?new window.Image:new bt}const Pt=Z(n({name:"l-watermark",props:it,options:{virtualHost:!0},externalClasses:["class"],setup(t){const e=F(),r=T({waterUrl:"",markWidth:0,markLeft:0,markTop:0,canvasShow:!0}),n=function(t,e={}){const{context:r,width:n=300,height:a=150}=e;if("undefined"!=typeof document)return document.createElement("canvas");if(ct)return uni.createOffscreenCanvas({type:"2d",width:n,height:a});{const e=E(t,r);return T({getContext(t){if("2d"==t)return e},toDataURL:()=>new Promise(((n,a)=>{const o="toTempFilePath";o in e?e[o]({success(t){n(t.filePath)},fail(t){a(t)}}):O({canvasId:t,success(t){n(t.tempFilePath)},fail(t){a(t)}},r)})),width:300,height:150})}}("l-watermark",{context:e});a((()=>st({width:yt(n.width),height:yt(n.height)})));const o=a((()=>({zIndex:t.zIndex,position:t.fullScreen?"fixed":"absolute",left:r.markLeft,top:r.markTop,right:0,bottom:0,pointerEvents:"none",backgroundRepeat:"repeat",backgroundSize:`${r.markWidth}px`,backgroundImage:`url('${r.waterUrl}')`}))),s=i(!1),l=i(null),u=i();ft(l,(t=>{s.value||t.forEach((t=>{((t,e)=>{let r=!1;return t.removedNodes.length&&(r=Array.from(t.removedNodes).some((t=>t===e))),"attributes"===t.type&&t.target===e&&(r=!0),r})(t,u.value)&&(u.value&&(u.value.remove(),u.value=void 0),p())}))}),{childList:!0,attributes:!0,subtree:!0});const c=(e,n,a={})=>{var i;r.waterUrl=e;const{gapX:c,offsetLeft:f,gapXCenter:p,gapYCenter:d,offsetTop:h}=a;r.markWidth=(c+n)*t.baseSize,r.markLeft=f-p,r.markTop=h-d,l.value&&u.value&&(s.value=!0,u.value.setAttribute("style",st(o.value)),null==(i=l.value.$el)||i.append(u.value),setTimeout((()=>{s.value=!1})))};let f=null;const p=()=>{f||(f=new xt(n,{createImage:kt,appendWatermark:c,pixelRatio:void 0})),u.value||(u.value=document.createElement("div")),f&&f.render(t)},d=C(t,p);return I(p),L((()=>{d&&d(),r.canvasShow=!1})),{store:r,styles:o,containerRef:l}}}),[["render",function(t,e,r,n,a,o){const i=k;return u(),c(i,{class:"l-watermark class",ref:"containerRef"},{default:f((()=>[x(t.$slots,"default",{},void 0,!0)])),_:3},512)}],["__scopeId","data-v-667cfb41"]]),St=n({__name:"dialog-poster",setup(t,{expose:e}){const{getImageUrl:r,config:n}=z(),o=R(),{userInfo:d}=N(o),g=i(),x=T({showPoster:!1,title:"",content:"",mp_qr_code:"",invite_link:"",options:{data:"邀请您前来体验",default:1,poster:1,defaultUrl1:"",defaultUrl2:"",posterUrl:"",showData:"1"},poster_url:""}),y=i(""),w=a((()=>{const t=null==x?void 0:x.options;return t?(console.log(t.bgColor),t.bgColor):""})),b=()=>{uni.$u.toast("请长按图片保存")},P=async()=>{var t;try{null==(t=g.value)||t.canvasToTempFilePathSync({fileType:"png",pathType:"base64",quality:1,success:t=>{console.log("生产结果",t),W(),x.showPoster=!0,x.poster_url=t.tempFilePath},fail:t=>{console.log(t),W(),uni.$u.toast("调用海报错误",t)}})}catch(e){W(),uni.$u.toast("调用海报错误",e)}};return e({handleDrawCanvas:P,initPosterData:async t=>{var e,n;await V({title:"生成中"});try{(null==(e=null==d?void 0:d.value)?void 0:e.sn)||await o.getUser();const{data:a}=await X({id:12}),i=window.origin;x.invite_link=`${i}/mobile/pages/index/index?user_sn=${d.value.sn}`,x.title=t.title.replace(/\n/g,""),x.content=t.content,x.options=null==(n=JSON.parse(a)[0])?void 0:n.content,(()=>{const t=null==x?void 0:x.options;1==t.default&&1==t.poster?y.value=r(t.defaultUrl1):1==t.default&&2==t.poster?y.value=r(null==x?void 0:x.options.defaultUrl2):2==t.default&&(y.value=r(t.posterUrl))})(),await Q(),await P()}catch(a){W(),uni.$u.toast(a||"请求生产海报失败"),console.log("请求生产海报失败",a)}}}),(t,e)=>{const r=s(l("l-painter-image"),K),n=s(l("l-painter-view"),$),a=s(l("l-painter-text"),tt),o=s(l("l-painter-qrcode"),et),i=s(l("l-painter"),rt),P=s(l("u-button"),nt),S=k,A=s(l("u-popup"),at);return u(),U(J,null,[p(i,{ref_key:"painterRef",ref:g,isCanvasToTempFilePath:!1,css:"width: 640rpx;","custom-style":"position: fixed; left: 200%;"},{default:f((()=>[p(n,{css:`\n            border-radius: 14rpx;\n            overflow: hidden;\n            background-color: ${m(w)};\n            `},{default:f((()=>[p(n,{css:"\n                display: block;\n                left: 0;\n                top: 0;\n                position: absolute;\n                width: 100%;\n                z-index: -1;\n                "},{default:f((()=>[p(r,{src:y.value,css:"width: 100%;"},null,8,["src"])])),_:1}),v("  主要视图  "),p(n,{css:"\n                box-sizing: border-box;\n                border-radius: 14rpx;\n                width: 100%;\n                height: 100%;\n                padding: 0 40rpx;\n            "},{default:f((()=>[v("  中部内容区域  "),p(n,{css:"\n                    box-sizing: border-box;\n                    padding: 30rpx;\n                    border-radius: 20rpx;\n                    background: #fff;\n                    margin-top: 270rpx;\n                    display: block;\n                "},{default:f((()=>[p(n,{css:"\n                            box-sizing: border-box;\n                            display: flex;\n                            justify-content: flex-end;\n                        "},{default:f((()=>[p(a,{text:null==x?void 0:x.title,css:"\n                                line-clamp: 2;\n                                background-color: #066cff;\n                                border-radius: 16rpx 0 16rpx 16rpx;\n                                padding: 20rpx 20rpx;\n                                color: #ffffff;\n                                font-size: 26rpx;\n                            "},null,8,["text"])])),_:1}),p(n,{css:"\n                            box-sizing: border-box;\n                        "},{default:f((()=>{var t,e;return[p(a,{text:null==x?void 0:x.content,css:`\n                                color: #333333;\n                                font-size: 26rpx;\n                                padding: 20rpx;\n                                margin-top: 20rpx;\n                                background-color: #f0f5fe;\n                                border-radius: 0 16rpx 16rpx 16rpx;\n                                ${1==(null==(t=null==x?void 0:x.options)?void 0:t.showContentType)?`line-clamp: ${null==(e=null==x?void 0:x.options)?void 0:e.contentNum}`:""}\n                            `},null,8,["text","css"])]})),_:1})])),_:1}),v("  底部信息区域  "),p(n,{css:"\n                    display: block;\n                    margin-top: 30rpx;\n                    padding-bottom: 40rpx;\n                "},{default:f((()=>[v("  个人信息区域  "),p(n,{css:"display: inline-block; width: 380rpx; margin-top: 40rpx;"},{default:f((()=>{var t;return[p(r,{src:null==(t=m(d))?void 0:t.avatar,css:"width: 110rpx; height: 110rpx; border-radius: 50%;display: inline-block;"},null,8,["src"]),p(n,{css:"\n                            width: 270rpx;\n                            height: 110rpx;\n                            vertical-align: middle;\n                            margin-top: 18rpx;\n                            padding-left: 20rpx;\n                            display: inline-block;\n                            box-sizing: border-box;\n                       "},{default:f((()=>{var t,e,r,n,o;return[p(a,{text:null==(t=m(d))?void 0:t.nickname,css:`color: ${null==(e=null==x?void 0:x.options)?void 0:e.textColor}; font-size: 26rpx;line-clamp:1;width: 200rpx;`},null,8,["text","css"]),(null==(r=null==x?void 0:x.options)?void 0:r.showData)?(u(),c(a,{key:0,text:null==(n=null==x?void 0:x.options)?void 0:n.data,css:`color: ${null==(o=null==x?void 0:x.options)?void 0:o.textColor}; font-size: 26rpx;line-clamp:1;width: 200rpx;`},null,8,["text","css"])):v("v-if",!0)]})),_:1})]})),_:1}),v("  扫码区域  "),p(n,{css:"display: inline-block;width: 180rpx; text-align: center;"},{default:f((()=>{var t;return[v("  H5二维码  "),p(o,{css:"\n                            box-sizing: border-box;\n                            width: 170rpx;\n                            height: 170rpx;\n                            padding: 10rpx;\n                            border-radius: 8rpx;\n                            background-color: #FFFFFF;\n                        ",text:x.invite_link},null,8,["text"]),v("  小程序二维码  "),p(a,{text:"长按识别二维码",css:`\n                            display: block;\n                            color: ${null==(t=null==x?void 0:x.options)?void 0:t.textColor}; \n                            font-size: 24rpx;\n                            text-align: center;\n                            margin-top: 4rpx;\n                        `},null,8,["css"])]})),_:1})])),_:1})])),_:1})])),_:1},8,["css"])])),_:1},512),v("  弹窗海报  "),p(A,{modelValue:x.showPoster,"onUpdate:modelValue":e[0]||(e[0]=t=>x.showPoster=t),mode:"center",closeable:!0,closeIconColor:"#FFFFFF","safe-area-inset-bottom":!0,customStyle:{background:"none"}},{default:f((()=>[p(S,{class:"pb-[30rpx]"},{default:f((()=>[Y("img",{style:{width:"640rpx"},src:x.poster_url},null,8,["src"]),p(S,{class:"mt-[20rpx]"},{default:f((()=>[p(P,{type:"primary",shape:"circle",size:"default",customStyle:{padding:"0 30rpx",height:"82rpx"},onClick:b},{default:f((()=>[h(" 长按保存图片到相册 ")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}});export{St as _,ot as a,Pt as b};
