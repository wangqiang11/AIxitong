import{d as e,u as a,A as t,J as l,s,C as i,K as o,$ as r,aL as n,U as u,aF as c,o as d,k as p,b as v,c as m,w as f,g as y,f as g,t as h,e as x,aH as w,aI as _,F as A,l as b,p as k,m as j,n as C,z as R,ae as z,r as T,a as F,i as D,j as I,aE as B,D as E,ax as P,aG as U,V as J}from"./index-d6d2a33a.js";import{_ as V}from"./page-meta.d751427a.js";import{_ as H}from"./chat-record-item.e19df2e0.js";import{_ as L}from"./z-paging.6c8c2edf.js";import{_ as Q}from"./u-icon.992584aa.js";import{_ as S}from"./u-button.97a3d07f.js";import{_ as q}from"./u-input.e3cf3beb.js";import{_ as $}from"./dragon-button.79847554.js";import{_ as G,a as M,b as O}from"./icon_clear.1440a0f3.js";import{f as N,v as W,h as K,i as X,r as Y,j as Z}from"./robot.627d8f7e.js";import{u as ee}from"./useLockFn.3b1f86f9.js";import{u as ae}from"./text-item.bd4ac6fd.js";import{u as te,a as le}from"./useRecorder.91513557.js";import{u as se}from"./useAudio.deb09cdd.js";import{_ as ie}from"./u-empty.a728d8d9.js";import{_ as oe}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-image.9574760c.js";import"./u-tag.fd761889.js";import"./u-collapse.5c69f838.js";import"./u-loading.d153dd1a.js";import"./icon_copy.bacd4068.js";import"./useCopy.4954d67d.js";import"./emitter.1571a5d9.js";import"./ua-markdown.e9ea1a15.js";import"./_commonjsHelpers.157f59fb.js";import"./katex.37f36714.js";import"./mp-html.318bb55d.js";import"./index.ccff8ee2.js";import"./icon_copy.36709540.js";import"./chat.d9a8f946.js";import"./howler.bdae6f69.js";import"./index.3dd6f2ef.js";import"./index.22b2ad12.js";const re=oe(e({__name:"digital_chat",setup(e){a();const oe=R(),re=z(),ne=t(),ue=l(),ce=s(!1),de=s([]),pe=i((()=>re.query.id)),ve=i((()=>re.query.squareId)),me=i((()=>re.query.cateId)),fe=s({}),ye=s(""),{isLock:ge,lockFn:he}=ee((async()=>{fe.value=await K({id:pe.value})})),xe=()=>{oe.navigateBack()},we=s(0),_e=o({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中...",5:"用户拒绝了录音权限，请检查设备权限后重新进入程序"}),Ae=l();let be=0;const ke=async(e,a)=>{var t,l;try{const{lists:l=[],count:s}=await N({category_id:me.value,square_id:ve.value,robot_id:pe.value,page_size:a/2,page_no:e});if(null==(t=Ae.value)||t.complete(l.reverse()),0===s?setTimeout((()=>{var e;null==(e=Ae.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{Re()}),100),3==we.value){const e=l[0];e&&e.id!==be&&(be=e.id,la(be))}}catch(s){null==(l=Ae.value)||l.complete(!1)}},{lockFn:je}=ee((async()=>{var e;if(!ne.isLogin)return Ce();(await u({title:"温馨提示",content:"确定清空对话？"})).cancel||(Fe(),await X({category_id:me.value,square_id:ve.value,robot_id:pe.value}),null==(e=Ae.value)||e.reload())})),Ce=()=>{oe.navigateTo({path:"/pages/login/login"})},Re=async()=>{var e;null==(e=Ae.value)||e.scrollToBottom(!1)},ze=s(!1);let Te=null;const Fe=()=>{null==Te||Te.cancel(),setTimeout((()=>{ye.value=""}))},De=l(),Ie=e=>{we.value=e},Be=s({}),Ee=s(""),{pauseAll:Pe}=ae(),{lockFn:Ue}=ee((async(e,a="text")=>{if(ce.value=!1,!ne.isLogin)return Ce();if(ze.value)return;const t=e||ye.value;if(t){Ae.value.addChatRecordData({type:1,content:t}),Be.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},Ae.value.addChatRecordData(Be.value),Ee.value=ye.value,ye.value="";try{ze.value=!0,Ie(3),await Y({square_id:ve.value,cate_id:me.value,robot_id:pe.value,question:t,stream:!0},{onstart(e){Te=e,Pe(),ye.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t;if(""!==e)try{const s=JSON.parse(e),{object:i,choices:o,error:r}=s;if(r){Ie(1);const{message:e,code:a}=r;return e&&uni.$u.toast(e),void de.value.splice(0,2)}const n=null==(t=null==(a=o[0])?void 0:a.delta)?void 0:t.content;switch(i){case"chat":Be.value.content||(Be.value.content=""),Be.value.content+=n;break;case"reasoning":Be.value.content||(Be.value.content=""),Be.value.reasoning+=n;break;case"image":case"video":case"file":{const e=`${i}s`;try{const a=JSON.parse(n);Be.value[e]=a}catch(l){console.error(l)}}}}catch(s){}}))},onclose(){ze.value=!1,ne.getUser(),setTimeout((()=>{var e;null==(e=Ae.value)||e.reload()}),1e3)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==U.ABORT&&de.value.splice(0,2),"text"==a&&(ye.value=Ee.value),ze.value=!1}}})),Je=()=>{if(!ne.isLogin)return Ce();Re()},Ve=s(),He=s(!0),Le=s(!1),Qe=s(0),Se=s(!1),qe=s(0),$e=o({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:Ge,stopRender:Me,draw:Oe}=te($e),{start:Ne,stop:We,isRecording:Ke,authorize:Xe,close:Ye,isOpen:Ze}=le({onstart(){Ie(2),aa(),clearTimeout(Ve.value),Se.value=!1,Qe.value=Date.now()},async onstop(e){if(Me(),Se.value=!1,console.log(Le.value,"isAutoStop"),Le.value){Le.value=!1,Ie(3);try{const a=await Z(e.tempFilePath);if(!a.text)return void(He.value?sa():Ie(1));Ue(a.text,"voice")}catch(a){Ie(1)}}else Ie(1)},ondata(e){var a;const t=Date.now();Se.value&&Ge(e),e.powerLevel>=10&&(clearTimeout(qe.value),we.value=2,Se.value=!0,Qe.value=t,qe.value=setTimeout((()=>{Le.value=!0,clearTimeout(Ve.value),aa(),We()}),1500)),t-Qe.value>=1e3*(null==(a=fe.value.digital)?void 0:a.idle_time)&&(Se.value||(ua(),We()))}}),{play:ea,pause:aa,isPlaying:ta}=se({onstart(){we.value=4,na.value&&(na.value=!1)},onstop(){Ie(2),He.value?sa():Ie(1)},onerror(){Ie(1)}}),la=async e=>{const a=await oa({type:2,record_id:e});ea(a)},sa=async()=>{Ke.value||(await Xe(),Ne())},ia=async()=>{4!=we.value?3!=we.value&&(Ke.value?(He.value=!1,We(),Ie(1)):(He.value=!0,sa())):aa()},oa=async e=>{try{const{url:a}=await W(e);return a}catch(a){return Ie(1),Promise.reject()}},ra=s(""),na=s(!1),ua=async()=>{if(!fe.value.is_digital||!fe.value.digital_id)return Promise.reject();if(ra.value||(ra.value=await oa({type:3,record_id:fe.value.id})),!ra.value)return Promise.reject();na.value=!0;const e=Date.now();Ae.value.addChatRecordData({type:2,typing:!1,content:fe.value.digital.idle_reply,key:e}),await J(),Re(),ea(ra.value)};let ca=null,da=null;const pa=async()=>{null==ca||ca.play(),null==da||da.play();try{await Xe(),sa()}catch(e){"无法录音:用户拒绝了录音权限"==e&&(we.value=5),await Xe()}finally{await Xe(),sa()}};return r((async()=>{var e;await he(),null==(e=Ae.value)||e.reload(),He.value=!0,ca=n("stay-video"),da=n("talk-video"),await u({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"}),await pa()})),c((()=>{Fe(),aa(),We()})),(e,a)=>{const t=T(F("page-meta"),V),l=D,s=I,i=B,o=T(F("chat-record-item"),H),r=T(F("z-paging"),L),n=T(F("u-icon"),Q),u=T(F("u-button"),S),c=E,R=T(F("u-input"),q),z=P,U=T(F("dragon-button"),$);return d(),p(A,null,[v(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),0==we.value?(d(),m(s,{key:0,class:"h-full flex justify-center items-center fixed inset-0 w-full z-[9999] bg-white"},{default:f((()=>[v(l,{src:G,class:"w-[600rpx]",mode:"widthFix"})])),_:1})):y("v-if",!0),5==we.value?(d(),m(s,{key:1,class:"h-full flex justify-center items-center fixed inset-0 w-full z-[9999] bg-white"},{default:f((()=>[v(s,null,{default:f((()=>[v(ie,{mode:"permission",text:" "}),v(s,{class:"text-xs text-muted text-center",style:{width:"400rpx"}},{default:f((()=>[g(h(_e[we.value]),1)])),_:1})])),_:1})])),_:1})):y("v-if",!0),v(s,{class:"h-full container-wrap"},{default:f((()=>[fe.value.digital_id||x(ge)?(d(),m(s,{key:0,class:"h-full relative py-[40rpx] px-[20rpx]",style:C({background:fe.value.digital_bg})},{default:f((()=>{var t,T;return[w(v(i,{ref_key:"videoRef",ref:De,id:"stay-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(t=fe.value.digital)?void 0:t.vertical_stay_video,onLoadedmetadata:pa},null,8,["src"]),[[_,4!==we.value]]),w(v(i,{ref_key:"videoRef",ref:De,id:"talk-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(T=fe.value.digital)?void 0:T.vertical_talk_video},null,8,["src"]),[[_,4===we.value]]),v(s,{class:"h-full relative z-10 flex flex-col top-0"},{default:f((()=>[v(s,{class:"flex text-white items-center"},{default:f((()=>[v(s,{class:"flex-1 min-w-0 line-clamp-1 text-xl font-medium"},{default:f((()=>[g(h(fe.value.name),1)])),_:1}),v(s,{class:"bg-[rgba(51,51,51,0.5)] px-[20rpx] py-[10rpx] rounded-full flex items-center",onClick:xe},{default:f((()=>[v(l,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAD7SURBVFiF7ZZRDcIwFEXvIwiYhEpAwiQgAQs4QAIOwMFwMBxMwpCAg8PHOiALWwKjr3xwv5qm6T3Jdu+rgAA0+KsGggG1pFLSSdJVPgrR86hIc3AyvgtogWbhbTxQkRtAf4DsAMvUBsBa0tnMhhHf9geSxRBYxfsboBg7lLQHgN0khEcRTUJ4NeEohGcVP0FUWQAGEAdpRgzjBeUMlg0wq4hex+o9lTk/QQuEXD9hZx43vWP4MPcCGDX3AJg0Tw1A9+IeN1ficWxmF2Ar6WRmlwHcul+4xvAJoAXa7C+iP8DPAHxjsHwkAxpJK0lHR9+gbpTv+7Ko8VcFFDfbwDxYwdth8AAAAABJRU5ErkJggg==",class:"w-[32rpx] h-[32rpx]"}),v(s,{class:"ml-[15rpx]"},{default:f((()=>[g("退出")])),_:1})])),_:1})])),_:1}),v(s,{class:"flex-1 min-h-0 flex flex-col justify-end"},{default:f((()=>[v(r,{ref_key:"pagingRef",ref:Ae,modelValue:de.value,"onUpdate:modelValue":a[0]||(a[0]=e=>de.value=e),"use-chat-record-mode":"",auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"auto-adjust-position-when-chat":!1,"default-page-size":20,onQuery:ke,fixed:!1},{empty:f((()=>[])),default:f((()=>[v(s,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:ue},{default:f((()=>[(d(!0),p(A,null,b(de.value,((a,t)=>(d(),m(s,{key:`${a.id} + ${t} + ''`,style:{transform:"scaleY(-1)"}},{default:f((()=>[v(s,{class:"chat-record mt-[20rpx]"},{default:f((()=>[1==a.type?(d(),m(o,{key:0,type:"left",content:a.content,avatar:x(ne).userInfo.avatar,showCopyBtn:!1,bg:e.$theme.primaryColor,color:"#fff"},null,8,["content","avatar","bg"])):y("v-if",!0),2==a.type?(d(),m(o,{key:1,"record-id":a.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:a.content,loading:a.loading,avatar:fe.value.icons?fe.value.icons:fe.value.image,index:t,chatType:2,showCopyBtn:!1,images:a.images,files:a.files,videos:a.videos},null,8,["record-id","content","loading","avatar","index","images","files","videos"])):y("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"]),ze.value?(d(),m(s,{key:0,class:"flex justify-center items-center"},{default:f((()=>[v(u,{color:"#fff",shape:"circle",size:"medium",onClick:Fe},{default:f((()=>[v(n,{class:"mr-[10rpx]",name:"pause-circle",size:30}),g(" 停止 ")])),_:1})])),_:1})):y("v-if",!0),v(s,{class:"flex flex-col justify-center items-center text-white mt-[20rpx] text-xs"},{default:f((()=>[v(s,null,{default:f((()=>[g(h(_e[we.value]),1)])),_:1})])),_:1}),v(s,{class:"my-[20rpx]"},{default:f((()=>[v(c,{class:"w-full whitespace-nowrap","scroll-x":""},{default:f((()=>[(d(!0),p(A,null,b(fe.value.menus,((e,a)=>(d(),m(s,{class:"menus bg-white px-[30rpx] rounded-full mr-[20rpx] py-[12rpx] inline-block",key:a,onClick:a=>x(Ue)(e.keyword)},{default:f((()=>[g(h(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),v(s,{class:"send-area__content safe-area-inset-bottom"},{default:f((()=>[v(s,{class:"flex-1 min-w-0 relative"},{default:f((()=>[v(R,{modelValue:ye.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ye.value=e),placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",onFocus:Je},null,8,["modelValue"])])),_:1}),v(s,{class:"ml-[20rpx] mr-[-6rpx]"},{default:f((()=>[v(s,null,{default:f((()=>[v(u,{type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(we.value),onClick:a[2]||(a[2]=k((e=>x(Ue)(ye.value)),["stop"]))},{default:f((()=>[v(l,{src:M,class:"w-[50rpx] h-[50rpx]"})])),_:1},8,["custom-style","disabled"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),v(s,{class:"gradient-button z-10",onClick:x(je)},{default:f((()=>[v(l,{src:O,class:"w-[40rpx] h-[40rpx]"})])),_:1},8,["onClick"]),v(U,{size:120,xEdge:"10",yEdge:"100"},{default:f((()=>[v(s,{class:j(["recorder-btn",{"recorder-btn--stop":!x(Ke)&&!x(ta)}]),onClick:ia},{default:f((()=>[Se.value?(d(),m(z,{key:0,style:C({width:`${$e.width}px`,height:`${$e.height}px`}),width:$e.width*$e.scale,height:$e.height*$e.scale,"canvas-id":$e.id},null,8,["style","width","height","canvas-id"])):y("v-if",!0),x(Ke)&&!Se.value?(d(),m(n,{key:1,name:"mic",size:48})):x(ta)?(d(),m(n,{key:2,name:"pause-circle",size:60})):x(Ke)?y("v-if",!0):(d(),m(n,{key:3,name:"mic-off",size:48}))])),_:1},8,["class"])])),_:1})]})),_:1},8,["style"])):(d(),m(s,{key:1,class:"h-screen w-screen flex flex-col items-center justify-center"},{default:f((()=>[v(ie,{text:"该智能体暂未配置形象",mode:"page"})])),_:1}))])),_:1})],64)}}}),[["__scopeId","data-v-14bea39a"]]);export{re as default};
