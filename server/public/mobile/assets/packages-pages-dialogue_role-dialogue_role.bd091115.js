import{d as e,u as a,A as t,J as l,s as o,K as n,ay as s,aF as i,o as r,k as u,b as c,w as p,f as d,t as m,e as v,c as f,g,F as h,l as _,ae as y,z as w,r as x,a as j,j as k,p as b,aJ as C,U as T,aG as U,h as S}from"./index-d6d2a33a.js";import{_ as B}from"./page-meta.d751427a.js";import{_ as z}from"./u-icon.992584aa.js";import{_ as V}from"./chat-record-item.e19df2e0.js";import{_ as $,a as F,b as R}from"./dialog-poster.vue_vue_type_script_setup_true_lang.74c53633.js";import{_ as I}from"./z-paging.6c8c2edf.js";import{e as L,f as P,i as A}from"./chat.d9a8f946.js";import{b as D}from"./role.7efbb103.js";import{u as J}from"./useLockFn.3b1f86f9.js";import{u as O}from"./text-item.bd4ac6fd.js";import{_ as H}from"./model-picker.594cca17.js";import{_ as q}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-image.9574760c.js";import"./u-tag.fd761889.js";import"./useAudio.deb09cdd.js";import"./howler.bdae6f69.js";import"./_commonjsHelpers.157f59fb.js";import"./u-collapse.5c69f838.js";import"./u-loading.d153dd1a.js";import"./icon_copy.bacd4068.js";import"./useCopy.4954d67d.js";import"./uni-file-picker.87d7f36a.js";import"./u-input.e3cf3beb.js";import"./emitter.1571a5d9.js";import"./index.3dd6f2ef.js";import"./index.22b2ad12.js";import"./l-painter-image.027bd37e.js";import"./l-painter.cecf0579.js";import"./u-button.97a3d07f.js";import"./u-popup.21776ef7.js";import"./ua-markdown.e9ea1a15.js";import"./katex.37f36714.js";import"./mp-html.318bb55d.js";import"./index.ccff8ee2.js";import"./icon_copy.36709540.js";const K=q(e({__name:"dialogue_role",setup(e){const{useShare:q,resolveOptions:K,removeMixinShare:G}=C(),M=a(),N=y(),E=w(),Q=t(),W=l(),Y=o(!1),X=o(0),Z=o({image:"",tips:"",name:""}),ee=o(""),ae=o([]),te=o(""),le=o(""),oe=()=>{ge()},ne=n({show:!1,data:{url:"",name:"",type:"image"}}),se=e=>{ne.show=!!e.support_image,ne.show||(ne.data.url="")},ie=l(),re=l(),ue=async(e,a)=>{var t,l;try{const{lists:l=[],count:o}=await L({type:3,other_id:X.value,page_size:a/2,page_no:e});null==(t=ie.value)||t.complete(l.reverse()),0===o?setTimeout((()=>{var e;null==(e=ie.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{ge()}),100)}catch(o){null==(l=ie.value)||l.complete(!1)}},ce=o(!1),pe=e=>{e.height>0?ce.value=!0:ce.value=!1},de=()=>{ce.value=!1},{lockFn:me}=J((async()=>{var e;if(!Q.isLogin)return ke();(await T({title:"温馨提示",content:"确定清空对话？"})).cancel||(we(),await P({type:3,other_id:X.value}),null==(e=ie.value)||e.reload())})),ve=o(-1),{lockFn:fe}=J((async e=>{if(he.value)return;const a=ae.value[e],t=ae.value.findLast((({id:e})=>e===a.id));t&&(ve.value=a.id,ae.value.splice(e,2),be(t.content))})),ge=async()=>{var e;null==(e=ie.value)||e.scrollToBottom(!1)},he=o(!1);let _e=null;const ye=o([]),we=()=>{null==_e||_e.cancel(),setTimeout((()=>{te.value=""}))},xe=o({}),{pauseAll:je}=O(),ke=()=>{E.navigateTo({path:"/pages/login/login"})},{lockFn:be}=J((async e=>{if(Y.value=!1,!Q.isLogin)return ke();if(he.value)return;const a=e||te.value;if(a){ie.value.addChatRecordData({type:1,content:a,files_plugin:[{...ne.data}]}),xe.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},ie.value.addChatRecordData(xe.value),le.value=te.value,te.value="";try{he.value=!0,await A({type:3,other_id:X.value,question:a,model:ee.value,file:ne.data.url},{onstart(e){_e=e,je(),te.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t,l,o,n,s,i;if(""!==e)try{const r=JSON.parse(e),{object:u,choices:c,error:p}=r;if(p){console.log(p);const{message:e,code:a}=p;if(1100===a)if(M.getIsShowRecharge){const{cancel:e}=await T({title:"温馨提示",content:`${M.getTokenUnit}数量已用完，请前往充值`});if(e)return;E.navigateTo({path:"/packages/pages/recharge/recharge"})}else uni.$u.toast(`${M.getTokenUnit}数量已用完。请联系客服增加`);else e&&uni.$u.toast(e);return te.value=le.value,void ae.value.splice(0,2)}switch(u){case"chat":{const e=null==(a=c[0])?void 0:a.index,o=null==(l=null==(t=c[0])?void 0:t.delta)?void 0:l.content;xe.value.content[e]||(xe.value.content[e]=""),xe.value.content[e]+=o;break}case"reasoning":{const e=null==(n=null==(o=c[0])?void 0:o.delta)?void 0:n.content;xe.value.reasoning+=e;break}case"question":ye.value=JSON.parse(null==(i=null==(s=c[0])?void 0:s.delta)?void 0:i.content);break;case"finish":console.log("终端"),ne.data.url=""}}catch(r){}}))},async onclose(){-1!==ve.value&&xe.value.content.length&&(await P({type:1,id:ve.value}),ve.value=-1),he.value=!1,Q.getUser(),setTimeout((()=>{var e;null==(e=ie.value)||e.reload()}),1e3)}})}catch(t){console.log("发送消息失败=>",t),t.errMsg!==U.ABORT&&ae.value.splice(0,2),te.value=le.value,he.value=!1}}})),Ce=()=>{E.navigateBack()};return s((async()=>{const{id:e}=N.query;X.value=e,await(async()=>{try{Z.value=await D({id:X.value}),q({desc:Z.value.describe,title:Z.value.name,imageUrl:Z.value.image})}catch(e){console.log("获取角色错误=>",e)}})()})),i((()=>{we()})),(e,a)=>{const t=x(j("page-meta"),B),l=x(j("u-icon"),z),o=k,n=S,s=x(j("chat-record-item"),V),i=x(j("chat-input"),F),y=x(j("z-paging"),I),w=x(j("l-watermark"),R);return r(),u(h,null,[c(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),c(o,{class:"h-full flex flex-col"},{default:p((()=>[c(o,{class:"bg-white flex justify-between items-center pl-[20rpx] py-[4rpx]"},{default:p((()=>[c(o,{class:"flex items-center text-lg p-[20rpx]",onClick:Ce},{default:p((()=>[c(l,{name:"arrow-left",size:26}),c(o,{class:"flex-1 line-clamp-1 ml-[20rpx]"},{default:p((()=>{var e;return[d(m(null==(e=Z.value)?void 0:e.name),1)]})),_:1})])),_:1}),c(H,{sub_id:ee.value,"onUpdate:sub_id":a[0]||(a[0]=e=>ee.value=e),hasHiddenUnit:!0,"onUpdate:modelConfig":se},null,8,["sub_id"])])),_:1}),c(o,{class:"flex-1 min-h-0"},{default:p((()=>[c(w,{class:"w-full h-full",content:v(M).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:p((()=>[c(y,{ref_key:"pagingRef",ref:ie,modelValue:ae.value,"onUpdate:modelValue":a[5]||(a[5]=e=>ae.value=e),"use-chat-record-mode":"",fixed:!1,height:"100%",auto:!0,"safe-area-inset-bottom":!1,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,onQuery:ue,onKeyboardHeightChange:pe,onHidedKeyboard:de},{empty:p((()=>[c(o,{class:"w-full min-h-full"},{default:p((()=>[c(o,{class:"py-[30rpx]"},{default:p((()=>[c(s,{type:"left",content:Z.value.tips,loading:!1,avatar:Z.value.image,index:0,showCollectBtn:!1,showCopyBtn:!1,showVoiceBtn:!1,onClickLink:a[1]||(a[1]=e=>v(be)(e))},null,8,["content","avatar"])])),_:1})])),_:1})])),bottom:p((()=>[c(i,{modelValue:te.value,"onUpdate:modelValue":a[2]||(a[2]=e=>te.value=e),loading:he.value,showStop:he.value,safeAreaInsetBottom:"",showContinue:ae.value.length,"file-plugin":ne.data,"onUpdate:filePlugin":a[3]||(a[3]=e=>ne.data=e),"show-file-upload":ne.show,onSend:v(be),onPause:we,onFocus:oe,onClear:v(me),onContinue:a[4]||(a[4]=e=>v(be)("继续"))},{actions:p((()=>[v(Q).isLogin?(r(),f(o,{key:0,class:"text-base"},{default:p((()=>[d(" 剩余: "+m(v(Q).userInfo.balance)+" "+m(v(M).getTokenUnit),1)])),_:1})):g("v-if",!0)])),_:1},8,["modelValue","loading","showStop","showContinue","file-plugin","show-file-upload","onSend","onClear"])])),default:p((()=>[c(o,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:W},{default:p((()=>[(r(!0),u(h,null,_(ae.value,((e,a)=>(r(),f(o,{key:`${e.id} + ${a} + ''`,style:{transform:"scaleY(-1)"}},{default:p((()=>[c(o,{class:"chat-record mt-[20rpx] pb-[40rpx]"},{default:p((()=>[c(s,{"record-id":e.id,type:1==e.type?"right":"left",content:e.content,reasoning:e.reasoning,loading:e.loading,avatar:1==e.type?v(Q).userInfo.avatar:Z.value.image,index:a,time:2==e.type?e.create_time:"",showCopyBtn:!0,showVoiceBtn:2==e.type,"files-plugin":e.files_plugin,"model-name":e.model,"show-poster":2==e.type,onPoster:a=>(async e=>{const a=ae.value.filter((a=>a.id==e));2==a.length?re.value.initPosterData({title:a[1].content,content:a[0].content}):uni.$u.toast("上下文数据不对～")})(e.id)},{btn:p((()=>[2==e.type&&0===a?(r(),f(o,{key:0,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:b((e=>v(fe)(a)),["stop"])},{default:p((()=>[c(l,{name:"reload",size:"26"}),c(n,{class:"ml-1"},{default:p((()=>[d("重新回答")])),_:1})])),_:2},1032,["onClick"])):g("v-if",!0)])),sub_actions:p((()=>[0!==a||he.value?g("v-if",!0):(r(),f(o,{key:0,class:"flex flex-col",style:{"margin-left":"84rpx"}},{default:p((()=>[(r(!0),u(h,null,_(ye.value.length?ye.value:e.correlation,((e,a)=>(r(),f(o,{key:a,class:"inline-flex items-center rounded-md bg-white cursor-pointer mt-[20rpx]",style:{padding:"16rpx 24rpx",width:"fit-content"},onClick:b((a=>v(be)(e)),["stop"])},{default:p((()=>[c(n,{class:"mr-1 text-base text-content"},{default:p((()=>[d(m(e),1)])),_:2},1024),c(l,{name:"arrow-rightward",color:"#999",size:"30"})])),_:2},1032,["onClick"])))),128))])),_:2},1024))])),_:2},1032,["record-id","type","content","reasoning","loading","avatar","index","time","showVoiceBtn","files-plugin","model-name","show-poster","onPoster"])])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"])])),_:1},8,["content","font"])])),_:1}),g("  生产对话海报  "),c($,{ref_key:"posterRef",ref:re},null,512)])),_:1})],64)}}}),[["__scopeId","data-v-45edbcfc"]]);export{K as default};
