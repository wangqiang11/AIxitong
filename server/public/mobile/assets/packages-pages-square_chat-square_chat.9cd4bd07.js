import{d as e,s as a,C as t,o as l,k as o,b as s,w as n,f as i,t as r,e as u,O as c,F as d,l as p,r as v,a as m,j as f,D as _,c as g,m as h,u as y,A as x,J as w,K as b,x as k,L as j,aF as C,g as V,aP as T,n as q,aH as P,aI as z,aQ as F,z as S,ae as U,aE as A,p as D,U as R,aG as I,h as L,V as N}from"./index-d6d2a33a.js";import{_ as O}from"./page-meta.d751427a.js";import{_ as $}from"./u-icon.992584aa.js";import{_ as B}from"./router-navigate.18e98059.js";import{_ as H}from"./chat-record-item.e19df2e0.js";import{_ as J}from"./u-tag.fd761889.js";import{_ as E}from"./uni-icons.0b553b27.js";import{_ as K,a as G,b as Q}from"./dialog-poster.vue_vue_type_script_setup_true_lang.74c53633.js";import{_ as M}from"./z-paging.6c8c2edf.js";import{_ as W}from"./l-textarea.9d4b6972.js";import{_ as X}from"./u-button.97a3d07f.js";import{_ as Y}from"./u-popup.21776ef7.js";import{e as Z,l as ee,f as ae,m as te,h as le,j as oe,i as se,r as ne,v as ie}from"./robot.627d8f7e.js";import{u as re}from"./useLockFn.3b1f86f9.js";import{u as ue,F as ce}from"./use-files-manage.1a21abcb.js";import{_ as de}from"./u-image.9574760c.js";import{_ as pe}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as ve,a as me}from"./context-popup.vue_vue_type_script_setup_true_lang.6890be53.js";import{u as fe}from"./text-item.bd4ac6fd.js";import{u as _e,a as ge}from"./useRecorder.91513557.js";import{u as he}from"./useAudio.deb09cdd.js";import"./u-collapse.5c69f838.js";import"./u-loading.d153dd1a.js";import"./icon_copy.bacd4068.js";import"./useCopy.4954d67d.js";import"./uni-file-picker.87d7f36a.js";import"./u-input.e3cf3beb.js";import"./emitter.1571a5d9.js";import"./index.3dd6f2ef.js";import"./index.22b2ad12.js";import"./l-painter-image.027bd37e.js";import"./l-painter.cecf0579.js";import"./fileReader.617b57ea.js";import"./_commonjsHelpers.157f59fb.js";import"./index.ccff8ee2.js";import"./ua-markdown.e9ea1a15.js";import"./katex.37f36714.js";import"./mp-html.318bb55d.js";import"./icon_copy.36709540.js";import"./chat.d9a8f946.js";import"./howler.bdae6f69.js";const ye=pe(e({__name:"square-robot",props:{data:{required:!0,type:Array},modelValue:{required:!0,type:[String,Number]}},emits:["update:modelValue"],setup(e,{emit:y}){const x=e,w=a(!1),b=t((()=>{var e;return(null==(e=x.data)?void 0:e.find((e=>e.id===Number(k.value))))||{}})),k=t({get:()=>x.modelValue,set:e=>{y("update:modelValue",e)}});return(a,t)=>{const y=v(m("u-icon"),$),x=f,j=v(m("u-image"),de),C=_,V=v(m("u-popup"),Y);return l(),o(d,null,[s(x,{class:"bg-white flex items-center px-[20rpx] py-[24rpx]"},{default:n((()=>[s(y,{name:"list",size:40,onClick:t[0]||(t[0]=e=>w.value=!0)}),s(x,{class:"flex-1 line-clamp-1 ml-[20rpx]"},{default:n((()=>[i(r(u(b).name),1)])),_:1}),c(a.$slots,"right",{},void 0,!0)])),_:3}),s(V,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=e=>w.value=e),mode:"left",width:"480rpx","safe-area-inset-bottom":""},{default:n((()=>[s(x,{class:"h-full"},{default:n((()=>[s(C,{"scroll-y":"",class:"h-full"},{default:n((()=>[s(x,{class:"p-[20rpx]"},{default:n((()=>[(l(!0),o(d,null,p(e.data,(e=>(l(),g(x,{class:h(["robot-item",{"robot-item--active":e.id===Number(u(k))}]),key:e.id,onClick:a=>{return t=e.id,k.value=t,void(w.value=!1);var t}},{default:n((()=>[s(j,{src:e.image,shape:"circle",width:"80",height:"80"},null,8,["src"]),s(x,{class:"flex-1 min-w-0 ml-[20rpx]"},{default:n((()=>[s(x,{class:"line-clamp-1 font-medium text-xl"},{default:n((()=>[i(r(e.name),1)])),_:2},1024),s(x,{class:h(["text-muted line-clamp-1",{"!text-white":e.id===Number(u(k))}])},{default:n((()=>[i(r(e.intro),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-2c3be87d"]]),xe=pe(e({__name:"square_chat",setup(e){const{pauseAll:c}=fe(),de=y(),pe=S(),xe=U(),we=x(),be=w(),ke=ue(),je=a(!1),Ce=a([]),Ve=a(1),Te=t((()=>2===Ve.value)),qe=a(0);b({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."});const Pe=w(),ze=e=>{2===Ve.value&&(qe.value=e)},Fe=a(!1),Se=a(0),Ue=a(!1),Ae=a(0),De=a(0),Re=a(!0),Ie=b({id:"audio-canvas",width:100,height:30,minHeight:5,scale:2}),{render:Le,stopRender:Ne,draw:Oe}=_e(Ie),{start:$e,stop:Be,isRecording:He,authorize:Je,close:Ee}=ge({onstart(){Ue.value=!1,Se.value=Date.now()},async onstop(e){if(Ne(),setTimeout((()=>{Oe(new Float64Array(new Array(128).fill(0)),0)}),10),Fe.value){Fe.value=!1,ze(3);try{const a=await oe(e.tempFilePath);if(!a.text)return void(Re.value&&ze(2));ka(a.text,"voice")}catch(a){Re.value&&ze(1)}}},ondata(e){Le(e);const a=Date.now();e.powerLevel>15&&(clearTimeout(Ae.value),qe.value=2,Ue.value=!0,Se.value=a,Ae.value=setTimeout((()=>{Fe.value=!0,clearTimeout(De.value),Be()}),2e3)),a-Se.value>=5e3&&Ue.value}}),{play:Ke,pause:Ge,isPlaying:Qe}=he({onstart(){qe.value=4,Xe.value&&(Xe.value=!1,Be())},onstop(){var e;De.value=setTimeout((()=>{Ye()}),1e3*(null==(e=aa.value.digital)?void 0:e.idle_time)||0),Re.value?ze(2):ze(1)},onerror(){ze(1)}}),Me=async e=>{const{url:a}=await ie(e);return a},We=a(""),Xe=a(!1),Ye=async()=>{if(2!==Ve.value)return Promise.reject();if(!aa.value.is_digital||!aa.value.digital_id||aa.value.is_disable)return Promise.reject();if(We.value||(We.value=await Me({type:3,record_id:aa.value.id})),!We.value)return Promise.reject();Xe.value=!0;const e=Date.now();Ce.value.push({type:2,typing:!1,content:aa.value.digital.idle_reply,key:e}),await N(),_a(),Ke(We.value)};k(Ve,(async e=>{if(1===e)Ge(),Ee(),qe.value=0,clearTimeout(De.value);else{Re.value=!0,await Je(),Oe(null,0);try{await Ye()}catch(a){ze(2)}_a()}})),k(qe,(e=>{if(2===e)(async()=>{He.value||2!==Ve.value||$e()})()}));const Ze=b({show:!1,data:[]}),ea=b({show:!1,data:[]});a(!1);const aa=a({}),ta=a(""),la=a(""),oa=()=>{if(!we.isLogin)return Ta();_a()},sa=a(xe.query.id),na=a([]),ia=t((()=>na.value.find((e=>e.id===Number(sa.value)))||{})),ra=t((()=>ia.value.robot_id)),ua=w();let ca=0;const da=async(e,a)=>{var t,l;try{const{lists:l=[],count:o}=await ae({square_id:ia.value.id,robot_id:ra.value,page_size:a/2,page_no:e});if(null==(t=ua.value)||t.complete(l.reverse()),0===o?setTimeout((()=>{var e;null==(e=ua.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{_a()}),100),2===Ve.value&&3==qe.value){const e=l[0];e&&e.id!==ca&&(ca=e.id,(async e=>{try{const a=await Me({type:2,record_id:e});Ke(a)}catch(a){ze(1)}})(ca))}}catch(o){null==(l=ua.value)||l.complete(!1)}},pa=a(!1),va=e=>{e.height>0?pa.value=!0:pa.value=!1},ma=()=>{pa.value=!1},{lockFn:fa}=re((async()=>{var e;if(!we.isLogin)return Ta();(await R({title:"温馨提示",content:"确定清空对话？"})).cancel||(xa(),await se({robot_id:ra.value,square_id:ia.value.id}),null==(e=ua.value)||e.reload())})),_a=async()=>{var e;null==(e=ua.value)||e.scrollToBottom(!1)},ga=a(!1);let ha=null;const ya=a([]),xa=()=>{null==ha||ha.cancel(),setTimeout((()=>{ta.value=""}))},wa=a({}),{pauseAll:ba}=fe(),{lockFn:ka}=re((async(e,a="text")=>{if(je.value=!1,!we.isLogin)return Ta();if(ga.value)return;const t=e||ta.value;if(!t)return;const l=ke.files.value.map((e=>({name:e.name,type:"30",url:e.url})));ua.value.addChatRecordData({type:1,content:t,files_plugin:l}),wa.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},ua.value.addChatRecordData(wa.value),la.value=ta.value,ta.value="";try{ga.value=!0,ze(3),await ne({cate_id:0,square_id:ia.value.id,robot_id:ra.value,question:t,stream:!0,annex:[],files:ke.files.value.map((e=>({...e,type:"30"})))},{onstart(e){ha=e,ba(),ta.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t,l,o;if(""!==e)try{const n=JSON.parse(e),{object:i,choices:r,error:u}=n;if(u){const{message:e,code:a}=u;return e&&uni.$u.toast(e),void Ce.value.splice(0,2)}const c=null==(t=null==(a=r[0])?void 0:a.delta)?void 0:t.content;switch(i){case"chat":wa.value.content||(wa.value.content=""),wa.value.content+=c;break;case"reasoning":wa.value.content||(wa.value.content=""),wa.value.reasoning+=c;break;case"question":ya.value=JSON.parse(null==(o=null==(l=r[0])?void 0:l.delta)?void 0:o.content);break;case"image":case"video":case"file":{const e=`${i}s`;try{const a=JSON.parse(c);wa.value[e]=a}catch(s){console.error(s)}}}}catch(n){}}))},onclose(){ga.value=!1,we.getUser(),setTimeout((()=>{var e;null==(e=ua.value)||e.reload()}),1e3)}})}catch(o){console.log("发送消息失败=>",o),o.errMsg!==I.ABORT&&Ce.value.splice(0,2),"text"==a&&(ta.value=la.value),ga.value=!1}})),ja=a(!1),Ca=b({_index:-1,robot_id:-1,record_id:-1,content:""}),Va=async()=>{try{await te(Ca),ja.value=!1,Ca.content="",Ce.value[Ca._index].is_feedback=1}catch(e){console.log("反馈提交失败--\x3e",e)}},Ta=()=>{pe.navigateTo({path:"/pages/login/login"})},qa=async()=>{ra.value&&(aa.value=await le({id:ra.value}))};return k(sa,(e=>{Ve.value=1,qa(),setTimeout((()=>{var a,t;e?null==(a=ua.value)||a.reload():(null==(t=ua.value)||t.complete([]),setTimeout((()=>{var e;null==(e=ua.value)||e.scrollToTop(!1)}),100))}),10)})),j((async()=>{var e;if(xe.query.square_id){const{id:e}=await Z({id:xe.query.square_id});sa.value=e}await(async()=>{na.value=await ee()})(),qa(),null==(e=ua.value)||e.reload()})),C((()=>{xa()})),(e,a)=>{const t=v(m("page-meta"),O),y=f,x=v(m("u-icon"),$),w=v(m("router-navigate"),B),b=A,k=v(m("chat-record-item"),H),j=v(m("u-tag"),J),C=L,S=_,U=v(m("uni-icons"),E),R=v(m("chat-input"),G),I=v(m("z-paging"),M),N=v(m("l-watermark"),Q),Z=v(m("l-textarea"),W),ee=v(m("u-button"),X),ae=v(m("u-popup"),Y);return l(),o(d,null,[s(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),s(y,{class:"h-full flex flex-col"},{default:n((()=>[s(y,null,{default:n((()=>[V(' <u-navbar\n                :title="robotInfo.name"\n                title-color="#333"\n                :title-bold="true"\n            ></u-navbar> '),s(ye,{data:na.value,modelValue:sa.value,"onUpdate:modelValue":a[0]||(a[0]=e=>sa.value=e)},T({_:2},[aa.value.is_digital?{name:"right",fn:n((()=>[s(w,{to:{path:"/packages/pages/digital_chat/digital_chat",query:{id:u(ra),squareId:u(ia).id}},onClick:u(c)},{default:n((()=>[s(y,{class:"flex items-center"},{default:n((()=>[s(y,{class:"mr-[10rpx]"},{default:n((()=>[i(" 形象对话 ")])),_:1}),s(x,{name:"arrow-rightward"})])),_:1})])),_:1},8,["to","onClick"])])),key:"0"}:void 0]),1032,["data","modelValue"])])),_:1}),s(y,{class:"flex-1 min-h-0 relative",style:q({background:u(Te)?aa.value.digital_bg:""})},{default:n((()=>[u(Te)?(l(),g(y,{key:0,class:"absolute inset-0"},{default:n((()=>{var e,a;return[P(s(b,{class:"h-full w-full",src:null==(e=aa.value.digital)?void 0:e.vertical_stay_video,autoplay:"",muted:"",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"contain"},null,8,["src"]),[[z,!u(Qe)]]),P(s(b,{class:"h-full w-full",src:null==(a=aa.value.digital)?void 0:a.vertical_talk_video,autoplay:"",muted:"",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"contain"},null,8,["src"]),[[z,u(Qe)]])]})),_:1})):V("v-if",!0),s(y,{class:"h-full flex flex-col"},{default:n((()=>[s(y,{class:"flex-1 min-h-0"},{default:n((()=>[s(N,{class:"flex-1 min-h-0",content:u(de).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:n((()=>[s(I,{ref_key:"pagingRef",ref:ua,modelValue:Ce.value,"onUpdate:modelValue":a[2]||(a[2]=e=>Ce.value=e),"use-chat-record-mode":"",auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,onQuery:da,fixed:!1,onKeyboardHeightChange:va,onHidedKeyboard:ma},{empty:n((()=>[s(y,{class:"w-full min-h-full pt-[40rpx]"},{default:n((()=>[aa.value.welcome_introducer?(l(),g(k,{key:0,class:h({"opacity-50":u(Te)}),type:"left",content:aa.value.welcome_introducer,avatar:aa.value.icons?aa.value.icons:aa.value.image,showCopyBtn:!1,onClickLink:u(ka)},null,8,["class","content","avatar","onClickLink"])):V("v-if",!0)])),_:1})])),bottom:n((()=>[s(y,{class:h({" bg-white":!u(Te)})},{default:n((()=>[s(R,{class:h({"!bg-[transparent]":!0}),modelValue:ta.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ta.value=e),loading:ga.value||3===qe.value,"show-stop":ga.value,"safe-area-inset-bottom":!aa.value.copyright,onSend:u(ka),onPause:xa,onFocus:oa,onClear:u(fa)},{actions:n((()=>[s(S,{class:"w-full whitespace-nowrap","scroll-x":""},{default:n((()=>[(l(!0),o(d,null,p(aa.value.menus,((e,a)=>(l(),g(y,{class:"menus bg-page px-[30rpx] rounded-full mr-[20rpx] py-[10rpx] inline-block",key:a,onClick:a=>u(ka)(e.keyword)},{default:n((()=>[i(r(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1}),aa.value.support_file?(l(),g(y,{key:0,class:"inline-block"},{default:n((()=>[s(ce,{onOnSuccess:u(ke).addFile},null,8,["onOnSuccess"])])),_:1})):V("v-if",!0)])),"file-list":n((()=>[(l(!0),o(d,null,p(u(ke).files.value,(e=>(l(),g(y,{class:"flex items-center py-1 px-2 bg-page rounded",key:e.id},{default:n((()=>[s(y,{class:"text-sm mr-1"},{default:n((()=>[i(r(e.name),1)])),_:2},1024),s(U,{type:"closeempty",size:16,onClick:a=>u(ke).removeFile(e)},null,8,["onClick"])])),_:2},1024)))),128))])),_:1},8,["modelValue","loading","show-stop","safe-area-inset-bottom","onSend","onClear"]),V(' <view\n                                        v-if="robotInfo.copyright"\n                                        class="pb-[20rpx] text-center text-content safe-area-inset-bottom"\n                                    >\n                                        {{ robotInfo.copyright }}\n                                    </view> ')])),_:1},8,["class"])])),default:n((()=>[s(y,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:be},{default:n((()=>[(l(!0),o(d,null,p(Ce.value,((e,a)=>(l(),g(y,{key:`${e.id} + ${a} + ''`,style:{transform:"scaleY(-1)"}},{default:n((()=>[s(y,{class:"chat-record mt-[20rpx] pb-[40rpx]"},{default:n((()=>[1==e.type?(l(),g(k,{key:0,type:"right",content:e.content,avatar:u(we).userInfo.avatar,showCopyBtn:!0,"files-plugin":e.files_plugin,class:h({"opacity-50":u(Te)})},null,8,["content","avatar","files-plugin","class"])):V("v-if",!0),2==e.type?(l(),g(k,{key:1,class:h({"opacity-50":u(Te)}),"record-id":e.id,type:"left",content:e.content,reasoning:e.reasoning,loading:e.loading,avatar:aa.value.icons?aa.value.icons:aa.value.image,index:a,chatType:2,time:e.create_time,showCopyBtn:!0,images:e.images,files:e.files,videos:e.videos,showVoiceBtn:!0,"model-name":e.model,"show-poster":"",onPoster:a=>(async e=>{const a=Ce.value.filter((a=>a.id==e));2==a.length?Pe.value.initPosterData({title:a[1].content,content:a[0].content}):uni.$u.toast("上下文数据不对～")})(e.id)},{btn:n((()=>[s(y,{class:"flex items-center"},{default:n((()=>{var a,t;return[aa.value.is_show_quote&&(null==(a=e.quotes)?void 0:a.length)?(l(),g(y,{key:0,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:a=>{return t=e.quotes,ea.show=!0,void(ea.data=t);var t}},{default:n((()=>{var a;return[i(r(null==(a=e.quotes)?void 0:a.length)+"条引用 ",1)]})),_:2},1032,["onClick"])):V("v-if",!0),aa.value.is_show_context&&(null==(t=e.context)?void 0:t.length)?(l(),g(y,{key:1,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:a=>{return t=e.context,Ze.show=!0,void(Ze.data=t);var t}},{default:n((()=>{var a;return[i(r(null==(a=e.context)?void 0:a.length)+"条上下文 ",1)]})),_:2},1032,["onClick"])):V("v-if",!0)]})),_:2},1024)])),sub_actions:n((()=>[e.create_time&&aa.value.is_show_feedback?(l(),g(y,{key:0,class:"ml-[86rpx] mt-2"},{default:n((()=>[s(j,{text:e.is_feedback?"已反馈":"反馈",type:e.is_feedback?"info":"primary",size:"mini",style:{"--color-primary-light-3":"transparent","--color-info-light-3":"transparent"},onClick:t=>((e,a)=>{1!==Ce.value[a].is_feedback&&(Ca.robot_id=ra.value,Ca.record_id=e.id,Ca._index=a,ja.value=!0)})(e,a)},null,8,["text","type","onClick"])])),_:2},1024)):V("v-if",!0),0!==a||ga.value?V("v-if",!0):(l(),g(y,{key:1,class:"flex flex-col",style:{"margin-left":"84rpx"}},{default:n((()=>[(l(!0),o(d,null,p(ya.value.length?ya.value:e.correlation,((e,a)=>(l(),g(y,{key:a,class:"inline-flex items-center rounded-md bg-white cursor-pointer mt-[20rpx]",style:{padding:"16rpx 24rpx",width:"fit-content"},onClick:D((a=>u(ka)(e)),["stop"])},{default:n((()=>[s(C,{class:"mr-1 text-base text-content"},{default:n((()=>[i(r(e),1)])),_:2},1024),s(x,{name:"arrow-rightward",color:"#999",size:"30"})])),_:2},1032,["onClick"])))),128))])),_:2},1024))])),_:2},1032,["class","record-id","content","reasoning","loading","avatar","index","time","images","files","videos","model-name","onPoster"])):V("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"])])),_:1},8,["content","font"])])),_:1})])),_:1})])),_:1},8,["style"]),V("  会话弹窗  "),V(' <session-popup\n            v-model:show="showPopup"\n            v-model="sessionActive"\n            :lists="sessionLists"\n            @add="sessionAdd"\n            @clear="sessionClear"\n            @delete="sessionDelete"\n            @edit="sessionEdit"\n        /> '),s(ve,F(ea,{show:ea.show,"onUpdate:show":a[3]||(a[3]=e=>ea.show=e)}),null,16,["show"]),s(me,F(Ze,{show:Ze.show,"onUpdate:show":a[4]||(a[4]=e=>Ze.show=e)}),null,16,["show"]),V(" 内容反馈 "),s(ae,{modelValue:ja.value,"onUpdate:modelValue":a[6]||(a[6]=e=>ja.value=e),"safe-area-inset-bottom":"",closeable:"","border-radius":"16",mode:"center"},{default:n((()=>[s(y,{class:"flex flex-col",style:{width:"600rpx"}},{default:n((()=>[s(y,{class:"text-xl mx-[20rpx] py-[28rpx] font-bold border-b border-solid border-light border-0"},{default:n((()=>[i(" 问题反馈 ")])),_:1}),s(y,{class:"flex-1 min-h-0 px-[20rpx] pb-[30rpx]"},{default:n((()=>[s(y,{class:"py-[20rpx]"},{default:n((()=>[s(Z,{modelValue:Ca.content,"onUpdate:modelValue":a[5]||(a[5]=e=>Ca.content=e),placeholder:"描述一下你遇到了什么问题"},null,8,["modelValue"])])),_:1}),s(ee,{type:"primary",onClick:Va},{default:n((()=>[i("提交反馈")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),V("  生产对话海报  "),s(K,{ref_key:"posterRef",ref:Pe},null,512)])),_:1})],64)}}}),[["__scopeId","data-v-01819ee5"]]);export{xe as default};
