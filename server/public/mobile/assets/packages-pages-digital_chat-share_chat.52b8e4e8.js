import{d as e,J as a,K as t,x as l,aM as s,o,c as i,w as r,b as n,e as u,P as c,r as d,a as p,j as m,A as v,s as f,C as y,$ as h,aF as w,k as g,g as x,f as _,t as b,aH as k,aI as j,F as C,l as z,p as R,m as T,n as V,ae as F,E as D,aN as I,aL as $,U as E,i as O,aE as P,D as q,ax as L,aG as U,V as A,h as B}from"./index-d6d2a33a.js";import{_ as J}from"./page-meta.d751427a.js";import{_ as S}from"./chat-record-item.e19df2e0.js";import{_ as N}from"./u-icon.992584aa.js";import{_ as H}from"./z-paging.6c8c2edf.js";import{_ as M}from"./u-button.97a3d07f.js";import{_ as G}from"./u-input.e3cf3beb.js";import{_ as K}from"./dragon-button.79847554.js";import{_ as Q,a as W,b as Y}from"./icon_clear.1440a0f3.js";import{f as Z,v as X,k as ee,i as ae,r as te,j as le}from"./robot.627d8f7e.js";import{u as se}from"./useLockFn.3b1f86f9.js";import{u as oe}from"./text-item.bd4ac6fd.js";import{u as ie,a as re}from"./useRecorder.91513557.js";import{u as ne}from"./useAudio.deb09cdd.js";import{_ as ue}from"./u-form-item.36bcbf1f.js";import{_ as ce}from"./u-form.f207500c.js";import{_ as de}from"./u-modal.793c614f.js";import{u as pe}from"./index.3dd6f2ef.js";import{D as me}from"./default_avatar.84088887.js";import{_ as ve}from"./u-empty.a728d8d9.js";import{_ as fe}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-image.9574760c.js";import"./u-tag.fd761889.js";import"./u-collapse.5c69f838.js";import"./u-loading.d153dd1a.js";import"./icon_copy.bacd4068.js";import"./useCopy.4954d67d.js";import"./emitter.1571a5d9.js";import"./ua-markdown.e9ea1a15.js";import"./_commonjsHelpers.157f59fb.js";import"./katex.37f36714.js";import"./mp-html.318bb55d.js";import"./index.ccff8ee2.js";import"./icon_copy.36709540.js";import"./chat.d9a8f946.js";import"./howler.bdae6f69.js";import"./u-popup.21776ef7.js";import"./index.22b2ad12.js";const ye=e({__name:"login",props:{show:{type:Boolean}},emits:["update:show","confirm"],setup(e,{emit:v}){const f=e,y=a(),h=a(),w=pe(f,"show",v),g=t({password:""});l(w,(e=>{e&&setTimeout((()=>{y.value.setRules(x)}))}));const x=s({password:[{required:!0,message:"请输入密码"}]}),_=async()=>{var e;null==(e=h.value)||e.clearLoading(),y.value.validate((e=>{e&&(v("confirm",g),w.value=!1)}))};return(e,a)=>{const t=d(p("u-input"),G),l=d(p("u-form-item"),ue),s=d(p("u-form"),ce),v=m,f=d(p("u-modal"),de);return o(),i(v,null,{default:r((()=>[n(f,{ref_key:"uModalRef",ref:h,modelValue:u(w),"onUpdate:modelValue":a[1]||(a[1]=e=>c(w)?w.value=e:null),"async-close":!0,onConfirm:_,title:"输入密码"},{default:r((()=>[n(v,{class:"p-[40rpx]"},{default:r((()=>[n(s,{model:g,ref_key:"uFormRef",ref:y,"border-bottom":!1},{default:r((()=>[n(l,{label:"密码",prop:"password",required:""},{default:r((()=>[n(t,{modelValue:g.password,"onUpdate:modelValue":a[0]||(a[0]=e=>g.password=e),placeholder:"请输入密码",border:!0},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1})])),_:1},8,["modelValue"])])),_:1})}}}),he=fe(e({__name:"share_chat",setup(e){const l=F(),s=v(),c=a(),ue=f(!1),ce=f([]),de=f(!1),pe=f(""),{key:fe=""}=l.query,he=f({robot:{},digital:{}}),we=f(""),{isLock:ge,lockFn:xe}=se((async()=>{he.value=await ee({apikey:fe})})),_e=y((()=>{var e;return(null==(e=he.value.menus)?void 0:e.map((e=>({keyword:e}))))||[]})),be=async()=>{const e=D.get(I)||{};if(pe.value=e[fe]||"",he.value.pwd&&!pe.value)return de.value=!0,Promise.reject()},ke=async e=>{let a=D.get(I)||{};pe.value=e.password,a=Object.assign(a,{[fe]:e.password}),D.set(I,a),ga()},je=f(0),Ce=t({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中...",5:"用户拒绝了录音权限，请检查设备权限后重新进入程序"}),ze=a();let Re=0;const Te=async(e,a)=>{var t,l;try{const{lists:l=[],count:o}=await Z({share_apikey:fe,identity:s.visitorId,page_size:a/2,page_no:e},{password:pe.value,authorization:fe,identity:s.visitorId});if(null==(t=ze.value)||t.complete(l.reverse()),0===o?setTimeout((()=>{var e;null==(e=ze.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{Fe()}),100),3==je.value){const e=l[0];e&&e.id!==Re&&(Re=e.id,ra(Re))}}catch(o){"访问密码错误!"===o&&((()=>{let e=D.get(I)||{};e=Object.assign(e,{[fe]:""}),D.set(I,e)})(),be()),null==(l=ze.value)||l.complete(!1)}},{lockFn:Ve}=se((async()=>{var e;await be();(await E({title:"温馨提示",content:"确定清空对话？"})).cancel||(Ee(),await ae({},{password:pe.value,authorization:fe,identity:s.visitorId}),null==(e=ze.value)||e.reload())})),Fe=async()=>{var e;null==(e=ze.value)||e.scrollToBottom(!1)},De=f(!1);let Ie=null;const $e=f([]),Ee=()=>{null==Ie||Ie.cancel(),setTimeout((()=>{we.value=""}))},Oe=a(),Pe=e=>{je.value=e},qe=f({}),Le=f(""),{pauseAll:Ue}=oe(),{lockFn:Ae}=se((async(e,a="text")=>{if(ue.value=!1,await s.getFingerprint(),await be(),De.value)return;const t=e||we.value;if(t){ze.value.addChatRecordData({type:1,content:t}),qe.value={type:2,loading:!0,content:[],reasoning:"",id:Date.now()},ze.value.addChatRecordData(qe.value),Le.value=we.value,we.value="";try{De.value=!0,Pe(3),await te({question:t,stream:!0},{onstart(e){Ie=e,Ue(),we.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t,l,s,o,i;if(""!==e)try{const n=JSON.parse(e),{object:u,choices:c,error:d}=n;if(d){Pe(1);const{message:e,code:a}=d;return e&&uni.$u.toast(e),void ce.value.splice(0,2)}const p=null==(t=null==(a=c[0])?void 0:a.delta)?void 0:t.content;switch(u){case"chat":qe.value.content||(qe.value.content=""),qe.value.content+=p;break;case"reasoning":{const e=null==(s=null==(l=c[0])?void 0:l.delta)?void 0:s.content;qe.value.reasoning+=e;break}case"question":$e.value=JSON.parse(null==(i=null==(o=c[0])?void 0:o.delta)?void 0:i.content);break;case"image":case"video":case"file":{const e=`${u}s`;try{const a=JSON.parse(p);qe.value[e]=a}catch(r){console.error(r)}}}}catch(n){}}))},onclose(){De.value=!1,setTimeout((()=>{var e;null==(e=ze.value)||e.reload()}),1e3)}},{password:pe.value,authorization:fe,identity:s.visitorId})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==U.ABORT&&ce.value.splice(0,2),"text"==a&&(we.value=Le.value),De.value=!1}}})),Be=async()=>{await be(),Fe()},Je=f(),Se=f(!0),Ne=f(!1),He=f(0),Me=f(!1),Ge=f(0),Ke=t({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:Qe,stopRender:We,draw:Ye}=ie(Ke),{start:Ze,stop:Xe,isRecording:ea,authorize:aa,close:ta,isOpen:la}=re({onstart(){Pe(2),clearTimeout(Je.value),oa(),Me.value=!1,He.value=Date.now()},async onstop(e){if(We(),Me.value=!1,Ne.value){Ne.value=!1,Pe(3);try{const a=await le(e.tempFilePath);if(!a.text)return void(Se.value?na():Pe(1));Ae(a.text,"voice")}catch(a){Pe(1)}}else Pe(1)},ondata(e){var a;const t=Date.now();Me.value&&Qe(e),e.powerLevel>=10&&(clearTimeout(Ge.value),je.value=2,Me.value=!0,He.value=t,Ge.value=setTimeout((()=>{Ne.value=!0,clearTimeout(Je.value),oa(),Xe()}),2e3)),t-He.value>=1e3*(null==(a=he.value.digital)?void 0:a.idle_time)&&(Me.value||(ma(),Xe()))}}),{play:sa,pause:oa,isPlaying:ia}=ne({onstart(){je.value=4,pa.value&&(pa.value=!1)},onstop(){Pe(2),Se.value?na():Pe(1)},onerror(){Pe(1)}}),ra=async e=>{const a=await ca({type:2,record_id:e});sa(a)},na=async()=>{ea.value||(await aa(),Ze())},ua=async()=>{4!=je.value?3!=je.value&&(ea.value?(Se.value=!1,Xe(),Pe(1)):(Se.value=!0,na())):oa()},ca=async e=>{try{const{url:a}=await X(e,{password:pe.value,authorization:fe,identity:s.visitorId});return a}catch(a){return Pe(1),Promise.reject()}},da=f(""),pa=f(!1),ma=async()=>{if(!he.value.is_digital||!he.value.digital_id)return Promise.reject();if(da.value||(da.value=await ca({type:3,record_id:he.value.id})),!da.value)return Promise.reject();pa.value=!0;const e=Date.now();ze.value.addChatRecordData({type:2,typing:!1,content:he.value.digital.idle_reply,key:e}),await A(),Fe(),sa(da.value)};let va=null,fa=null,ya=!1,ha=!1;const wa=async()=>{ha=!0,ya&&(await aa(),na())},ga=async()=>{var e;await be(),null==(e=ze.value)||e.reload(),Se.value=!0,va=$("stay-video"),fa=$("talk-video");const{confirm:a}=await E({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"});if(a&&(null==va||va.play(),null==fa||fa.play(),ya=!0),ha)try{await aa(),na()}catch(t){"无法录音:用户拒绝了录音权限"==t&&(je.value=5),await aa()}finally{await aa(),na()}};return h((async()=>{await xe(),await s.getFingerprint(),ga()})),w((()=>{Ee(),oa(),Xe()})),(e,a)=>{const t=d(p("page-meta"),J),l=O,s=m,v=P,f=d(p("chat-record-item"),S),y=B,h=d(p("u-icon"),N),w=d(p("z-paging"),H),F=d(p("u-button"),M),D=q,I=d(p("u-input"),G),$=L,E=d(p("dragon-button"),K);return o(),g(C,null,[n(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),0==je.value?(o(),i(s,{key:0,class:"h-full flex justify-center items-center fixed inset-0 w-full z-[9999] bg-white"},{default:r((()=>[n(l,{src:Q,class:"w-[600rpx]",mode:"widthFix"})])),_:1})):x("v-if",!0),5==je.value?(o(),i(s,{key:1,class:"h-full flex justify-center items-center fixed inset-0 w-full z-[9999] bg-white"},{default:r((()=>[n(s,null,{default:r((()=>[n(ve,{mode:"permission",text:" "}),n(s,{class:"text-xs text-muted text-center",style:{width:"400rpx"}},{default:r((()=>[_(b(Ce[je.value]),1)])),_:1})])),_:1})])),_:1})):x("v-if",!0),n(s,{class:"h-full container-wrap"},{default:r((()=>[he.value.digital.id||u(ge)?(o(),i(s,{key:0,class:"h-full relative py-[40rpx] px-[20rpx]",style:V({background:he.value.robot.digital_bg})},{default:r((()=>{var t,d;return[k(n(v,{ref_key:"videoRef",ref:Oe,id:"stay-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",autoplay:"false",preload:"none",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(t=he.value.digital)?void 0:t.vertical_stay_video,onLoadedmetadata:wa},null,8,["src"]),[[j,4!==je.value]]),k(n(v,{ref_key:"videoRef",ref:Oe,id:"talk-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(d=he.value.digital)?void 0:d.vertical_talk_video},null,8,["src"]),[[j,4===je.value]]),n(s,{class:"h-full relative z-10 flex flex-col top-0"},{default:r((()=>[n(s,{class:"flex text-white items-center"},{default:r((()=>[n(s,{class:"flex-1 min-w-0 line-clamp-1 text-xl font-medium"},{default:r((()=>[_(b(he.value.name),1)])),_:1})])),_:1}),n(s,{class:"flex-1 min-h-0 flex flex-col justify-end"},{default:r((()=>[n(w,{ref_key:"pagingRef",ref:ze,modelValue:ce.value,"onUpdate:modelValue":a[0]||(a[0]=e=>ce.value=e),"use-chat-record-mode":"",auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,onQuery:Te,fixed:!1},{empty:r((()=>[])),default:r((()=>[n(s,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:c},{default:r((()=>[(o(!0),g(C,null,z(ce.value,((a,t)=>(o(),i(s,{key:`${a.id} + ${t} + ''`,style:{transform:"scaleY(-1)"}},{default:r((()=>[n(s,{class:"chat-record mt-[20rpx]"},{default:r((()=>[1==a.type?(o(),i(f,{key:0,type:"left",content:a.content,avatar:u(me),showCopyBtn:!1,bg:e.$theme.primaryColor,color:"#fff"},null,8,["content","avatar","bg"])):x("v-if",!0),2==a.type?(o(),i(f,{key:1,"record-id":a.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:a.content,reasoning:a.reasoning,loading:a.loading,avatar:he.value.robot.icons?he.value.robot.icons:he.value.robot.image,index:t,chatType:2,showCopyBtn:!1,images:a.images,files:a.files,videos:a.videos},{sub_actions:r((()=>[0!==t||De.value?x("v-if",!0):(o(),i(s,{key:0,class:"flex flex-col",style:{"margin-left":"84rpx"}},{default:r((()=>[(o(!0),g(C,null,z($e.value.length?$e.value:a.correlation,((e,a)=>(o(),i(s,{key:a,class:"inline-flex items-center rounded-md bg-white cursor-pointer mt-[20rpx]",style:{padding:"16rpx 24rpx",width:"fit-content"},onClick:R((a=>u(Ae)(e)),["stop"])},{default:r((()=>[n(y,{class:"mr-1 text-base text-content"},{default:r((()=>[_(b(e),1)])),_:2},1024),n(h,{name:"arrow-rightward",color:"#999",size:"30"})])),_:2},1032,["onClick"])))),128))])),_:2},1024))])),_:2},1032,["record-id","content","reasoning","loading","avatar","index","images","files","videos"])):x("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"]),De.value?(o(),i(s,{key:0,class:"flex justify-center items-center"},{default:r((()=>[n(F,{color:"#fff",shape:"circle",size:"medium",onClick:Ee},{default:r((()=>[n(h,{class:"mr-[10rpx]",name:"pause-circle",size:30}),_(" 停止 ")])),_:1})])),_:1})):x("v-if",!0),n(s,{class:"flex flex-col justify-center items-center text-white mt-[20rpx] text-xs"},{default:r((()=>[n(s,null,{default:r((()=>[_(b(Ce[je.value]),1)])),_:1})])),_:1}),n(s,{class:"my-[20rpx]"},{default:r((()=>[n(D,{class:"w-full whitespace-nowrap","scroll-x":""},{default:r((()=>[(o(!0),g(C,null,z(u(_e),((e,a)=>(o(),i(s,{class:"menus bg-white px-[30rpx] rounded-full mr-[20rpx] py-[12rpx] inline-block",key:a,onClick:a=>u(Ae)(e.keyword)},{default:r((()=>[_(b(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),n(s,{class:"send-area__content safe-area-inset-bottom"},{default:r((()=>[n(s,{class:"flex-1 min-w-0 relative"},{default:r((()=>[n(I,{modelValue:we.value,"onUpdate:modelValue":a[1]||(a[1]=e=>we.value=e),placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",onFocus:Be},null,8,["modelValue"])])),_:1}),n(s,{class:"ml-[20rpx] mr-[-6rpx]"},{default:r((()=>[n(s,null,{default:r((()=>[n(F,{type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(je.value),onClick:a[2]||(a[2]=R((e=>u(Ae)(we.value)),["stop"]))},{default:r((()=>[n(l,{src:W,class:"w-[50rpx] h-[50rpx]"})])),_:1},8,["custom-style","disabled"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),n(s,{class:"gradient-button z-10",onClick:u(Ve)},{default:r((()=>[n(l,{src:Y,class:"w-[40rpx] h-[40rpx]"})])),_:1},8,["onClick"]),n(E,{size:120,xEdge:"10",yEdge:"100"},{default:r((()=>[n(s,{class:T(["recorder-btn",{"recorder-btn--stop":!u(ea)&&!u(ia)}]),onClick:ua},{default:r((()=>[Me.value?(o(),i($,{key:0,style:V({width:`${Ke.width}px`,height:`${Ke.height}px`}),width:Ke.width*Ke.scale,height:Ke.height*Ke.scale,"canvas-id":Ke.id},null,8,["style","width","height","canvas-id"])):x("v-if",!0),u(ea)&&!Me.value?(o(),i(h,{key:1,name:"mic",size:48})):u(ia)?(o(),i(h,{key:2,name:"pause-circle",size:60})):u(ea)?x("v-if",!0):(o(),i(h,{key:3,name:"mic-off",size:48}))])),_:1},8,["class"])])),_:1})]})),_:1},8,["style"])):(o(),i(s,{key:1,class:"h-screen w-screen flex flex-col items-center justify-center"},{default:r((()=>[n(ve,{text:"该智能体暂未配置形象",mode:"page"})])),_:1}))])),_:1}),n(ye,{show:de.value,"onUpdate:show":a[3]||(a[3]=e=>de.value=e),onConfirm:ke},null,8,["show"])],64)}}}),[["__scopeId","data-v-81da2ae0"]]);export{he as default};
